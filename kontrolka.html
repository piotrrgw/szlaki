<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrolka Szlak贸w - Raport Miesiczny</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script> 
    <script> 
        window.dataLayer = window.dataLayer || []; 
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date()); 
        gtag('config', 'G-W05T4L1HFD'); 
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        :root { --primary-color: #2c3e50; }
        body { background-color: #f8f9fa; color: #212529; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Styl dla wydruku - ukrywa interfejs, zostawia raport */
        @media print {
            .no-print { display: none !important; }
            #printHeader { display: block !important; }
            .card { border: none; shadow: none; }
            body { background-color: white; }
            .table-status-valid { background-color: white !important; color: black !important; }
            .table-status-expired { text-decoration: underline; font-weight: bold; }
        }

        #printHeader { display: none; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px; }
        .print-meta { display: flex; justify-content: space-between; margin-top: 10px; }
        
        .status-valid { color: #198754; font-weight: 500; }
        .status-expired { color: #dc3545; font-weight: 700; }
        .status-warning { color: #ffc107; font-weight: 600; }

        .footer-text { font-size: 0.8rem; color: #6c757d; }
    </style>
</head>
<body>

<div class="container mt-4 mb-5">
    
    <div id="printHeader">
        <h2 class="text-center text-uppercase fw-bold">Wykaz Znajomoci Szlak贸w</h2>
        <div class="print-meta px-4">
            <span>Imi i Nazwisko: ........................................................</span>
            <span>Miesic: ......................... Rok: .................</span>
        </div>
    </div>

    <header class="mb-4 text-center no-print">
        <h1 class="display-6 fw-bold text-secondary"><i class="bi bi-train-front-fill"></i> Kontrolka Szlak贸w</h1>
        <p class="lead text-muted">Zarzdzanie znajomoci szlak贸w kolejowych (Wa偶no: 12 miesicy)</p>
    </header>

    <div class="card shadow-sm mb-4 no-print">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-calendar-plus"></i> Rejestrator Przejazd贸w / Zapoznania
        </div>
        <div class="card-body">
            <form id="entryForm" class="row g-3">
                <div class="col-md-3">
                    <label for="inputDate" class="form-label">Data zdarzenia</label>
                    <input type="date" class="form-control" id="inputDate" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Rodzaj wpisu</label>
                    <div class="d-flex gap-3 mt-1">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="entryType" id="typeDrive" value="drive" checked onchange="toggleInputMode()">
                            <label class="form-check-label" for="typeDrive">Prowadzenie</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="entryType" id="typeLearn" value="learn" onchange="toggleInputMode()">
                            <label class="form-check-label" for="typeLearn">Zapoznanie</label>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div id="trainInputGroup">
                        <label for="inputTrainNumber" class="form-label">Numer pocigu</label>
                        <input class="form-control" list="trainsList" id="inputTrainNumber" placeholder="Wpisz numer (np. 1000)">
                        <datalist id="trainsList"></datalist>
                        <div class="form-text">Zaktualizuje wszystkie odcinki na trasie pocigu.</div>
                    </div>

                    <div id="segmentInputGroup" class="d-none">
                        <label for="selectSegment" class="form-label">Wybierz konkretny odcinek</label>
                        <select class="form-select" id="selectSegment">
                            <option value="" selected disabled>Wybierz szlak...</option>
                        </select>
                        <div class="form-text">Zaktualizuje tylko ten jeden odcinek.</div>
                    </div>
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100"><i class="bi bi-save"></i> Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0" id="szlakiTable">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col" style="width: 5%">ID</th>
                            <th scope="col" style="width: 40%">Relacja (Odcinek)</th>
                            <th scope="col" style="width: 20%">Przez (Via)</th>
                            <th scope="col" style="width: 15%">Ostatni Przejazd</th>
                            <th scope="col" style="width: 15%">Wa偶ne do</th>
                            <th scope="col" style="width: 5%">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3 no-print">
        <small class="text-muted" id="actionLog"></small>
    </div>

</div>

<footer class="bg-light text-center py-3 mt-auto border-top">
    <div class="container footer-text">
        <p class="mb-1">&copy; 2025 Aplikacja Kolejowa. Wsp贸autorzy: Gemini & Piotr M </p>
        <p class="mb-0">Wersja aplikacji: v1.1</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Konfiguracja
    const VALIDITY_MONTHS = 12;
    let masterSzlaki = [];
    let trainsDb = [];
    let savedData = JSON.parse(localStorage.getItem('szlaki_data')) || {};

    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', async () => {
        // Ustaw domyln dat na dzisiaj
        document.getElementById('inputDate').valueAsDate = new Date();

        try {
            await loadData();
            populateDatalists();
            renderTable();
        } catch (error) {
            console.error("Bd adowania danych:", error);
            document.getElementById('actionLog').innerText = "Bd: Nie udao si zaadowa plik贸w danych (JSON).";
        }

        // Obsuga formularza
        document.getElementById('entryForm').addEventListener('submit', handleFormSubmit);
    });

    // adowanie plik贸w JSON
    async function loadData() {
        const [szlakiRes, trainsRes] = await Promise.all([
            fetch('szlaki_master.json'),
            fetch('trains.json')
        ]);
        
        masterSzlaki = await szlakiRes.json();
        trainsDb = await trainsRes.json();
    }

    // Wypenianie list rozwijanych
    function populateDatalists() {
        // Lista pocig贸w
        const trainsList = document.getElementById('trainsList');
        trainsList.innerHTML = '';
        trainsDb.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.number;
            opt.label = `${t.category} ${t.name || ''} (${t.route?.start} - ${t.route?.end})`;
            trainsList.appendChild(opt);
        });

        // Lista odcink贸w (dla trybu rcznego)
        const segSelect = document.getElementById('selectSegment');
        masterSzlaki.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.text = `[${s.id}] ${s.start} - ${s.end} ${s.via !== '-' ? '(p. ' + s.via + ')' : ''}`;
            segSelect.appendChild(opt);
        });
    }

    // Przeczanie widoku formularza (Pocig vs Odcinek)
    function toggleInputMode() {
        const isDrive = document.getElementById('typeDrive').checked;
        const trainGroup = document.getElementById('trainInputGroup');
        const segmentGroup = document.getElementById('segmentInputGroup');
        const trainInput = document.getElementById('inputTrainNumber');
        const segmentSelect = document.getElementById('selectSegment');

        if (isDrive) {
            trainGroup.classList.remove('d-none');
            segmentGroup.classList.add('d-none');
            trainInput.required = true;
            segmentSelect.required = false;
        } else {
            // W trybie "Zapoznanie" pozwalamy wybra: albo pocig (caa trasa), albo konkretny odcinek.
            // Dla uproszczenia w UI, zostawiem wyb贸r rczny, ale mo偶na te偶 zostawi pocig.
            // Tutaj logika: Zapoznanie czsto dotyczy konkretnego fragmentu, wic pokazujemy list odcink贸w.
            // Ale jeli u偶ytkownik chce zapoznanie "na pocigu", m贸gby u偶y opcji pocig.
            // Rozbudujmy UI dynamicznie:
            // Aby nie komplikowa: Zapoznanie = Wybierz Odcinek (bardziej precyzyjne).
            trainGroup.classList.add('d-none');
            segmentGroup.classList.remove('d-none');
            trainInput.required = false;
            segmentSelect.required = true;
            trainInput.value = ''; // czy
        }
    }
    
    // Nale偶y wywoa to globalnie, bo onclick w HTML szuka w window
    window.toggleInputMode = toggleInputMode;

    // G贸wna funkcja przetwarzania formularza
    function handleFormSubmit(e) {
        e.preventDefault();
        const dateInput = document.getElementById('inputDate').value;
        const isDrive = document.getElementById('typeDrive').checked;
        
        let updatedCount = 0;
        let logMsg = "";

        if (isDrive) {
            // Logika dla Pocigu
            const trainNum = document.getElementById('inputTrainNumber').value;
            const train = trainsDb.find(t => t.number === trainNum);
            
            if (!train) {
                alert("Nie znaleziono pocigu o takim numerze w bazie!");
                return;
            }

            if (!train.route || !train.route.segments) {
                alert("Ten pocig nie ma zdefiniowanych odcink贸w trasy.");
                return;
            }

            // Iterujemy po segmentach pocigu i szukamy ich w masterSzlaki
            train.route.segments.forEach(seg => {
                const masterId = findMasterSegmentId(seg);
                if (masterId) {
                    if (updateDateIfNewer(masterId, dateInput)) {
                        updatedCount++;
                    }
                }
            });
            logMsg = `Zaktualizowano ${updatedCount} odcink贸w dla pocigu ${trainNum}.`;

        } else {
            // Logika dla Zapoznania (Konkretny odcinek)
            const segId = document.getElementById('selectSegment').value;
            if (updateDateIfNewer(segId, dateInput)) {
                updatedCount = 1;
                logMsg = `Zaktualizowano zapoznanie dla odcinka ID ${segId}.`;
            } else {
                logMsg = `Data nie zostaa zmieniona (istnieje nowsza lub ta sama).`;
            }
        }

        // Zapis i odwie偶enie
        localStorage.setItem('szlaki_data', JSON.stringify(savedData));
        renderTable();
        document.getElementById('actionLog').innerText = `${new Date().toLocaleTimeString()}: ${logMsg}`;
        
        // Reset formularza (opcjonalne)
        // e.target.reset(); 
        // document.getElementById('inputDate').valueAsDate = new Date();
    }

    // Funkcja pomocnicza: Znajd藕 ID odcinka w masterSzlaki na podstawie nazw stacji
    function findMasterSegmentId(routeSeg) {
        // routeSeg ma: from, to, via
        // master ma: start, end, via
        // Musimy sprawdzi oba kierunki: A->B i B->A
        
        const norm = (str) => str ? str.toLowerCase().trim() : '-';

        return masterSzlaki.find(m => {
            const mStart = norm(m.start);
            const mEnd = norm(m.end);
            const mVia = norm(m.via);
            
            const rFrom = norm(routeSeg.from);
            const rTo = norm(routeSeg.to);
            const rVia = norm(routeSeg.via); // W JSON pocig贸w 'via' mo偶e by list miast, w master zazwyczaj jedno.
            
            // Proste dopasowanie koc贸w
            const directMatch = (mStart === rFrom && mEnd === rTo);
            const reverseMatch = (mStart === rTo && mEnd === rFrom);

            // Sprawdzamy czy punkty kracowe pasuj. 
            // Ignorujemy 'via' przy cisym dopasowaniu jeli jest trudne do parsowania, 
            // ale dla precyzji w przyszoci mo偶na doda sprawdzanie via.
            // W tym systemie ID s unikalne dla geometrii, wic krace zazwyczaj wystarcz.
            
            return directMatch || reverseMatch;
        })?.id;
    }

    // Funkcja aktualizujca dat
    function updateDateIfNewer(id, newDateStr) {
        const currentStr = savedData[id];
        const newDate = new Date(newDateStr);
        
        if (!currentStr) {
            savedData[id] = newDateStr;
            return true;
        }

        const currentDate = new Date(currentStr);
        if (newDate > currentDate) {
            savedData[id] = newDateStr;
            return true;
        }
        return false;
    }

    // Renderowanie tabeli
    function renderTable() {
        const tbody = document.querySelector('#szlakiTable tbody');
        tbody.innerHTML = '';

        masterSzlaki.forEach(szlak => {
            const lastDateStr = savedData[szlak.id];
            let statusHtml = '<span class="badge bg-secondary">Brak danych</span>';
            let validUntilStr = '-';
            let rowClass = '';

            if (lastDateStr) {
                const lastDate = new Date(lastDateStr);
                
                // Oblicz dat wa偶noci (rok p贸藕niej)
                const validUntil = new Date(lastDate);
                validUntil.setFullYear(validUntil.getFullYear() + 1);
                validUntilStr = validUntil.toISOString().split('T')[0];

                const today = new Date();
                
                // Reset godziny do p贸nocy dla por贸wnania
                today.setHours(0,0,0,0);
                validUntil.setHours(0,0,0,0);

                if (today <= validUntil) {
                    statusHtml = '<span class="badge bg-success">Wa偶ny</span>';
                } else {
                    statusHtml = '<span class="badge bg-danger">Niewa偶ny</span>';
                    rowClass = 'table-danger fw-bold'; // Bootstrap style dla wiersza
                }
            }

            const tr = document.createElement('tr');
            if(rowClass) tr.className = rowClass;
            
            tr.innerHTML = `
                <td>${szlak.id}</td>
                <td>${szlak.start} - ${szlak.end}</td>
                <td>${szlak.via}</td>
                <td>${lastDateStr || '-'}</td>
                <td>${validUntilStr}</td>
                <td>${statusHtml}</td>
            `;
            tbody.appendChild(tr);
        });
    }

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Karta Znajomo≈õci Szlak√≥w v2.7</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script> 
    <script> 
        window.dataLayer = window.dataLayer || []; 
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date()); 
        gtag('config', 'G-W05T4L1HFD'); 
    </script>

    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        /* UI GLOBAL */
        .disclaimer-bar { background: #fffbeb; color: #92400e; padding: 8px; text-align: center; font-weight: 600; font-size: 0.8rem; border-bottom: 1px solid #fcd34d; flex-shrink: 0; }
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .help-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .help-btn:hover { background: #eff6ff; }

        /* LAYOUT */
        .app-container { display: grid; grid-template-columns: 360px 1fr; flex: 1; overflow: hidden; }
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 15px; gap: 15px; }
        .content-area { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; background: #f8fafc; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px 0; font-size: 0.95rem; font-weight: 600; color: var(--text); }

        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--secondary); margin-bottom: 2px; }
        input[type="text"], select, input[type="date"] { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; }
        
        .btn-group { display: flex; flex-wrap: wrap; gap: 6px; }
        .btn { padding: 8px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 4px; color: white; flex: 1; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: black; }
        .btn-danger { background: var(--danger); }
        .btn-info { background: #0ea5e9; }

        /* CALENDAR */
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .month-label { font-weight: 700; font-size: 1rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--border); border: 1px solid var(--border); }
        .cal-head { background: #f1f5f9; text-align: center; font-size: 0.7rem; font-weight: 700; padding: 4px 0; color: var(--secondary); }
        .cal-day { background: white; min-height: 60px; padding: 2px; cursor: pointer; position: relative; display: flex; flex-direction: column; gap: 2px; width: 100%; min-width: 0; }
        .cal-day:hover { background: #eff6ff; }
        .day-num { font-size: 0.75rem; font-weight: 600; color: var(--secondary); align-self: flex-end; margin-right: 2px; }
        .badge { font-size: 0.65rem; padding: 2px 4px; border-radius: 3px; color: white; word-break: break-word; line-height: 1.1; }
        .bg-train { background: var(--primary); }
        .bg-manual { background: #8b5cf6; } /* Purple for manual entries */
        .bg-shift { background: var(--warning); color: black; border: 1px solid #d97706; }
        .bg-night { background: #1e293b; color: #fcd34d; border: 1px solid #0f172a; font-weight: bold; }

        /* TABLE */
        .table-wrapper { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; flex: 1; }
        .table-scroll { overflow: auto; flex: 1; }
        table.data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        table.data-table th { background: #f8fafc; padding: 10px; text-align: left; font-weight: 600; color: var(--secondary); border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 5; }
        table.data-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); color: var(--text); }
        .col-lp { width: 40px; text-align: center; }
        .col-date { width: 130px; text-align: center; font-family: monospace; font-weight: 600; white-space: nowrap; }
        
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; border:1px solid rgba(0,0,0,0.1); }
        .dot-green { background: var(--success); }
        .dot-yellow { background: var(--warning); }
        .dot-red { background: var(--danger); }
        
        /* VARIANT SELECTOR */
        #variantSelector { 
            display: none; background: #fff7ed; border: 1px solid #fdba74; 
            padding: 10px; border-radius: 6px; margin-top: 10px; 
        }
        .variant-btn {
            display: block; width: 100%; text-align: left; padding: 8px; margin-top: 5px;
            background: white; border: 1px solid #fed7aa; border-radius: 4px; cursor: pointer; font-size: 0.85rem;
        }
        .variant-btn:hover { background: #ffedd5; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }

        .app-footer {
            margin-top: auto;
            padding: 10px;
            text-align: center;
            font-size: 0.75rem;
            color: var(--secondary);
            border-top: 1px solid var(--border);
            background: #fff;
        }

        @media (max-width: 900px) {
            .app-container { display: block; overflow: auto; height: auto; }
            .sidebar { border-right: none; border-bottom: 1px solid var(--border); }
            .table-wrapper { overflow-x: auto; } table.data-table { min-width: 600px; }
        }

        @media print {
            @page { size: A4; margin: 1cm; }
            body { display: block; height: auto; background: white; font-size: 8pt; color: black; }
            .sidebar, header, .disclaimer-bar, .no-print, .btn, .help-btn, .app-footer { display: none !important; }
            .app-container { display: block; height: auto; overflow: visible; }
            .content-area { padding: 0; overflow: visible; background: white; }
            .table-wrapper { border: none; overflow: visible; }
            .table-scroll { overflow: visible; }
            .print-header { display: block !important; border-bottom: 2px solid black; margin-bottom: 10px; padding-bottom: 5px; }
            .print-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10pt; }
            .print-title { text-align: center; text-transform: uppercase; font-size: 14pt; font-weight: bold; margin: 5px 0; }
            table.data-table { font-size: 8pt; width: 100%; border-collapse: collapse; }
            table.data-table th, table.data-table td { border: 1px solid black; padding: 2px 4px; }
            thead { display: table-header-group; } tr { page-break-inside: avoid; }
            .print-footer { display: block !important; margin-top: 20px; text-align: right; font-size: 10pt; page-break-inside: avoid; }
        }
        .print-header, .print-footer { display: none; }
    </style>
</head>
<body>

<div class="disclaimer-bar">‚ö†Ô∏è Aplikacja pomocnicza. Kierownik PociƒÖgu weryfikuje dane.</div>

<header>
    <h1>üöÇ Karta Szlak√≥w <span style="font-size:0.7rem; background:var(--primary); color:white; padding:2px 5px; border-radius:4px; margin-left:5px;">v2.7 Manual</span></h1>
    <button class="help-btn" onclick="openModal('helpModal')">‚ùì Instrukcja</button>
</header>

<div class="app-container">
    <div class="sidebar">
        <div class="card">
            <h3>üë§ Profil Kierownika</h3>
            <div class="input-group"><label>Imiƒô i Nazwisko:</label><input type="text" id="userName" oninput="saveUserData()"></div>
            <div class="input-group"><label>Numer KP:</label><input type="text" id="userKP" oninput="saveUserData()"></div>
        </div>

        <div class="card">
            <div class="calendar-nav">
                <button class="btn btn-secondary" style="flex:0" onclick="changeMonth(-1)">‚óÄ</button>
                <span id="monthDisplay" class="month-label">Stycze≈Ñ 2026</span>
                <button class="btn btn-secondary" style="flex:0" onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="card">
            <h3>Narzƒôdzia</h3>
            <div class="btn-group">
                <input type="file" id="icsInput" accept=".ics" hidden onchange="handleIcs(this)">
                <button class="btn btn-warning" onclick="document.getElementById('icsInput').click()">üìÖ Import</button>
                <button class="btn btn-success" onclick="openCustomModal()">‚ûï PociƒÖg</button>
            </div>
            <button class="btn btn-info" style="width:100%; margin-top:8px;" onclick="openManualEntryModal()">‚úçÔ∏è Wprowad≈∫ przejazd rƒôcznie</button>
            
            <div class="btn-group" style="margin-top:8px;">
                <button class="btn btn-secondary" onclick="exportData()">üíæ Kopia</button>
                <input type="file" id="backupInput" accept=".json" hidden onchange="importData(this)">
                <button class="btn btn-secondary" onclick="document.getElementById('backupInput').click()">üìÇ Wczytaj</button>
                <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Reset</button>
            </div>
             <button class="btn btn-primary" style="width:100%; margin-top:8px;" onclick="window.print()">üñ®Ô∏è DRUKUJ</button>
        </div>
        
        <div id="fallback" style="display:none; color:red; font-size:0.8rem; text-align:center; padding:10px; border:1px dashed red;">
            Brak danych. Wgraj:<br>
            <input type="file" id="fTrain" accept=".json" style="margin:5px 0"><br>
            <input type="file" id="fMaster" accept=".json">
            <button onclick="manualLoad()" class="btn btn-primary" style="margin-top:5px;">Start</button>
        </div>
    </div>

    <div class="content-area">
        <div class="print-header">
            <div class="print-title">Wykaz znajomo≈õci szlak√≥w</div>
            <div class="print-row"><span id="printMonthInfo"></span><span></span></div>
            <div class="print-row"><span>Imiƒô: <strong id="printName"></strong></span><span>Nr KP: <strong id="printKP"></strong></span></div>
        </div>

        <div class="no-print" style="margin-bottom:15px;">
            <div style="background:white; padding:10px; border-radius:8px; border:1px solid var(--border); font-size:0.9rem; display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                <span>üü¢ <strong>Zielona:</strong> Wa≈ºny</span>
                <span>üü° <strong>≈ª√≥≈Çta:</strong> <30 dni</span>
                <span>üî¥ <strong>Czerwona:</strong> Brak/Wygas≈Ç</span>
            </div>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll">
                <table class="data-table" id="reportTable">
                    <thead>
                        <tr><th class="col-lp">LP</th><th>Odcinek (Od)</th><th>Odcinek (Do)</th><th>Przez</th><th class="col-date">Data</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="print-footer"><p>.......................................................<br>(Podpis pracownika)</p></div>
        
        <div class="app-footer no-print">
            Wersja aplikacji: v2.7 | Autorzy: Gemini & Piotr M üöÇ
        </div>
    </div>
</div>

<div class="modal-overlay" id="dayModal">
    <div class="modal">
        <h3>Edycja: <span id="modalDateTitle"></span></h3>
        <div id="dayTrainsList" style="margin-bottom:15px; display:flex; flex-direction:column; gap:5px;"></div>
        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        <label>Dodaj pociƒÖg (z listy):</label>
        <input type="text" id="trainFilter" placeholder="Szukaj numeru..." onkeyup="filterTrains()">
        <select id="trainSelect" size="5" style="height:100px; margin-bottom:10px" onchange="updateRoute()"></select>
        <div id="routeArea" style="display:none; background:#f8fafc; padding:10px; border-radius:6px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <div><small>Od:</small><select id="startSt"></select></div>
                <div><small>Do:</small><select id="endSt"></select></div>
            </div>
        </div>
        <div style="text-align:right; margin-top:15px; display:flex; gap:5px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('dayModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="addTrain()">Zapisz</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="manualEntryModal">
    <div class="modal">
        <h3>‚úçÔ∏è Wprowad≈∫ przejazd rƒôcznie</h3>
        <p style="font-size:0.85rem; color:var(--secondary);">
            U≈ºyj tej opcji, aby dodaƒá historyczny przejazd konkretnym odcinkiem do kalendarza.
        </p>
        
        <div class="input-group">
            <label>Data przejazdu:</label>
            <input type="date" id="manualDate">
        </div>

        <div class="input-group">
            <label>Szukaj odcinka (wpisz stacjƒô):</label>
            <input type="text" id="manualRouteSearch" placeholder="np. Warszawa" onkeyup="filterManualRoutes()">
        </div>

        <div class="input-group">
            <label>Wybierz odcinek:</label>
            <select id="manualRouteSelect" size="8" style="height:150px; width:100%;"></select>
        </div>

        <div style="text-align:right; margin-top:15px; display:flex; gap:5px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('manualEntryModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="saveManualEntry()">Zapisz w kalendarzu</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="customModal">
    <div class="modal">
        <h3>Kreator PociƒÖgu</h3>
        <p style="font-size:0.8rem; color:var(--secondary); margin-bottom:10px;">
            Buduj trasƒô stacja po stacji (A‚ûîB‚ûîC).
        </p>
        
        <label style="font-size:0.85rem; font-weight:600;">Numer pociƒÖgu:</label>
        <input type="text" id="custNum" placeholder="np. 99999" style="margin-bottom:15px;">
        
        <div style="background:#f1f5f9; padding:10px; border-radius:6px; border:1px solid var(--border);">
            <label style="font-size:0.8rem; font-weight:bold;">Nastƒôpna stacja:</label>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <select id="custNextSt"></select>
                <button class="btn btn-success" id="btnAddSt" onclick="addCustSt()">Dodaj</button>
            </div>
            
            <div id="variantSelector">
                <strong style="font-size:0.85rem; color:#c2410c;">‚ö†Ô∏è Wybierz wariant trasy:</strong>
                <div id="variantOptions"></div>
            </div>
        </div>

        <ul id="custRoute" style="list-style:decimal; padding-left:25px; margin-top:10px; font-size:0.9rem; max-height:150px; overflow-y:auto;"></ul>
        
        <div style="text-align:right; margin-top:15px; display:flex; gap:5px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('customModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="saveCust()">Zapisz PociƒÖg</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="helpModal">
    <div class="modal" style="max-width:600px;">
        <h2>üìñ Instrukcja Obs≈Çugi</h2>
        <div style="font-size:0.9rem; line-height:1.6; max-height:70vh; overflow-y:auto; padding-right:10px;">
            <h4 style="margin:10px 0 5px; color:var(--primary);">1. Wprowadzanie rƒôczne (v2.7)</h4>
            <ul style="padding-left:20px; margin:0;">
                <li>Aby zaliczyƒá szlak bez numeru pociƒÖgu (np. historycznie), u≈ºyj przycisku <strong>"‚úçÔ∏è Wprowad≈∫ przejazd rƒôcznie"</strong> w menu Narzƒôdzia.</li>
                <li>Wybierz datƒô i odcinek z listy. System doda ten wpis do kalendarza jako "RƒòCZNY".</li>
            </ul>
            <h4 style="margin:10px 0 5px; color:var(--primary);">2. Kreator PociƒÖgu</h4>
            <ul style="padding-left:20px; margin:0;">
                <li>Je≈õli pociƒÖgu nie ma w bazie, stw√≥rz go samodzielnie, wybierajƒÖc kolejne stacje.</li>
            </ul>
            <h4 style="margin:10px 0 5px; color:var(--primary);">3. Raport i Kolory</h4>
            <ul style="padding-left:20px; margin:0;">
                <li>üü¢ <strong>Zielona:</strong> Wa≈ºny (przejazd < 11 msc).</li>
                <li>üü° <strong>≈ª√≥≈Çta:</strong> Termin mija (< 30 dni).</li>
                <li>üî¥ <strong>Czerwona:</strong> Uprawnienia niewa≈ºne/brak.</li>
            </ul>
        </div>
        <div style="text-align:right; margin-top:20px;"><button class="btn btn-primary" onclick="closeModal('helpModal')">Zamknij</button></div>
    </div>
</div>

<script>
    const DB_KEY = 'kierownik_v2_7_data'; // Version 2.7
    
    // Manual ID constant
    const MANUAL_TRAIN_ID = 'MANUAL';

    let appData = { schedule: {}, shifts: {}, customTrains: [], profile: { name: "", kp: "" } };
    let dbTrains = [], dbMaster = [];
    let currentDate = new Date();
    let selectedDateStr = null;
    let tempCustRoute = []; 
    let tempCustSegments = []; 
    let stationGraph = {}; 

    document.addEventListener('DOMContentLoaded', async () => {
        loadData(); await autoFetchFiles();
    });

    async function autoFetchFiles() {
        try {
            const [t, m] = await Promise.all([ fetch('./trains.json'), fetch('./szlaki_master.json') ]);
            if(!t.ok || !m.ok) throw new Error();
            dbTrains = await t.json();
            dbMaster = await m.json();
            buildGraph();
            startSystem();
        } catch(e) { document.getElementById('fallback').style.display = 'block'; }
    }

    function buildGraph() {
        stationGraph = {};
        dbMaster.forEach(m => {
            if(!stationGraph[m.start]) stationGraph[m.start] = [];
            if(!stationGraph[m.end]) stationGraph[m.end] = [];
            if(!stationGraph[m.start].includes(m.end)) stationGraph[m.start].push(m.end);
            if(!stationGraph[m.end].includes(m.start)) stationGraph[m.end].push(m.start);
        });
    }

    function manualLoad() {
        const f1 = document.getElementById('fTrain').files[0];
        const f2 = document.getElementById('fMaster').files[0];
        if(!f1 || !f2) return alert("Wybierz oba pliki!");
        const r1 = new FileReader(), r2 = new FileReader();
        let c=0; const check = ()=>{if(++c===2){document.getElementById('fallback').style.display='none'; buildGraph(); startSystem()}};
        r1.onload=e=>{dbTrains=JSON.parse(e.target.result);check()};
        r2.onload=e=>{dbMaster=JSON.parse(e.target.result);check()};
        r1.readAsText(f1); r2.readAsText(f2);
    }

    function startSystem() {
        // Ensure "Manual" train exists in memory
        if(!dbTrains.find(t => t.id === MANUAL_TRAIN_ID)) {
            dbTrains.push({ id: MANUAL_TRAIN_ID, number: 'RƒòCZNY', name: 'Wpis manualny', isCustom: true });
        }
        
        dbTrains = [...dbTrains, ...appData.customTrains];
        document.getElementById('userName').value = appData.profile.name || "";
        document.getElementById('userKP').value = appData.profile.kp || "";
        updatePrintHeader(); fillTrainSelect(); renderCalendar(); renderReport();
    }

    function saveUserData() {
        appData.profile.name = document.getElementById('userName').value;
        appData.profile.kp = document.getElementById('userKP').value;
        updatePrintHeader(); saveData();
    }
    function updatePrintHeader() {
        document.getElementById('printName').innerText = appData.profile.name;
        document.getElementById('printKP').innerText = appData.profile.kp;
    }

    // --- CALENDAR ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid'); grid.innerHTML='';
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        document.getElementById('monthDisplay').innerText = currentDate.toLocaleDateString('pl-PL',{month:'long',year:'numeric'});
        ["Pn","Wt","≈ör","Cz","Pt","Sb","Nd"].forEach(d=>{const x=document.createElement('div');x.className='cal-head';x.innerText=d;grid.appendChild(x)});
        const firstDay = new Date(y, m, 1).getDay() || 7;
        const daysInMonth = new Date(y, m+1, 0).getDate();
        for(let i=1; i<firstDay; i++) grid.appendChild(document.createElement('div'));
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div'); cell.className='cal-day';
            cell.onclick = () => openDayEdit(dateStr);
            cell.innerHTML = `<div class="day-num">${d}</div>`;
            
            if(appData.shifts[dateStr]) appData.shifts[dateStr].forEach(s => {
                const b=document.createElement('div'); b.className=`badge ${s.isOvernight?'bg-night':'bg-shift'}`;
                b.innerHTML=(s.isOvernight?'üåô ':'')+s.summary; if(s.timeInfo)b.title=s.timeInfo; cell.appendChild(b);
            });
            
            if(appData.schedule[dateStr]) {
                appData.schedule[dateStr].forEach(tr => {
                    const t = dbTrains.find(x=>x.id==tr.trainId);
                    const isManual = (tr.trainId === MANUAL_TRAIN_ID);
                    const b = document.createElement('div'); 
                    b.className = `badge ${isManual ? 'bg-manual' : 'bg-train'}`; 
                    b.innerText = isManual ? '‚úçÔ∏è Rƒôczny' : (t?t.number:'?'); 
                    cell.appendChild(b);
                });
            }
            grid.appendChild(cell);
        }
    }
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar(); renderReport();
        document.getElementById('printMonthInfo').innerText = `MiesiƒÖc: ${currentDate.toLocaleDateString('pl-PL',{month:'long',year:'numeric'})}`;
    }

    // --- REPORT LOGIC v2.7 (Unified) ---
    function renderReport() {
        const tbody = document.querySelector('#reportTable tbody'); tbody.innerHTML='';
        const viewY = currentDate.getFullYear();
        const viewM = currentDate.getMonth();
        const viewEnd = new Date(viewY, viewM+1, 0);

        const vGlobal = {}; 

        // Iterate through ALL schedule entries (both trains and manual entries)
        Object.keys(appData.schedule).forEach(dateStr => {
            const d = new Date(dateStr);
            if(d > viewEnd) return; // Future dates in relation to month view are ignored for "last valid", but here we check everything up to end of view
            
            appData.schedule[dateStr].forEach(entry => {
                if(entry.trainId === MANUAL_TRAIN_ID) {
                    // It's a manual entry: Directly match the route
                    matchRoute({ from: entry.from, to: entry.to, via: entry.via || '-' }, dateStr, vGlobal);
                } else {
                    // It's a real train: Follow its route
                    const tr = dbTrains.find(t=>t.id==entry.trainId);
                    if(!tr) return;
                    let active=false;
                    if(tr.route && tr.route.segments) {
                        for(let seg of tr.route.segments) {
                            if(seg.from === entry.from) active=true;
                            if(active) matchRoute(seg, dateStr, vGlobal);
                            if(seg.to === entry.to) { active=false; break; }
                        }
                    }
                }
            });
        });

        dbMaster.forEach((m, idx) => {
            const tr = document.createElement('tr');
            const effectiveDate = vGlobal[m.id];
            
            let dot = 'dot-red'; 
            if(effectiveDate) {
                const ld = new Date(effectiveDate);
                const exp = new Date(ld); exp.setFullYear(ld.getFullYear() + 1); 
                const warn = new Date(exp); warn.setMonth(exp.getMonth() - 1); 
                if (exp < viewEnd) dot = 'dot-red'; else if (warn < viewEnd) dot = 'dot-yellow'; else dot = 'dot-green';
            }
            
            tr.innerHTML = `
                <td class="col-lp">${idx+1}</td>
                <td><span class="status-dot ${dot}"></span>${m.start}</td>
                <td>${m.end}</td>
                <td>${m.via==='-'?'':m.via}</td>
                <td class="col-date">${effectiveDate || ""}</td>`;
            tbody.appendChild(tr);
        });
    }

    function matchRoute(seg, dateStr, vG) {
        const norm = s => s ? s.toLowerCase().trim() : "";
        const f = norm(seg.from), t = norm(seg.to);
        const segVia = norm(seg.via);

        const match = dbMaster.find(m => {
            const mf = norm(m.start), mt = norm(m.end);
            const mVia = norm(m.via);
            const stationsMatch = (mf===f && mt===t) || (mf===t && mt===f);
            if(!stationsMatch) return false;
            
            // Handle Via
            if(mVia.length > 1 && mVia !== '-') {
                if(segVia.length > 1 && segVia !== '-') {
                    return segVia.includes(mVia) || mVia.includes(segVia);
                } else return false; 
            }
            return true; 
        });

        if(match) {
            if(!vG[match.id] || dateStr > vG[match.id]) vG[match.id]=dateStr;
        }
    }

    // --- MANUAL ENTRY MODAL LOGIC (New v2.7) ---
    function openManualEntryModal() {
        document.getElementById('manualDate').valueAsDate = new Date();
        document.getElementById('manualRouteSearch').value = '';
        renderManualRouteList('');
        openModal('manualEntryModal');
    }

    function filterManualRoutes() {
        const txt = document.getElementById('manualRouteSearch').value.toLowerCase();
        renderManualRouteList(txt);
    }

    function renderManualRouteList(filter) {
        const sel = document.getElementById('manualRouteSelect');
        sel.innerHTML = '';
        
        dbMaster.forEach((m, index) => {
            const text = `${m.start} - ${m.end} ${m.via !== '-' ? '(przez ' + m.via + ')' : ''}`;
            if(filter === '' || text.toLowerCase().includes(filter)) {
                const opt = new Option(text, index); // Value is index in dbMaster to easy retrieve
                sel.appendChild(opt);
            }
        });
    }

    function saveManualEntry() {
        const dateVal = document.getElementById('manualDate').value;
        const idx = document.getElementById('manualRouteSelect').value;

        if(!dateVal || idx === "") return alert("Wybierz datƒô i odcinek!");

        const m = dbMaster[idx];
        if(!m) return;

        if(!appData.schedule[dateVal]) appData.schedule[dateVal] = [];
        
        // Push special entry
        appData.schedule[dateVal].push({
            trainId: MANUAL_TRAIN_ID,
            from: m.start,
            to: m.end,
            via: m.via
        });

        saveData();
        renderCalendar();
        renderReport();
        closeModal('manualEntryModal');
        alert("Dodano wpis rƒôczny do kalendarza.");
    }

    // --- DAY EDIT (Existing) ---
    function openDayEdit(d) {
        selectedDateStr=d; document.getElementById('modalDateTitle').innerText=d; 
        document.getElementById('dayModal').style.display='flex';
        document.getElementById('trainFilter').value=''; filterTrains();
        document.getElementById('trainSelect').value=''; document.getElementById('routeArea').style.display='none';
        renderDayList();
    }
    function renderDayList() {
        const c = document.getElementById('dayTrainsList'); c.innerHTML='';
        const l = appData.schedule[selectedDateStr]||[];
        if(!l.length) c.innerHTML='<i style="color:#888;font-size:0.8rem">Brak wpis√≥w</i>';
        l.forEach((x,i)=>{
            const isManual = (x.trainId === MANUAL_TRAIN_ID);
            const t = dbTrains.find(z=>z.id==x.trainId);
            const d=document.createElement('div'); 
            d.style.cssText="display:flex;justify-content:space-between;background:#f1f5f9;padding:5px;border-radius:4px;font-size:0.85rem;align-items:center;";
            
            let label = "";
            if(isManual) {
                label = `‚úçÔ∏è <b>RƒòCZNY</b> ${x.from}-${x.to} <span style='font-size:0.75rem;color:gray;'>(${x.via||'-'})</span>`;
            } else {
                label = `<b>${t?t.number:'?'}</b> ${x.from}-${x.to}`;
            }

            d.innerHTML=`<span>${label}</span>`;
            const b=document.createElement('button'); b.className='btn btn-danger'; b.innerText='X';
            b.onclick=()=>{ appData.schedule[selectedDateStr].splice(i,1); if(!appData.schedule[selectedDateStr].length) delete appData.schedule[selectedDateStr]; saveData(); renderDayList(); renderCalendar(); renderReport(); };
            d.appendChild(b); c.appendChild(d);
        });
    }
    function fillTrainSelect() {
        const s = document.getElementById('trainSelect'); s.innerHTML='';
        dbTrains.sort((a,b)=>a.number.localeCompare(b.number));
        dbTrains.forEach(t=>{ const o=new Option(`${t.number} ${t.name||''} ${t.isCustom?'(W≈Çasny)':''}`,t.id); o.dataset.s=`${t.number} ${t.name||''}`.toLowerCase(); s.appendChild(o); });
    }
    function filterTrains() {
        const v = document.getElementById('trainFilter').value.toLowerCase();
        [...document.getElementById('trainSelect').options].forEach(o=>o.style.display=o.dataset.s.includes(v)?'':'none');
    }
    function updateRoute() {
        const tid=document.getElementById('trainSelect').value; const area=document.getElementById('routeArea');
        if(!tid){area.style.display='none';return}
        const t=dbTrains.find(x=>x.id==tid); if(!t||!t.route)return;
        area.style.display='block';
        const s1=document.getElementById('startSt'), s2=document.getElementById('endSt');
        s1.innerHTML='';s2.innerHTML='';
        const stops=[]; if(t.route.start) stops.push(t.route.start);
        t.route.segments.forEach(seg=>{if(stops[stops.length-1]!==seg.from)stops.push(seg.from);stops.push(seg.to)});
        stops.forEach(x=>{s1.appendChild(new Option(x));s2.appendChild(new Option(x))});
        if(stops.length>1)s2.selectedIndex=stops.length-1;
    }
    function addTrain() {
        const tid=document.getElementById('trainSelect').value, f=document.getElementById('startSt').value, t=document.getElementById('endSt').value;
        if(!tid||!f||!t)return;
        if(!appData.schedule[selectedDateStr]) appData.schedule[selectedDateStr]=[];
        appData.schedule[selectedDateStr].push({trainId:tid,from:f,to:t});
        saveData(); renderDayList(); renderCalendar(); renderReport();
    }

    // --- SMART CUSTOM TRAIN + VARIANTS ---
    function openCustomModal() {
        tempCustRoute=[]; tempCustSegments=[]; 
        document.getElementById('custNum').value='';
        document.getElementById('variantSelector').style.display='none';
        renderCustNextSelect(); renderCustRoute(); document.getElementById('customModal').style.display='flex';
    }

    function renderCustNextSelect() {
        const sel = document.getElementById('custNextSt'); sel.innerHTML='';
        let options = [];
        if(tempCustRoute.length === 0) options = Object.keys(stationGraph).sort();
        else {
            const last = tempCustRoute[tempCustRoute.length-1];
            options = (stationGraph[last] || []).sort();
        }
        if(options.length === 0 && tempCustRoute.length > 0) {
            const opt = new Option("Koniec trasy", ""); opt.disabled=true; sel.appendChild(opt);
            document.getElementById('btnAddSt').disabled=true;
        } else {
            options.forEach(s => sel.appendChild(new Option(s)));
            document.getElementById('btnAddSt').disabled=false;
        }
    }

    function addCustSt() {
        const vDiv = document.getElementById('variantSelector');
        vDiv.style.display = 'none';
        const nextSt = document.getElementById('custNextSt').value;
        if(!nextSt) return;

        if(tempCustRoute.length === 0) {
            tempCustRoute.push(nextSt);
            renderCustRoute();
            renderCustNextSelect();
            return;
        }

        const lastSt = tempCustRoute[tempCustRoute.length-1];
        const possibleRoutes = dbMaster.filter(m => {
            const mf = m.start, mt = m.end;
            return (mf===lastSt && mt===nextSt) || (mf===nextSt && mt===lastSt);
        });

        if(possibleRoutes.length > 1) {
            vDiv.style.display = 'block';
            const vOpts = document.getElementById('variantOptions'); vOpts.innerHTML = '';
            possibleRoutes.forEach(r => {
                const btn = document.createElement('div');
                btn.className = 'variant-btn';
                btn.innerHTML = `<strong>Przez: ${r.via}</strong> <br><small>(${r.start} - ${r.end})</small>`;
                btn.onclick = () => confirmVariant(nextSt, r.via);
                vOpts.appendChild(btn);
            });
            document.getElementById('btnAddSt').disabled = true;

        } else {
            let viaVal = '-';
            if(possibleRoutes.length === 1) viaVal = possibleRoutes[0].via;
            confirmVariant(nextSt, viaVal);
        }
    }

    function confirmVariant(nextSt, viaVal) {
        document.getElementById('variantSelector').style.display = 'none';
        document.getElementById('btnAddSt').disabled = false;
        const lastSt = tempCustRoute[tempCustRoute.length-1];
        tempCustRoute.push(nextSt);
        tempCustSegments.push({ from: lastSt, to: nextSt, via: viaVal });
        renderCustRoute();
        renderCustNextSelect();
    }

    function renderCustRoute() {
        const ul = document.getElementById('custRoute');
        if(tempCustRoute.length===0) ul.innerHTML='<li style="color:gray; list-style:none;">Start...</li>';
        else {
            ul.innerHTML = tempCustRoute.map((s,i) => {
                let extra = '';
                if(i > 0) {
                    const seg = tempCustSegments[i-1];
                    if(seg && seg.via !== '-') extra = ` <small style="color:#f59e0b">(przez ${seg.via})</small>`;
                }
                return `<li>${s}${extra} ${i===tempCustRoute.length-1 && i>0 ? `<span style="color:red;cursor:pointer;font-weight:bold;margin-left:5px;" onclick="undoCustSt()">[Cofnij]</span>` : ''}</li>`;
            }).join('');
        }
    }

    function undoCustSt() {
        if(tempCustRoute.length > 0) {
            tempCustRoute.pop();
            if(tempCustSegments.length > 0) tempCustSegments.pop();
            document.getElementById('variantSelector').style.display='none';
            document.getElementById('btnAddSt').disabled = false;
            renderCustRoute();
            renderCustNextSelect();
        }
    }

    function saveCust() {
        const n=document.getElementById('custNum').value;
        if(tempCustRoute.length<2||!n) return alert('Wymagany numer i min. 2 stacje');
        const obj={
            id:'c'+Date.now(), 
            number:n, 
            isCustom:true, 
            route:{ start:tempCustRoute[0], segments:tempCustSegments }
        };
        appData.customTrains.push(obj); dbTrains.push(obj);
        fillTrainSelect(); saveData(); closeModal('customModal');
    }

    // --- IO ---
    function loadData() {
        let r = localStorage.getItem(DB_KEY);
        if(!r) {
            // Migration check
            const olds = ['kierownik_v2_6_data', 'kierownik_v2_5_data', 'kierownik_v2_4_data', 'kierownik_v2_3_data'];
            for(let k of olds) { let x=localStorage.getItem(k); if(x){r=x; localStorage.setItem(DB_KEY, r); break;} }
        }
        if(r) {
            try {
                const d=JSON.parse(r);
                if(d.schedule) appData.schedule=d.schedule;
                if(d.shifts) appData.shifts=d.shifts;
                if(d.customTrains) appData.customTrains=d.customTrains;
                if(d.profile) appData.profile=d.profile;
            } catch(e){}
        }
    }
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); }
    function exportData() {
        const b=new Blob([JSON.stringify(appData)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
    }
    function importData(inp) {
        const f=inp.files[0]; if(!f)return;
        const r=new FileReader(); r.onload=e=>{
            try {
                const d=JSON.parse(e.target.result);
                if(d.schedule) Object.assign(appData.schedule, d.schedule);
                if(d.shifts) Object.assign(appData.shifts, d.shifts);
                if(d.profile) appData.profile = d.profile;
                if(d.customTrains) d.customTrains.forEach(ct=>{if(!appData.customTrains.find(x=>x.id==ct.id)){appData.customTrains.push(ct);dbTrains.push(ct)}});
                startSystem(); saveData(); alert('Wczytano');
            } catch(err){alert('B≈ÇƒÖd pliku')}
        }; r.readAsText(f); inp.value='';
    }
    function handleIcs(inp) {
        const f=inp.files[0]; if(!f)return;
        const r=new FileReader(); r.onload=e=>{
            const lines=e.target.result.split(/\r\n|\n/); let evt=null;
            lines.forEach(l=>{
                if(l.startsWith('BEGIN:VEVENT')) evt={};
                else if(l.startsWith('END:VEVENT')) {
                    if(evt&&evt.s&&evt.d) {
                        const d=evt.d.slice(0,4)+'-'+evt.d.slice(4,6)+'-'+evt.d.slice(6,8);
                        if(!appData.shifts[d]) appData.shifts[d]=[];
                        if(!appData.shifts[d].find(x=>x.summary==evt.s)) appData.shifts[d].push({summary:evt.s, isOvernight:false});
                    } evt=null;
                } else if(evt) {
                    if(l.startsWith('SUMMARY:')) evt.s=l.substring(8);
                    if(l.startsWith('DTSTART')) evt.d=l.split(':')[1].split('T')[0];
                }
            });
            saveData(); renderCalendar(); alert('Grafik OK');
        }; r.readAsText(f); inp.value='';
    }
    function clearData() { if(confirm('Reset?')) { localStorage.removeItem(DB_KEY); location.reload(); } }
    function closeModal(id){document.getElementById(id).style.display='none'}
    function openModal(id){document.getElementById(id).style.display='flex'}
    window.onclick=e=>{if(e.target.className==='modal-overlay')e.target.style.display='none'}
</script>
</body>
</html>
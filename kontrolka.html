<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Karta Znajomo≈õci Szlak√≥w v3.9</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script> 
    <script> 
        window.dataLayer = window.dataLayer || []; 
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date()); 
        gtag('config', 'G-W05T4L1HFD'); 
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --empty-dot: #cbd5e1;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        /* UI GLOBAL */
        .disclaimer-bar { background: #fffbeb; color: #92400e; padding: 8px; text-align: center; font-weight: 600; font-size: 0.8rem; border-bottom: 1px solid #fcd34d; flex-shrink: 0; }
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .help-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .help-btn:hover { background: #eff6ff; }

        /* LAYOUT */
        .app-container { display: grid; grid-template-columns: 360px 1fr; flex: 1; overflow: hidden; }
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 15px; gap: 15px; }
        .content-area { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; background: #f8fafc; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px 0; font-size: 0.95rem; font-weight: 600; color: var(--text); }

        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--secondary); margin-bottom: 2px; }
        input[type="text"], select, input[type="date"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; }
        
        .btn-group { display: flex; flex-wrap: wrap; gap: 6px; }
        .btn { padding: 8px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 4px; color: white; flex: 1; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: black; }
        .btn-danger { background: var(--danger); }
        .btn-info { background: #0ea5e9; }

        /* CALENDAR */
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .month-label { font-weight: 700; font-size: 1rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--border); border: 1px solid var(--border); }
        .cal-head { background: #f1f5f9; text-align: center; font-size: 0.7rem; font-weight: 700; padding: 4px 0; color: var(--secondary); }
        .cal-day { background: white; min-height: 60px; padding: 2px; cursor: pointer; position: relative; display: flex; flex-direction: column; gap: 2px; width: 100%; min-width: 0; }
        .cal-day:hover { background: #eff6ff; }
        .day-num { font-size: 0.75rem; font-weight: 600; color: var(--secondary); align-self: flex-end; margin-right: 2px; }
        .badge { font-size: 0.65rem; padding: 2px 4px; border-radius: 3px; color: white; word-break: break-word; line-height: 1.1; }
        .bg-train { background: var(--primary); }
        .bg-manual { background: #8b5cf6; }
        .bg-shift { background: var(--warning); color: black; border: 1px solid #d97706; }
        .bg-night { background: #1e293b; color: #fcd34d; border: 1px solid #0f172a; font-weight: bold; }

        /* TABLE */
        .table-wrapper { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; flex: 1; }
        .table-scroll { overflow: auto; flex: 1; }
        table.data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        table.data-table th { background: #f8fafc; padding: 10px; text-align: left; font-weight: 600; color: var(--secondary); border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 5; }
        table.data-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); color: var(--text); vertical-align: middle; }
        
        .col-lp { width: 35px; text-align: center; }
        .col-status { width: 35px; text-align: center; }
        .col-date { width: 140px; text-align: left; font-family: monospace; font-weight: 600; white-space: nowrap; cursor: pointer; }
        .col-via { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--secondary); font-size: 0.9em; }

        .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }
        .dot-green { background: var(--success); }
        .dot-orange { background: var(--warning); }
        .dot-red { background: var(--danger); }
        .dot-empty { background: white; border: 1px solid var(--empty-dot); }

        /* VARIANT SELECTOR */
        #variantSelector { display: none; background: #fff7ed; border: 1px solid #fdba74; padding: 10px; border-radius: 6px; margin-top: 10px; }
        .variant-btn { display: block; width: 100%; text-align: left; padding: 8px; margin-top: 5px; background: white; border: 1px solid #fed7aa; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .variant-btn:hover { background: #ffedd5; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }

        /* HISTORY LIST */
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .history-item:last-child { border-bottom: none; }
        .hist-date { font-weight: bold; font-family: monospace; }
        .hist-info { color: var(--secondary); font-size: 0.8rem; }

        .app-footer { margin-top: auto; padding: 10px; text-align: center; font-size: 0.75rem; color: var(--secondary); border-top: 1px solid var(--border); background: #fff; }

        @media (max-width: 900px) {
            .app-container { display: block; overflow: auto; height: auto; }
            .sidebar { border-right: none; border-bottom: 1px solid var(--border); }
            .table-wrapper { overflow-x: auto; } table.data-table { min-width: 600px; }
        }
    </style>
</head>
<body>

<div class="disclaimer-bar">‚ö†Ô∏è Aplikacja pomocnicza. Kierownik PociƒÖgu zobowiƒÖzany jest do weryfikacji poprawno≈õci danych.</div>

<header>
    <h1>üöÇ Karta Szlak√≥w <span style="font-size:0.7rem; background:var(--primary); color:white; padding:2px 5px; border-radius:4px; margin-left:5px;">v3.9</span></h1>
    <button class="help-btn" onclick="openModal('helpModal')">‚ùì Instrukcja</button>
</header>

<div class="app-container">
    <div class="sidebar">
        <div class="card">
            <h3>üë§ Profil Kierownika</h3>
            <div class="input-group"><label>Imiƒô i Nazwisko:</label><input type="text" id="userName" oninput="saveUserData()"></div>
            <div class="input-group"><label>Numer KP:</label><input type="text" id="userKP" oninput="saveUserData()"></div>
        </div>

        <div class="card">
            <div class="calendar-nav">
                <button class="btn btn-secondary" style="flex:0" onclick="changeMonth(-1)">‚óÄ</button>
                <span id="monthDisplay" class="month-label">Stycze≈Ñ 2026</span>
                <button class="btn btn-secondary" style="flex:0" onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="card">
            <h3>Narzƒôdzia</h3>
            <div class="btn-group">
                <input type="file" id="icsInput" accept=".ics" hidden onchange="handleIcs(this)">
                <button class="btn btn-warning" onclick="document.getElementById('icsInput').click()">üìÖ Import</button>
                <button class="btn btn-success" onclick="openCustomModal()">‚ûï PociƒÖg</button>
            </div>
            <button class="btn btn-info" style="width:100%; margin-top:8px;" onclick="openManualEntryModal()">‚úçÔ∏è Wprowad≈∫ przejazd rƒôcznie</button>
            
            <div class="btn-group" style="margin-top:8px;">
                <button class="btn btn-secondary" onclick="exportData()">üíæ Kopia</button>
                <input type="file" id="backupInput" accept=".json" hidden onchange="importData(this)">
                <button class="btn btn-secondary" onclick="document.getElementById('backupInput').click()">üìÇ Wczytaj</button>
                <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Reset</button>
            </div>
             <button class="btn btn-primary" style="width:100%; margin-top:8px;" onclick="openReportModal()">üìÑ RAPORT PDF</button>
        </div>
        
        <div id="fallback" style="display:none; color:red; font-size:0.8rem; text-align:center; padding:10px; border:1px dashed red;">
            Brak danych. Wgraj:<br>
            <input type="file" id="fTrain" accept=".json" style="margin:5px 0"><br>
            <input type="file" id="fMaster" accept=".json">
            <button onclick="manualLoad()" class="btn btn-primary" style="margin-top:5px;">Start</button>
        </div>
    </div>

    <div class="content-area">
        <div class="no-print" style="margin-bottom:15px;">
            <div style="background:white; padding:10px; border-radius:8px; border:1px solid var(--border); font-size:0.85rem; display:flex; flex-direction:column; gap:8px;">
                <div style="font-weight:bold; border-bottom:1px solid #eee; padding-bottom:4px;">Wa≈ºno≈õƒá szlaku:</div>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-green"></span> Wa≈ºny    |</span>
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-orange"></span> Wygasa w ciƒÖgu miesiƒÖca    |</span>
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-red"></span> Niewa≈ºny </span>
                </div>
                <div style="font-weight:bold; border-bottom:1px solid #eee; padding-bottom:4px; margin-top:5px;">Stan edycji miesiƒÖca:</div>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-green"></span> Przejechany w edytowanym miesiƒÖcu    |</span>
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-empty"></span> Brak przejazdu w edytowanym miesiƒÖcu</span>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll">
                <table class="data-table" id="reportTable">
                    <thead>
                        <tr>
                            <th class="col-lp">LP</th>
                            <th class="col-status">Status</th>
                            <th>Odcinek (Od)</th>
                            <th>Odcinek (Do)</th>
                            <th class="col-via">Przez</th>
                            <th class="col-date">Ostatni przejazd</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div class="app-footer no-print">
            Wersja aplikacji: v3.9 | Autorzy: Gemini & Piotr M üöÇ
        </div>
    </div>
</div>

<div class="modal-overlay" id="helpModal">
    <div class="modal" style="max-width:650px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h2 style="margin:0; color:var(--primary);">üìñ Instrukcja Obs≈Çugi</h2>
            <button class="btn btn-secondary" onclick="closeModal('helpModal')">X</button>
        </div>
        
        <div style="font-size:0.95rem; line-height:1.6; padding-right:5px; overflow-y:auto; flex:1;">
            
            <p><strong>Szlaki Kolejowe v3.9</strong> to narzƒôdzie do ewidencji pracy i kontroli znajomo≈õci szlak√≥w.</p>

            <h4 style="margin:15px 0 5px; color:var(--primary); border-left:4px solid var(--primary); padding-left:8px;">1. Import Grafiku</h4>
            <div style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid var(--border);">
                Pobierz sw√≥j grafik w formacie <code>.ics</code> ze strony: <br>
                üëâ <a href="https://irena1.intercity.pl" target="_blank" style="color:var(--primary); font-weight:bold;">www.irena1.intercity.pl</a>
                <br><br>
                Nastƒôpnie w aplikacji kliknij przycisk <span class="btn btn-warning" style="padding:2px 6px; font-size:0.7em;">üìÖ Import</span> i wybierz pobrany plik.
            </div>

            <h4 style="margin:15px 0 5px; color:var(--primary); border-left:4px solid var(--primary); padding-left:8px;">2. Tabela i Oznaczenia</h4>
            <p>Tabela pokazuje wszystkie mo≈ºliwe szlaki. Posiada dwie strefy informacji:</p>
            <ul>
                <li>
                    <strong>LEWA STRONA (Kropka Statusu):</strong> Informuje, czy masz wa≈ºne uprawnienia na szlak.
                    <ul style="font-size:0.9em; margin-top:5px; color:#555;">
                        <li>üü¢ <strong>Zielona:</strong> Szlak wa≈ºny.</li>
                        <li>üü† <strong>Pomara≈Ñczowa:</strong> Ko≈Ñczy siƒô wa≈ºno≈õƒá.</li>
                        <li>üî¥ <strong>Czerwona:</strong> Szlak niewa≈ºny/wygas≈Ç.</li>
                    </ul>
                </li>
            </ul>

            <h4 style="margin:15px 0 5px; color:var(--primary); border-left:4px solid var(--primary); padding-left:8px;">3. Raport PDF</h4>
            <p>Kliknij "RAPORT PDF", aby wygenerowaƒá zestawienie:</p>
            <ul>
                <li><strong>Miesiƒôczne:</strong> Wa≈ºno≈õƒá szlak√≥w na ostatni dzie≈Ñ wybranego miesiƒÖca.</li>
                <li><strong>Roczne:</strong> Wa≈ºno≈õƒá szlak√≥w na 31 grudnia wybranego roku.</li>
            </ul>
        </div>
        <div style="text-align:right; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn btn-primary" onclick="closeModal('helpModal')">Rozumiem, zamknij</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="reportModal">
    <div class="modal" style="max-width:400px;">
        <h3>üìÑ Generuj Raport PDF</h3>
        <p style="color:var(--secondary); font-size:0.9rem;">Wybierz rodzaj zestawienia:</p>
        
        <div class="input-group">
            <label>Rodzaj raportu:</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <label style="font-size:0.9rem; color:var(--text); cursor:pointer;">
                    <input type="radio" name="reportType" value="monthly" checked onchange="toggleReportInputs()"> Miesiƒôczny
                </label>
                <label style="font-size:0.9rem; color:var(--text); cursor:pointer;">
                    <input type="radio" name="reportType" value="yearly" onchange="toggleReportInputs()"> Roczny
                </label>
            </div>
        </div>

        <div id="monthlyInputs">
            <div class="input-group">
                <label>MiesiƒÖc:</label>
                <select id="reportMonth">
                    <option value="0">Stycze≈Ñ</option><option value="1">Luty</option><option value="2">Marzec</option>
                    <option value="3">Kwiecie≈Ñ</option><option value="4">Maj</option><option value="5">Czerwiec</option>
                    <option value="6">Lipiec</option><option value="7">Sierpie≈Ñ</option><option value="8">Wrzesie≈Ñ</option>
                    <option value="9">Pa≈∫dziernik</option><option value="10">Listopad</option><option value="11">Grudzie≈Ñ</option>
                </select>
            </div>
        </div>

        <div class="input-group">
            <label>Rok:</label>
            <input type="number" id="reportYear" value="2026" min="2020" max="2030">
        </div>

        <div style="background:#fffbeb; padding:10px; border:1px solid #fcd34d; border-radius:4px; font-size:0.8rem; margin-top:10px;">
            üí° Raport wygeneruje status wa≈ºno≈õci szlak√≥w na koniec wybranego okresu.
        </div>

        <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn btn-secondary" onclick="closeModal('reportModal')">Anuluj</button>
            <button class="btn btn-primary" id="btnDownloadPdf" onclick="downloadPdf()">üì• Pobierz PDF</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="historyModal">
    <div class="modal">
        <h3>Historia: <span id="histTitle"></span></h3>
        <p style="font-size:0.8rem; color:var(--secondary); margin-bottom:10px;" id="histSubtitle"></p>
        <div style="flex:1; overflow-y:auto; border-top:1px solid #eee;">
            <ul id="historyList" class="history-list"></ul>
        </div>
        <div style="text-align:right; margin-top:15px;">
            <button class="btn btn-primary" onclick="closeModal('historyModal')">Zamknij</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="dayModal">
    <div class="modal">
        <h3>Edycja: <span id="modalDateTitle"></span></h3>
        <div id="dayTrainsList" style="margin-bottom:15px; display:flex; flex-direction:column; gap:5px;"></div>
        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        <label>Dodaj pociƒÖg (z listy):</label>
        <input type="text" id="trainFilter" placeholder="Szukaj numeru..." onkeyup="filterTrains()">
        <select id="trainSelect" size="5" style="height:100px; margin-bottom:10px" onchange="updateRoute()"></select>
        <div id="routeArea" style="display:none; background:#f8fafc; padding:10px; border-radius:6px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <div><small>Od:</small><select id="startSt"></select></div>
                <div><small>Do:</small><select id="endSt"></select></div>
            </div>
        </div>
        <div style="text-align:right; margin-top:15px; display:flex; gap:5px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('dayModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="addTrain()">Zapisz</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="manualEntryModal">
    <div class="modal">
        <h3>‚úçÔ∏è Wprowad≈∫ przejazd rƒôcznie</h3>
        <p style="font-size:0.85rem; color:var(--secondary);"> Dodaj historyczny przejazd do kalendarza. </p>
        <div class="input-group">
            <label>Data przejazdu:</label>
            <input type="date" id="manualDate">
        </div>
        <div class="input-group">
            <label>Szukaj odcinka (wpisz stacjƒô):</label>
            <input type="text" id="manualRouteSearch" onkeyup="filterManualRoutes()" placeholder="np. Warszawa">
        </div>
        <div class="input-group">
            <label>Wybierz odcinek:</label>
            <select id="manualRouteSelect" size="5" style="height:120px;"></select>
        </div>
        
        <div style="text-align:right; margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
             <button class="btn btn-secondary" onclick="closeModal('manualEntryModal')">Anuluj</button>
             <button class="btn btn-primary" onclick="saveManualEntry()">Zapisz</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="customTrainModal">
    <div class="modal">
        <h3>‚ûï Dodaj w≈Çasny pociƒÖg</h3>
        <p style="font-size:0.8rem; color:var(--secondary);">Je≈õli pociƒÖgu nie ma w bazie, dodaj go tutaj.</p>
        <div class="input-group"><label>Numer pociƒÖgu:</label><input type="text" id="customNumber" placeholder="np. 12345"></div>
        <div class="input-group"><label>Nazwa (opcjonalnie):</label><input type="text" id="customName" placeholder="np. Ha≈Ñcza"></div>
        
        <div style="border:1px solid #eee; padding:10px; border-radius:6px; margin:10px 0;">
            <small style="display:block; margin-bottom:5px; font-weight:bold;">Trasa (stacje po kolei):</small>
            <div id="customStops" style="display:flex; flex-direction:column; gap:5px; max-height:150px; overflow-y:auto;">
                <div style="display:flex; gap:5px;"><input type="text" placeholder="Stacja poczƒÖtkowa" class="cust-stop"></div>
                <div style="display:flex; gap:5px;"><input type="text" placeholder="Nastƒôpna stacja" class="cust-stop"></div>
            </div>
            <button class="btn btn-info" style="margin-top:5px; font-size:0.75rem; padding:4px;" onclick="addCustomStopInput()">+ Dodaj przystanek</button>
        </div>
         <div style="text-align:right; margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
             <button class="btn btn-secondary" onclick="closeModal('customTrainModal')">Anuluj</button>
             <button class="btn btn-success" onclick="saveCustomTrain()">Dodaj</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="variantModal">
    <div class="modal">
        <h3>üîÄ Wybierz wariant trasy</h3>
        <p style="font-size:0.9rem;">Miƒôdzy wybranymi stacjami istnieje kilka tras.</p>
        <div id="variantOptions"></div>
        <button class="btn btn-secondary" style="margin-top:15px;" onclick="closeModal('variantModal')">Anuluj</button>
    </div>
</div>

<script>
/*
   Wersja aplikacji: v3.9
   Autorzy: Gemini & Piotr M üöÇ
   Data aktualizacji: 2025-01-03
*/

// --- CONFIG ---
const MANUAL_TRAIN_ID = 'MANUAL';
const DB_KEY = 'kierownik_v3_data';

// --- STATE ---
let dbTrains = [];
let dbMaster = [];
let stationGraph = {}; 
let appData = {
    profile: { name: "", kp: "" },
    schedule: {}, // "YYYY-MM-DD": [ { trainId, from, to } ]
    shifts: {},
    customTrains: [] 
};
let currentDate = new Date();
let selectedDateStr = "";

// --- INIT ---
window.onload = async () => {
    loadData();
    renderManualRouteList('');
    
    // Auto load files if present in same dir (for production)
    try {
        const [r1, r2] = await Promise.all([
            fetch('trains.json').then(r=>r.json()),
            fetch('szlaki_master.json').then(r=>r.json())
        ]);
        dbTrains = r1;
        dbMaster = r2;
        // Assign UIDs
        dbMaster.forEach((item, index) => { item._uid = index; });
        
        buildGraph();
        startSystem();
    } catch(e) {
        document.getElementById('fallback').style.display = 'block';
    }
}

function buildGraph() {
    stationGraph = {};
    dbMaster.forEach(m => {
        if(!stationGraph[m.start]) stationGraph[m.start] = [];
        if(!stationGraph[m.end]) stationGraph[m.end] = [];
        if(!stationGraph[m.start].includes(m.end)) stationGraph[m.start].push(m.end);
        if(!stationGraph[m.end].includes(m.start)) stationGraph[m.end].push(m.start);
    });
}

function manualLoad() {
    const f1 = document.getElementById('fTrain').files[0];
    const f2 = document.getElementById('fMaster').files[0];
    if(!f1 || !f2) return alert("Wybierz oba pliki!");
    
    const r1 = new FileReader(), r2 = new FileReader();
    let c=0; 
    const check = ()=>{if(++c===2){document.getElementById('fallback').style.display='none'; buildGraph(); startSystem()}};
    
    r1.onload=e=>{dbTrains=JSON.parse(e.target.result);check()};
    r2.onload=e=>{
        dbMaster=JSON.parse(e.target.result);
        dbMaster.forEach((item, index) => { item._uid = index; });
        check();
    };
    r1.readAsText(f1);
    r2.readAsText(f2);
}

function startSystem() {
    if(!dbTrains.find(t => t.id === MANUAL_TRAIN_ID)) {
        dbTrains.push({ id: MANUAL_TRAIN_ID, number: 'RƒòCZNY', name: 'Wpis manualny', isCustom: true });
    }
    dbTrains = [...dbTrains, ...appData.customTrains];
    
    document.getElementById('userName').value = appData.profile.name || "";
    document.getElementById('userKP').value = appData.profile.kp || "";
    
    fillTrainSelect();
    renderCalendar();
    renderReport();
}

function saveUserData() {
    appData.profile.name = document.getElementById('userName').value;
    appData.profile.kp = document.getElementById('userKP').value;
    saveData();
}

// --- REPORT FUNCTIONS (PDF) ---

function openReportModal() {
    document.getElementById('reportYear').value = new Date().getFullYear();
    document.getElementById('reportMonth').value = currentDate.getMonth();
    toggleReportInputs();
    openModal('reportModal');
}

function toggleReportInputs() {
    const type = document.querySelector('input[name="reportType"]:checked').value;
    document.getElementById('monthlyInputs').style.display = (type === 'monthly') ? 'block' : 'none';
}

async function downloadPdf() {
    const { jsPDF } = window.jspdf;
    
    const btn = document.getElementById('btnDownloadPdf');
    const oldText = btn.innerText;
    btn.innerText = "‚è≥ Generowanie...";
    btn.disabled = true;

    try {
        const type = document.querySelector('input[name="reportType"]:checked').value;
        const year = parseInt(document.getElementById('reportYear').value);
        let startDate, limitDate, titleDate;

        if (type === 'monthly') {
            const month = parseInt(document.getElementById('reportMonth').value);
            startDate = new Date(year, month, 1);
            limitDate = new Date(year, month + 1, 0); 
            const monthName = limitDate.toLocaleDateString('pl-PL', { month: 'long' });
            titleDate = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;
        } else {
            startDate = new Date(year, 0, 1);
            limitDate = new Date(year, 11, 31);
            titleDate = `Rok ${year}`;
        }

        const doc = new jsPDF();
        
        // POBIERANIE CZCIONKI Z BARDZIEJ NIEZAWODNEGO ≈πR√ìD≈ÅA (CDNJS PDFMAKE)
        try {
            const fontUrl = 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf';
            const fontRes = await fetch(fontUrl);
            
            if(!fontRes.ok) throw new Error("B≈ÇƒÖd pobierania czcionki");
            
            const fontBuffer = await fontRes.arrayBuffer();
            const fontBase64 = arrayBufferToBase64(fontBuffer);
            
            doc.addFileToVFS("Roboto.ttf", fontBase64);
            doc.addFont("Roboto.ttf", "Roboto", "normal");
            doc.setFont("Roboto");
            
        } catch(e) { 
            console.error("Font error", e); 
            alert("‚ö†Ô∏è UWAGA: Nie uda≈Ço siƒô pobraƒá polskiej czcionki. Raport zostanie wygenerowany, ale polskie znaki mogƒÖ byƒá niepoprawne (krzaczki). Sprawd≈∫ po≈ÇƒÖczenie z internetem.");
        }
        
        doc.setFontSize(16);
        doc.text("KARTA ZNAJOMO≈öCI SZLAK√ìW", 105, 15, { align: 'center' });
        
        doc.setFontSize(11);
        doc.text(`Zestawienie: ${type === 'monthly' ? 'Miesiƒôczne' : 'Roczne'} - ${titleDate}`, 105, 22, { align: 'center' });
        
        doc.setFontSize(10);
        doc.text(`Pracownik: ${appData.profile.name || '...................'}`, 14, 30);
        doc.text(`Numer KP: ${appData.profile.kp || '......'}`, 150, 30);

        const tableBody = [];
        
        dbMaster.forEach((m, index) => {
            const lastDate = getLastDateForMasterUid(m._uid, limitDate); 
            
            let status = 'red';
            let dateStr = '-';
            
            if (lastDate) {
                dateStr = lastDate.toISOString().split('T')[0];
                const diffTime = Math.abs(limitDate - lastDate);
                const diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30.44); 
                
                if (diffMonths < 11) status = 'green';
                else if (diffMonths < 12) status = 'orange';
            }
            
            tableBody.push({
                lp: index + 1,
                status: status,
                from: m.start,
                to: m.end,
                via: m.via === '-' ? '' : m.via,
                last: dateStr
            });
        });

        doc.autoTable({
            startY: 35,
            head: [['LP', 'Status', 'Odcinek (Od)', 'Odcinek (Do)', 'Przez', 'Ostatni przejazd']],
            body: tableBody.map(r => [r.lp, '', r.from, r.to, r.via, r.last]),
            theme: 'grid',
            // Wymuszenie czcionki Roboto dla tabeli
            styles: { fontSize: 9, cellPadding: 2, font: "Roboto", fontStyle: 'normal' },
            columnStyles: {
                0: { cellWidth: 10, halign: 'center' },
                1: { cellWidth: 15, halign: 'center' },
                5: { cellWidth: 25, halign: 'center' }
            },
            didDrawCell: (data) => {
                if (data.section === 'body' && data.column.index === 1) {
                    const rowData = tableBody[data.row.index];
                    const colorMap = {
                        'green': [34, 197, 94],
                        'orange': [245, 158, 11],
                        'red': [239, 68, 68]
                    };
                    const color = colorMap[rowData.status];
                    
                    const dim = data.cell;
                    const r = 3;
                    const cx = dim.x + dim.width / 2;
                    const cy = dim.y + dim.height / 2;
                    
                    doc.setFillColor(color[0], color[1], color[2]);
                    doc.circle(cx, cy, r, 'F');
                }
            }
        });

        const finalY = doc.lastAutoTable.finalY + 20;
        doc.text(".............................................", 140, finalY);
        doc.text("(Podpis pracownika)", 155, finalY + 5);
        
        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text(`Wersja aplikacji: v3.9 | Wygenerowano: ${new Date().toLocaleDateString('pl-PL')}`, 105, 290, { align: 'center' });

        doc.save(`Raport_Szlakow_${type}_${year}.pdf`);
        closeModal('reportModal');

    } catch (e) {
        alert("B≈ÇƒÖd generowania PDF: " + e.message);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}


// --- CORE LOGIC ---

function getCoveredMasterUids(scheduleEntry) {
    if(scheduleEntry.trainId === MANUAL_TRAIN_ID) {
        const entryFrom = scheduleEntry.from;
        const entryTo = scheduleEntry.to;
        
        const candidates = dbMaster.filter(m => 
            (m.start === entryFrom && m.end === entryTo) || (m.start === entryTo && m.end === entryFrom)
        );
        
        if (candidates.length === 0) return [];
        if (candidates.length === 1) return [candidates[0]._uid];
        
        if(scheduleEntry.via && scheduleEntry.via !== '-') {
             const exact = candidates.find(m => m.via === scheduleEntry.via);
             if(exact) return [exact._uid];
        }
        return [candidates[0]._uid];
    }

    const t = dbTrains.find(x => x.id == scheduleEntry.trainId);
    if(!t) return [];
    
    let stops = [];
    if(t.route) {
         if(t.route.start) stops.push(t.route.start);
         t.route.segments.forEach(s => {
             if(stops[stops.length-1] !== s.from) stops.push(s.from);
             stops.push(s.to);
         });
    } else {
        return []; 
    }

    const sIdx = stops.indexOf(scheduleEntry.from);
    const eIdx = stops.indexOf(scheduleEntry.to);
    if(sIdx === -1 || eIdx === -1) return [];
    
    const journey = (sIdx < eIdx) 
        ? stops.slice(sIdx, eIdx + 1) 
        : stops.slice(eIdx, sIdx + 1).reverse();

    const uids = [];
    for(let i=0; i<journey.length-1; i++) {
        const a = journey[i], b = journey[i+1];
        const candidates = dbMaster.filter(m => 
            (m.start === a && m.end === b) || (m.start === b && m.end === a)
        );
        if(candidates.length > 0) uids.push(candidates[0]._uid);
    }
    return [...new Set(uids)];
}

function getLastDateForMasterUid(uid, limitDate = null) {
    let last = null;
    const sortedDates = Object.keys(appData.schedule).sort();
    
    for(const dateStr of sortedDates) {
        const d = new Date(dateStr);
        if(limitDate && d > limitDate) continue;

        appData.schedule[dateStr].forEach(entry => {
             const uids = getCoveredMasterUids(entry);
             if(uids.includes(uid)) {
                 if(!last || d > last) last = d;
             }
        });
    }
    return last;
}

// --- CALENDAR ---

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML='';
    const y = currentDate.getFullYear(), m = currentDate.getMonth();
    document.getElementById('monthDisplay').innerText = currentDate.toLocaleDateString('pl-PL',{month:'long',year:'numeric'});
    
    ["Pn","Wt","≈ör","Cz","Pt","Sb","Nd"].forEach(d=>{const x=document.createElement('div');x.className='cal-head';x.innerText=d;grid.appendChild(x)});
    
    const firstDay = new Date(y, m, 1).getDay() || 7;
    const daysInMonth = new Date(y, m+1, 0).getDate();
    
    for(let i=1; i<firstDay; i++) grid.appendChild(document.createElement('div'));
    
    for(let d=1; d<=daysInMonth; d++) {
        const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const cell = document.createElement('div');
        cell.className='cal-day';
        cell.onclick = () => openDayEdit(dateStr);
        cell.innerHTML = `<div class="day-num">${d}</div>`;
        
        if(appData.shifts[dateStr]) appData.shifts[dateStr].forEach(s => {
             const b=document.createElement('div');
             b.className=`badge ${s.isOvernight?'bg-night':'bg-shift'}`;
             b.innerHTML=(s.isOvernight?'üåô ':'')+s.summary;
             if(s.timeInfo)b.title=s.timeInfo;
             cell.appendChild(b);
        });
        
        if(appData.schedule[dateStr]) {
            appData.schedule[dateStr].forEach(tr => {
                const isManual = (tr.trainId === MANUAL_TRAIN_ID);
                const t = dbTrains.find(x=>x.id==tr.trainId);
                const b = document.createElement('div');
                b.className = `badge ${isManual ? 'bg-manual' : 'bg-train'}`;
                b.innerText = isManual ? '‚úçÔ∏è Rƒôczny' : (t?t.number:'?');
                cell.appendChild(b);
            });
        }
        grid.appendChild(cell);
    }
}

function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar();
    renderReport();
}

// --- REPORT RENDER (HTML) ---

function renderReport() {
    const tbody = document.querySelector('#reportTable tbody');
    tbody.innerHTML = '';
    
    const limitForStatus = new Date(); 
    const viewY = currentDate.getFullYear();
    const viewM = currentDate.getMonth();

    dbMaster.forEach((m, idx) => {
        const lastDate = getLastDateForMasterUid(m._uid, limitForStatus);
        
        let statusClass = 'dot-red';
        if(lastDate) {
            const diffMonths = (limitForStatus - lastDate) / (1000 * 60 * 60 * 24 * 30.44);
            if(diffMonths < 11) statusClass = 'dot-green';
            else if (diffMonths < 12) statusClass = 'dot-orange';
        }
        
        let monthlyDot = 'dot-empty';
        let monthlyDateStr = '';
        
        if(lastDate && lastDate.getFullYear() === viewY && lastDate.getMonth() === viewM) {
             monthlyDot = 'dot-green';
             monthlyDateStr = lastDate.toISOString().slice(0,10);
        } else if (lastDate) {
             monthlyDateStr = lastDate.toISOString().slice(0,10);
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="col-lp">${idx+1}</td>
            <td class="col-status"><span class="status-dot ${statusClass}"></span></td>
            <td>${m.start}</td>
            <td>${m.end}</td>
            <td class="col-via" title="${m.via}">${m.via}</td>
            <td class="col-date" onclick="openHistory(${m._uid})">
                <span style="display:flex; align-items:center; gap:8px;">
                     ${monthlyDateStr || '<span style="color:#cbd5e1">-</span>'}
                </span>
            </td>`;
        tbody.appendChild(tr);
    });
}

// --- HISTORY MODAL LOGIC ---
function openHistory(uid) {
    const m = dbMaster.find(x => x._uid === uid);
    if(!m) return alert('B≈ÇƒÖd: Nie znaleziono szlaku w bazie (UID mismatch).');
    
    const routeName = `${m.start} - ${m.end} ${m.via!=='-'?'('+m.via+')':''}`;
    document.getElementById('histTitle').innerText = "Historia przejazd√≥w";
    document.getElementById('histSubtitle').innerText = routeName;
    
    const ul = document.getElementById('historyList');
    ul.innerHTML = '';
    
    let history = [];
    const sortedDates = Object.keys(appData.schedule).sort();
    
    sortedDates.forEach(dateStr => {
        appData.schedule[dateStr].forEach(entry => {
            try {
                const uids = getCoveredMasterUids(entry);
                if(uids.includes(uid)) {
                    let info = '';
                    if(entry.trainId === MANUAL_TRAIN_ID) {
                        info = 'Wpis rƒôczny';
                    } else {
                        const tr = dbTrains.find(t=>t.id == entry.trainId);
                        info = tr ? `PociƒÖg ${tr.number}` : 'PociƒÖg nieznany';
                    }
                    history.push({ date: dateStr, info: info });
                }
            } catch(e) { console.error("Error matching", e); }
        });
    });
    
    history.reverse();
    
    if(history.length === 0) {
        ul.innerHTML = '<li style="padding:10px; color:gray; text-align:center">Brak zarejestrowanych przejazd√≥w.</li>';
    } else {
        history.forEach(h => {
            const li = document.createElement('li');
            li.className = 'history-item';
            li.innerHTML = `<span class="hist-date">${h.date}</span> <span class="hist-info">${h.info}</span>`;
            ul.appendChild(li);
        });
    }
    openModal('historyModal');
}

// --- MANUAL ENTRY ---
function openManualEntryModal() {
    document.getElementById('manualDate').valueAsDate = new Date();
    document.getElementById('manualRouteSearch').value = '';
    renderManualRouteList('');
    openModal('manualEntryModal');
}

function filterManualRoutes() {
    const txt = document.getElementById('manualRouteSearch').value.toLowerCase();
    renderManualRouteList(txt);
}

function renderManualRouteList(filter) {
    const sel = document.getElementById('manualRouteSelect');
    sel.innerHTML = '';
    dbMaster.forEach((m) => {
        const text = `${m.start} - ${m.end} ${m.via !== '-' ? '(przez ' + m.via + ')' : ''}`;
        if(filter === '' || text.toLowerCase().includes(filter)) {
            const opt = new Option(text, m._uid);
            sel.appendChild(opt);
        }
    });
}

function saveManualEntry() {
    const dateVal = document.getElementById('manualDate').value;
    const uid = parseInt(document.getElementById('manualRouteSelect').value);
    
    if(!dateVal || isNaN(uid)) return alert("Wybierz datƒô i odcinek!");
    const m = dbMaster.find(x => x._uid === uid);
    if(!m) return;
    
    if(!appData.schedule[dateVal]) appData.schedule[dateVal] = [];
    
    appData.schedule[dateVal].push({
        trainId: MANUAL_TRAIN_ID,
        from: m.start,
        to: m.end,
        via: m.via 
    });
    
    saveData();
    closeModal('manualEntryModal');
    renderCalendar();
    renderReport();
}

// --- ICS HANDLER ---
function handleIcs(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        parseIcs(e.target.result);
        saveData();
        renderCalendar();
        renderReport();
        alert("Zaimportowano grafik!");
    };
    reader.readAsText(file);
    input.value = ''; 
}

function parseIcs(data) {
    const lines = data.split(/\r\n|\n|\r/);
    let inEvent = false;
    let event = {};
    
    lines.forEach(line => {
        if(line.startsWith('BEGIN:VEVENT')) { inEvent = true; event = {}; }
        else if(line.startsWith('END:VEVENT')) { 
            inEvent = false; 
            processEvent(event); 
        } else if (inEvent) {
            const [k, v] = line.split(':');
            if(k && v) event[k.split(';')[0]] = v;
        }
    });
}

function processEvent(e) {
    if(!e.DTSTART || !e.SUMMARY) return;
    const dStr = e.DTSTART.slice(0,8);
    const dateStr = `${dStr.slice(0,4)}-${dStr.slice(4,6)}-${dStr.slice(6,8)}`;
    
    if(!appData.shifts[dateStr]) appData.shifts[dateStr] = [];
    
    const isNight = e.SUMMARY.toLowerCase().includes('noc') || (e.DTSTART.includes('T2') || e.DTSTART.includes('T19')); 
    
    const exists = appData.shifts[dateStr].find(x => x.summary === e.SUMMARY);
    if(!exists) {
        appData.shifts[dateStr].push({
            summary: e.SUMMARY,
            isOvernight: isNight,
            timeInfo: `${e.DTSTART.slice(9,13)} - ${e.DTEND ? e.DTEND.slice(9,13) : '?'}`
        });
    }
}

// --- DAY EDIT ---
function openDayEdit(dateStr) {
    selectedDateStr = dateStr;
    const dObj = new Date(dateStr);
    document.getElementById('modalDateTitle').innerText = dObj.toLocaleDateString('pl-PL');
    openModal('dayModal');
    renderDayList();
}

function renderDayList() {
    const c = document.getElementById('dayTrainsList');
    c.innerHTML = '';
    if(!appData.schedule[selectedDateStr]) return;
    
    appData.schedule[selectedDateStr].forEach((item, i) => {
        const d = document.createElement('div');
        d.style.cssText = 'background:#f1f5f9; padding:8px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;';
        
        let label = '';
        if(item.trainId === MANUAL_TRAIN_ID) {
            label = `‚úçÔ∏è Rƒôczny: ${item.from} - ${item.to}`;
        } else {
            const t = dbTrains.find(x=>x.id==item.trainId);
            label = t ? `üöÇ ${t.number} (${item.from} ‚ûù ${item.to})` : 'Nieznany';
        }
        
        d.innerHTML = `<span>${label}</span>`;
        const b = document.createElement('button');
        b.className = 'btn btn-danger';
        b.innerText='X';
        b.onclick=()=>{
            appData.schedule[selectedDateStr].splice(i,1);
            if(!appData.schedule[selectedDateStr].length) delete appData.schedule[selectedDateStr];
            saveData();
            renderDayList();
            renderCalendar();
            renderReport();
        };
        d.appendChild(b);
        c.appendChild(d);
    });
}

function fillTrainSelect() {
    const s = document.getElementById('trainSelect');
    s.innerHTML='';
    dbTrains.sort((a,b)=>a.number.localeCompare(b.number));
    dbTrains.forEach(t=>{
        const o=new Option(`${t.number} ${t.name||''} ${t.isCustom?'(W≈Çasny)':''}`,t.id);
        o.dataset.s=`${t.number} ${t.name||''}`.toLowerCase();
        s.appendChild(o);
    });
}

function filterTrains() {
    const v = document.getElementById('trainFilter').value.toLowerCase();
    [...document.getElementById('trainSelect').options].forEach(o=>o.style.display=o.dataset.s.includes(v)?'':'none');
}

function updateRoute() {
    const tid=document.getElementById('trainSelect').value;
    const area=document.getElementById('routeArea');
    if(!tid){area.style.display='none';return}
    const t=dbTrains.find(x=>x.id==tid);
    if(!t||!t.route)return;
    area.style.display='block';
    const s1=document.getElementById('startSt'), s2=document.getElementById('endSt');
    s1.innerHTML='';s2.innerHTML='';
    
    const stops=[];
    if(t.route.start) stops.push(t.route.start);
    t.route.segments.forEach(seg=>{if(stops[stops.length-1]!==seg.from)stops.push(seg.from);stops.push(seg.to)});
    
    stops.forEach(x=>{s1.appendChild(new Option(x));s2.appendChild(new Option(x))});
    if(stops.length>1)s2.selectedIndex=stops.length-1;
}

function addTrain() {
    const tid=document.getElementById('trainSelect').value, f=document.getElementById('startSt').value, t=document.getElementById('endSt').value;
    if(!tid||!f||!t)return;
    if(!appData.schedule[selectedDateStr]) appData.schedule[selectedDateStr]=[];
    appData.schedule[selectedDateStr].push({trainId:tid,from:f,to:t});
    saveData();
    renderDayList();
    renderCalendar();
    renderReport();
}

// --- IO ---
function loadData() {
    let r = localStorage.getItem(DB_KEY);
    if(!r) {
        const olds = ['kierownik_v3_0_data', 'kierownik_v2_9_data', 'kierownik_v2_8_data'];
        for(let k of olds) {
            r = localStorage.getItem(k);
            if(r) break;
        }
    }
    if(r) {
        appData = JSON.parse(r);
        fixLegacyData();
    }
    
    if(!appData.schedule) appData.schedule = {};
    if(!appData.shifts) appData.shifts = {};
    if(!appData.customTrains) appData.customTrains = [];
    if(!appData.profile) appData.profile = {name:"", kp:""};
}

function fixLegacyData() {
    let changed = false;
    for (const date in appData.schedule) {
        appData.schedule[date].forEach(entry => {
            if (entry.trainId === 'MANUAL_ENTRY') {
                entry.trainId = 'MANUAL';
                changed = true;
            }
        });
    }
    if (changed) saveData();
}

function saveData() {
    localStorage.setItem(DB_KEY, JSON.stringify(appData));
}

function exportData() {
    const b = new Blob([JSON.stringify(appData)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = `szlaki_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}

function importData(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            appData = JSON.parse(e.target.result);
            fixLegacyData();
            saveData();
            startSystem();
            alert("Wczytano dane!");
        } catch(x) { alert("B≈ÇƒÖd pliku JSON"); }
    };
    r.readAsText(f);
}

function clearData() {
    if(confirm("Czy na pewno usunƒÖƒá wszystkie dane?")) {
        localStorage.removeItem(DB_KEY);
        location.reload();
    }
}

// --- CUSTOM TRAINS ---
function openCustomModal() { openModal('customTrainModal'); }
function addCustomStopInput() {
    const d = document.createElement('div');
    d.style.cssText = 'display:flex; gap:5px;';
    d.innerHTML = '<input type="text" placeholder="Kolejna stacja" class="cust-stop">';
    document.getElementById('customStops').appendChild(d);
}
function saveCustomTrain() {
    const num = document.getElementById('customNumber').value;
    const name = document.getElementById('customName').value;
    const inputs = [...document.querySelectorAll('.cust-stop')].map(i=>i.value.trim()).filter(x=>x);
    
    if(!num || inputs.length < 2) return alert("Podaj numer i min. 2 stacje!");
    
    const segments = [];
    for(let i=0; i<inputs.length-1; i++) {
        segments.push({ from: inputs[i], to: inputs[i+1], dist: 0, vMax: 0 });
    }
    
    const newT = {
        id: 'CUST_' + Date.now(),
        number: num,
        name: name,
        isCustom: true,
        route: {
            start: inputs[0],
            segments: segments
        }
    };
    
    appData.customTrains.push(newT);
    saveData();
    dbTrains.push(newT);
    fillTrainSelect();
    closeModal('customTrainModal');
    alert("Dodano pociƒÖg!");
}

// --- UTILS ---
function openModal(id) { document.getElementById(id).style.display='flex'; }
function closeModal(id) { document.getElementById(id).style.display='none'; }

</script>
</body>
</html>
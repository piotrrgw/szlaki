<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Karta Znajomo≈õci Szlak√≥w v3.6</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script> 
    <script> 
        window.dataLayer = window.dataLayer || []; 
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date()); 
        gtag('config', 'G-W05T4L1HFD'); 
    </script>

    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --empty-dot: #cbd5e1;
            
            /* Zmienne do druku (dynamiczne) */
            --print-font-size: 10pt;
            --print-margin: 0.5cm;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        /* UI GLOBAL */
        .disclaimer-bar { background: #fffbeb; color: #92400e; padding: 8px; text-align: center; font-weight: 600; font-size: 0.8rem; border-bottom: 1px solid #fcd34d; flex-shrink: 0; }
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .help-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .help-btn:hover { background: #eff6ff; }

        /* LAYOUT */
        .app-container { display: grid; grid-template-columns: 360px 1fr; flex: 1; overflow: hidden; }
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 15px; gap: 15px; }
        .content-area { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; background: #f8fafc; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px 0; font-size: 0.95rem; font-weight: 600; color: var(--text); }

        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--secondary); margin-bottom: 2px; }
        input[type="text"], select, input[type="date"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; }
        
        .btn-group { display: flex; flex-wrap: wrap; gap: 6px; }
        .btn { padding: 8px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 4px; color: white; flex: 1; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: black; }
        .btn-danger { background: var(--danger); }
        .btn-info { background: #0ea5e9; }

        /* CALENDAR */
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .month-label { font-weight: 700; font-size: 1rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--border); border: 1px solid var(--border); }
        .cal-head { background: #f1f5f9; text-align: center; font-size: 0.7rem; font-weight: 700; padding: 4px 0; color: var(--secondary); }
        .cal-day { background: white; min-height: 60px; padding: 2px; cursor: pointer; position: relative; display: flex; flex-direction: column; gap: 2px; width: 100%; min-width: 0; }
        .cal-day:hover { background: #eff6ff; }
        .day-num { font-size: 0.75rem; font-weight: 600; color: var(--secondary); align-self: flex-end; margin-right: 2px; }
        .badge { font-size: 0.65rem; padding: 2px 4px; border-radius: 3px; color: white; word-break: break-word; line-height: 1.1; }
        .bg-train { background: var(--primary); }
        .bg-manual { background: #8b5cf6; }
        .bg-shift { background: var(--warning); color: black; border: 1px solid #d97706; }
        .bg-night { background: #1e293b; color: #fcd34d; border: 1px solid #0f172a; font-weight: bold; }

        /* TABLE */
        .table-wrapper { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; flex: 1; }
        .table-scroll { overflow: auto; flex: 1; }
        table.data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        table.data-table th { background: #f8fafc; padding: 10px; text-align: left; font-weight: 600; color: var(--secondary); border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 5; }
        table.data-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); color: var(--text); vertical-align: middle; }
        
        .col-lp { width: 35px; text-align: center; }
        .col-status { width: 35px; text-align: center; }
        .col-date { width: 140px; text-align: left; font-family: monospace; font-weight: 600; white-space: nowrap; cursor: pointer; }
        /* Ucinanie tekstu w kolumnie "Przez" */
        .col-via { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--secondary); font-size: 0.9em; }

        .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }
        .dot-green { background: var(--success); }
        .dot-orange { background: var(--warning); }
        .dot-red { background: var(--danger); }
        .dot-empty { background: white; border: 1px solid var(--empty-dot); }

        /* VARIANT SELECTOR */
        #variantSelector { display: none; background: #fff7ed; border: 1px solid #fdba74; padding: 10px; border-radius: 6px; margin-top: 10px; }
        .variant-btn { display: block; width: 100%; text-align: left; padding: 8px; margin-top: 5px; background: white; border: 1px solid #fed7aa; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .variant-btn:hover { background: #ffedd5; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }

        /* HISTORY LIST */
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .history-item:last-child { border-bottom: none; }
        .hist-date { font-weight: bold; font-family: monospace; }
        .hist-info { color: var(--secondary); font-size: 0.8rem; }

        .app-footer { margin-top: auto; padding: 10px; text-align: center; font-size: 0.75rem; color: var(--secondary); border-top: 1px solid var(--border); background: #fff; }

        @media (max-width: 900px) {
            .app-container { display: block; overflow: auto; height: auto; }
            .sidebar { border-right: none; border-bottom: 1px solid var(--border); }
            .table-wrapper { overflow-x: auto; } table.data-table { min-width: 600px; }
        }

        /* --- STYLES FOR PRINT --- */
        @media print {
            @page { 
                size: A4; 
                margin: var(--print-margin);
            }
            body { display: block; height: auto; background: white; color: black; }
            
            /* Ukrywanie element√≥w interfejsu */
            .sidebar, header, .disclaimer-bar, .no-print, .btn, .help-btn, .app-footer, .modal-overlay { display: none !important; }
            
            /* Layout strony */
            .app-container { display: block; height: auto; overflow: visible; }
            .content-area { padding: 0; overflow: visible; background: white; display: block; }
            
            /* POPRAWKA: Wy≈ÇƒÖczenie flexboxa dla kontenera tabeli */
            .table-wrapper { display: block; border: none; overflow: visible; margin-bottom: 20px; }
            .table-scroll { overflow: visible; display: block; }
            
            /* Nag≈Ç√≥wek */
            .print-header { display: block !important; border-bottom: 2px solid black; margin-bottom: 10px; padding-bottom: 5px; }
            .print-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10pt; }
            .print-title { text-align: center; text-transform: uppercase; font-size: 14pt; font-weight: bold; margin: 5px 0; }
            
            /* Stopka z podpisem - POPRAWIONE POZYCJONOWANIE */
            .print-footer { 
                display: block !important; 
                margin-top: 30px; 
                text-align: right; 
                font-size: 10pt; 
                page-break-inside: avoid; 
                break-inside: avoid;
                width: 100%;
                clear: both; /* Wa≈ºne: czy≈õci op≈Çywanie */
            }

            /* Tabela */
            table.data-table { 
                font-size: var(--print-font-size); 
                width: 100%; 
                border-collapse: collapse; 
            }
            table.data-table th, table.data-table td { 
                border: 1px solid black; 
                padding: 4px; 
            }
            
            /* Zapobieganie ≈Çamaniu wierszy w po≈Çowie */
            tr { 
                break-inside: avoid; 
                page-break-inside: avoid; 
            }
            thead { display: table-header-group; } 
            
            /* Zwƒô≈ºenie kolumny w druku */
            .col-via { max-width: 120px; }
        }
        .print-header, .print-footer { display: none; }
    </style>
</head>
<body>

<div class="disclaimer-bar">‚ö†Ô∏è Aplikacja pomocnicza. Kierownik PociƒÖgu zobowiƒÖzany jest do weryfikacji poprawno≈õci danych.</div>

<header>
    <h1>üöÇ Karta Szlak√≥w <span style="font-size:0.7rem; background:var(--primary); color:white; padding:2px 5px; border-radius:4px; margin-left:5px;">v3.6</span></h1>
    <button class="help-btn" onclick="openModal('helpModal')">‚ùì Instrukcja</button>
</header>

<div class="app-container">
    <div class="sidebar">
        <div class="card">
            <h3>üë§ Profil Kierownika</h3>
            <div class="input-group"><label>Imiƒô i Nazwisko:</label><input type="text" id="userName" oninput="saveUserData()"></div>
            <div class="input-group"><label>Numer KP:</label><input type="text" id="userKP" oninput="saveUserData()"></div>
        </div>

        <div class="card">
            <div class="calendar-nav">
                <button class="btn btn-secondary" style="flex:0" onclick="changeMonth(-1)">‚óÄ</button>
                <span id="monthDisplay" class="month-label">Stycze≈Ñ 2026</span>
                <button class="btn btn-secondary" style="flex:0" onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="card">
            <h3>Narzƒôdzia</h3>
            <div class="btn-group">
                <input type="file" id="icsInput" accept=".ics" hidden onchange="handleIcs(this)">
                <button class="btn btn-warning" onclick="document.getElementById('icsInput').click()">üìÖ Import</button>
                <button class="btn btn-success" onclick="openCustomModal()">‚ûï PociƒÖg</button>
            </div>
            <button class="btn btn-info" style="width:100%; margin-top:8px;" onclick="openManualEntryModal()">‚úçÔ∏è Wprowad≈∫ przejazd rƒôcznie</button>
            
            <div class="btn-group" style="margin-top:8px;">
                <button class="btn btn-secondary" onclick="exportData()">üíæ Kopia</button>
                <input type="file" id="backupInput" accept=".json" hidden onchange="importData(this)">
                <button class="btn btn-secondary" onclick="document.getElementById('backupInput').click()">üìÇ Wczytaj</button>
                <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Reset</button>
            </div>
             <button class="btn btn-primary" style="width:100%; margin-top:8px;" onclick="openPrintModal()">üñ®Ô∏è DRUKUJ</button>
        </div>
        
        <div id="fallback" style="display:none; color:red; font-size:0.8rem; text-align:center; padding:10px; border:1px dashed red;">
            Brak danych. Wgraj:<br>
            <input type="file" id="fTrain" accept=".json" style="margin:5px 0"><br>
            <input type="file" id="fMaster" accept=".json">
            <button onclick="manualLoad()" class="btn btn-primary" style="margin-top:5px;">Start</button>
        </div>
    </div>

    <div class="content-area">
        <div class="print-header">
            <div class="print-title">Wykaz znajomo≈õci szlak√≥w</div>
            <div class="print-row"><span id="printMonthInfo"></span><span></span></div>
            <div class="print-row"><span>Imiƒô: <strong id="printName"></strong></span><span>Nr KP: <strong id="printKP"></strong></span></div>
        </div>

        <div class="no-print" style="margin-bottom:15px;">
            <div style="background:white; padding:10px; border-radius:8px; border:1px solid var(--border); font-size:0.85rem; display:flex; flex-direction:column; gap:8px;">
                <div style="font-weight:bold; border-bottom:1px solid #eee; padding-bottom:4px;">Wa≈ºno≈õƒá szlaku:</div>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-green"></span> Wa≈ºny    |</span>
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-orange"></span> Wygasa w ciƒÖgu miesiƒÖca    |</span>
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-red"></span> Niewa≈ºny </span>
                </div>
                <div style="font-weight:bold; border-bottom:1px solid #eee; padding-bottom:4px; margin-top:5px;">Stan edycji miesiƒÖca:</div>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-green"></span> Przejechany w edytowanym miesiƒÖcu    |</span>
                    <span style="display:flex; align-items:center; gap:5px;"><span class="status-dot dot-empty"></span> Brak przejazdu w edytowanym miesiƒÖcu</span>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <div class="table-scroll">
                <table class="data-table" id="reportTable">
                    <thead>
                        <tr>
                            <th class="col-lp">LP</th>
                            <th class="col-status">Status</th>
                            <th>Odcinek (Od)</th>
                            <th>Odcinek (Do)</th>
                            <th class="col-via">Przez</th>
                            <th class="col-date">Przejazd w m-cu</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="print-footer"><p>................................<br>(Podpis pracownika)</p></div>
        
        <div class="app-footer no-print">
            Wersja aplikacji: v3.6 | Autorzy: Gemini & Piotr M üöÇ
        </div>
    </div>
</div>

<div class="modal-overlay" id="helpModal">
    <div class="modal" style="max-width:650px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h2 style="margin:0; color:var(--primary);">üìñ Instrukcja Obs≈Çugi</h2>
            <button class="btn btn-secondary" onclick="closeModal('helpModal')">X</button>
        </div>
        
        <div style="font-size:0.95rem; line-height:1.6; padding-right:5px; overflow-y:auto; flex:1;">
            
            <p><strong>Szlaki Kolejowe v3.6</strong> to narzƒôdzie do ewidencji pracy i kontroli znajomo≈õci szlak√≥w.</p>

            <h4 style="margin:15px 0 5px; color:var(--primary); border-left:4px solid var(--primary); padding-left:8px;">1. Import Grafiku</h4>
            <div style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid var(--border);">
                Pobierz sw√≥j grafik w formacie <code>.ics</code> ze strony: <br>
                üëâ <a href="https://irena1.intercity.pl" target="_blank" style="color:var(--primary); font-weight:bold;">www.irena1.intercity.pl</a>
                <br><br>
                Nastƒôpnie w aplikacji kliknij przycisk <span class="btn btn-warning" style="padding:2px 6px; font-size:0.7em;">üìÖ Import</span> i wybierz pobrany plik.
            </div>

            <h4 style="margin:15px 0 5px; color:var(--primary); border-left:4px solid var(--primary); padding-left:8px;">2. Tabela i Oznaczenia</h4>
            <p>Tabela pokazuje wszystkie mo≈ºliwe szlaki. Posiada dwie strefy informacji:</p>
            <ul>
                <li>
                    <strong>LEWA STRONA (Kropka Statusu):</strong> Informuje, czy masz wa≈ºne uprawnienia na szlak (liczone od ostatniego przejazdu w og√≥le).
                    <ul style="font-size:0.9em; margin-top:5px; color:#555;">
                        <li>üü¢ <strong>Zielona:</strong> Szlak wa≈ºny (ostatni przejazd < 11 miesiƒôcy temu).</li>
                        <li>üü† <strong>Pomara≈Ñczowa:</strong> Ko≈Ñczy siƒô wa≈ºno≈õƒá (11 - 12 miesiƒôcy temu).</li>
                        <li>üî¥ <strong>Czerwona:</strong> Szlak niewa≈ºny/wygas≈Ç (ponad 12 miesiƒôcy temu).</li>
                    </ul>
                </li>
                <li>
                    <strong>PRAWA STRONA (Data i Kropka):</strong> Informuje o aktywno≈õci w <strong>wybranym miesiƒÖcu</strong>.
                </li>
            </ul>

            <h4 style="margin:15px 0 5px; color:var(--primary); border-left:4px solid var(--primary); padding-left:8px;">3. Drukowanie</h4>
            <p>Po klikniƒôciu "Drukuj", pojawi siƒô okno, w kt√≥rym mo≈ºesz ustawiƒá:</p>
            <ul>
                <li><strong>Wielko≈õƒá czcionki:</strong> (domy≈õlnie 10pkt) - zmniejsz, je≈õli tabela nie mie≈õci siƒô na stronie.</li>
                <li><strong>Marginesy:</strong> (domy≈õlnie 0.5cm) - dostosuj do swojej drukarki.</li>
                <li>Kolumna "Przez" jest automatycznie ucinana, aby zachowaƒá czytelno≈õƒá dat.</li>
            </ul>

            <h4 style="margin:15px 0 5px; color:var(--primary); border-left:4px solid var(--primary); padding-left:8px;">4. Bezpiecze≈Ñstwo</h4>
            <p>Dane sƒÖ zapisywane tylko w Twojej przeglƒÖdarce. Regularnie r√≥b kopiƒô zapasowƒÖ przyciskiem <span class="btn btn-secondary" style="padding:2px 6px; font-size:0.7em;">üíæ Kopia</span>.</p>
        </div>
        <div style="text-align:right; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn btn-primary" onclick="closeModal('helpModal')">Rozumiem, zamknij</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="printModal">
    <div class="modal" style="max-width:400px;">
        <h3>üñ®Ô∏è Ustawienia Wydruku</h3>
        <p style="color:var(--secondary); font-size:0.9rem;">Dostosuj wyglƒÖd tabeli przed wydrukiem.</p>
        
        <div class="input-group">
            <label>Wielko≈õƒá czcionki (pkt):</label>
            <input type="number" id="printFontSize" value="10" min="6" max="14" step="0.5">
        </div>
        
        <div class="input-group">
            <label>Marginesy strony (cm):</label>
            <input type="number" id="printMargin" value="0.5" min="0" max="5" step="0.1">
        </div>

        <div style="background:#fffbeb; padding:10px; border:1px solid #fcd34d; border-radius:4px; font-size:0.8rem; margin-top:10px;">
            üí° <strong>Wskaz√≥wka:</strong> Kolumna "Przez" mo≈ºe zostaƒá uciƒôta, aby zmie≈õciƒá najwa≈ºniejsze dane.
        </div>

        <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn btn-secondary" onclick="closeModal('printModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="confirmPrint()">Drukuj</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="historyModal">
    <div class="modal">
        <h3>Historia: <span id="histTitle"></span></h3>
        <p style="font-size:0.8rem; color:var(--secondary); margin-bottom:10px;" id="histSubtitle"></p>
        <div style="flex:1; overflow-y:auto; border-top:1px solid #eee;">
            <ul id="historyList" class="history-list"></ul>
        </div>
        <div style="text-align:right; margin-top:15px;">
            <button class="btn btn-primary" onclick="closeModal('historyModal')">Zamknij</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="dayModal">
    <div class="modal">
        <h3>Edycja: <span id="modalDateTitle"></span></h3>
        <div id="dayTrainsList" style="margin-bottom:15px; display:flex; flex-direction:column; gap:5px;"></div>
        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        <label>Dodaj pociƒÖg (z listy):</label>
        <input type="text" id="trainFilter" placeholder="Szukaj numeru..." onkeyup="filterTrains()">
        <select id="trainSelect" size="5" style="height:100px; margin-bottom:10px" onchange="updateRoute()"></select>
        <div id="routeArea" style="display:none; background:#f8fafc; padding:10px; border-radius:6px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <div><small>Od:</small><select id="startSt"></select></div>
                <div><small>Do:</small><select id="endSt"></select></div>
            </div>
        </div>
        <div style="text-align:right; margin-top:15px; display:flex; gap:5px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('dayModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="addTrain()">Zapisz</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="manualEntryModal">
    <div class="modal">
        <h3>‚úçÔ∏è Wprowad≈∫ przejazd rƒôcznie</h3>
        <p style="font-size:0.85rem; color:var(--secondary);">
            Dodaj historyczny przejazd do kalendarza.
        </p>
        
        <div class="input-group">
            <label>Data przejazdu:</label>
            <input type="date" id="manualDate">
        </div>

        <div class="input-group">
            <label>Szukaj odcinka (wpisz stacjƒô):</label>
            <input type="text" id="manualRouteSearch" placeholder="np. Warszawa" onkeyup="filterManualRoutes()">
        </div>

        <div class="input-group">
            <label>Wybierz odcinek:</label>
            <select id="manualRouteSelect" size="8" style="height:150px; width:100%;"></select>
        </div>

        <div style="text-align:right; margin-top:15px; display:flex; gap:5px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('manualEntryModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="saveManualEntry()">Zapisz w kalendarzu</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="customModal">
    <div class="modal">
        <h3>Kreator PociƒÖgu</h3>
        <label style="font-size:0.85rem; font-weight:600;">Numer pociƒÖgu:</label>
        <input type="text" id="custNum" placeholder="np. 99999" style="margin-bottom:15px;">
        
        <div style="background:#f1f5f9; padding:10px; border-radius:6px; border:1px solid var(--border);">
            <label style="font-size:0.8rem; font-weight:bold;">Nastƒôpna stacja:</label>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <select id="custNextSt"></select>
                <button class="btn btn-success" id="btnAddSt" onclick="addCustSt()">Dodaj</button>
            </div>
            
            <div id="variantSelector">
                <strong style="font-size:0.85rem; color:#c2410c;">‚ö†Ô∏è Wybierz wariant trasy:</strong>
                <div id="variantOptions"></div>
            </div>
        </div>

        <ul id="custRoute" style="list-style:decimal; padding-left:25px; margin-top:10px; font-size:0.9rem; max-height:150px; overflow-y:auto;"></ul>
        
        <div style="text-align:right; margin-top:15px; display:flex; gap:5px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeModal('customModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="saveCust()">Zapisz PociƒÖg</button>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'kierownik_v3_1_data'; 
    const MANUAL_TRAIN_ID = 'MANUAL';

    let appData = { schedule: {}, shifts: {}, customTrains: [], profile: { name: "", kp: "" } };
    let dbTrains = [], dbMaster = [];
    let currentDate = new Date();
    let selectedDateStr = null;
    let tempCustRoute = []; 
    let tempCustSegments = []; 
    let stationGraph = {}; 

    document.addEventListener('DOMContentLoaded', async () => {
        loadData(); await autoFetchFiles();
    });

    async function autoFetchFiles() {
        try {
            const [t, m] = await Promise.all([ fetch('./trains.json'), fetch('./szlaki_master.json') ]);
            if(!t.ok || !m.ok) throw new Error();
            dbTrains = await t.json();
            dbMaster = await m.json();
            
            dbMaster.forEach((item, index) => {
                item._uid = index; 
            });

            buildGraph();
            startSystem();
        } catch(e) { document.getElementById('fallback').style.display = 'block'; }
    }

    function buildGraph() {
        stationGraph = {};
        dbMaster.forEach(m => {
            if(!stationGraph[m.start]) stationGraph[m.start] = [];
            if(!stationGraph[m.end]) stationGraph[m.end] = [];
            if(!stationGraph[m.start].includes(m.end)) stationGraph[m.start].push(m.end);
            if(!stationGraph[m.end].includes(m.start)) stationGraph[m.end].push(m.start);
        });
    }

    function manualLoad() {
        const f1 = document.getElementById('fTrain').files[0];
        const f2 = document.getElementById('fMaster').files[0];
        if(!f1 || !f2) return alert("Wybierz oba pliki!");
        const r1 = new FileReader(), r2 = new FileReader();
        let c=0; const check = ()=>{if(++c===2){document.getElementById('fallback').style.display='none'; buildGraph(); startSystem()}};
        r1.onload=e=>{dbTrains=JSON.parse(e.target.result);check()};
        r2.onload=e=>{
            dbMaster=JSON.parse(e.target.result);
            dbMaster.forEach((item, index) => { item._uid = index; });
            check();
        };
        r1.readAsText(f1); r2.readAsText(f2);
    }

    function startSystem() {
        if(!dbTrains.find(t => t.id === MANUAL_TRAIN_ID)) {
            dbTrains.push({ id: MANUAL_TRAIN_ID, number: 'RƒòCZNY', name: 'Wpis manualny', isCustom: true });
        }
        dbTrains = [...dbTrains, ...appData.customTrains];
        document.getElementById('userName').value = appData.profile.name || "";
        document.getElementById('userKP').value = appData.profile.kp || "";
        updatePrintHeader(); fillTrainSelect(); renderCalendar(); renderReport();
    }

    function saveUserData() {
        appData.profile.name = document.getElementById('userName').value;
        appData.profile.kp = document.getElementById('userKP').value;
        updatePrintHeader(); saveData();
    }
    function updatePrintHeader() {
        document.getElementById('printName').innerText = appData.profile.name;
        document.getElementById('printKP').innerText = appData.profile.kp;
    }

    // --- PRINT FUNCTIONS ---
    function openPrintModal() {
        openModal('printModal');
    }

    function confirmPrint() {
        const fs = document.getElementById('printFontSize').value;
        const mg = document.getElementById('printMargin').value;
        
        document.documentElement.style.setProperty('--print-font-size', fs + 'pt');
        document.documentElement.style.setProperty('--print-margin', mg + 'cm');
        
        closeModal('printModal');
        setTimeout(() => window.print(), 200);
    }

    // --- HELPER: MATCHING ---
    function checkMatch(seg, m) {
        const norm = str => str ? str.toLowerCase().trim() : "";
        const sf = norm(seg.from), st = norm(seg.to), sv = norm(seg.via);
        const mf = norm(m.start), mt = norm(m.end), mv = norm(m.via);

        const stationsMatch = (sf===mf && st===mt) || (sf===mt && st===mf);
        if(!stationsMatch) return false;

        if(mv.length > 1 && mv !== '-') {
            if(sv.length > 1 && sv !== '-') {
                return sv.includes(mv) || mv.includes(sv);
            } else return false; 
        }
        return true;
    }

    function getCoveredMasterUids(entry) {
        let coveredUids = [];
        const isManual = (entry.trainId === MANUAL_TRAIN_ID);
        
        if (isManual) {
            const seg = { from: entry.from, to: entry.to, via: entry.via || '-' };
            dbMaster.forEach(m => {
                if(checkMatch(seg, m)) coveredUids.push(m._uid);
            });
        } else {
            const tr = dbTrains.find(t => t.id == entry.trainId);
            if(tr && tr.route && tr.route.segments) {
                let active = false;
                tr.route.segments.forEach(seg => {
                    if (seg.from === entry.from) active = true;
                    if (active) {
                        dbMaster.forEach(m => {
                            if(checkMatch(seg, m)) coveredUids.push(m._uid);
                        });
                    }
                    if (seg.to === entry.to) active = false;
                });
            }
        }
        return coveredUids;
    }

    // --- CORE LOGIC: ANALYZE HISTORY ---
    function analyzeHistory(limitDate) {
        const result = {}; 
        const sortedDates = Object.keys(appData.schedule).sort();

        sortedDates.forEach(dateStr => {
            const d = new Date(dateStr);
            if (limitDate && d > limitDate) return; 

            appData.schedule[dateStr].forEach(entry => {
                const uids = getCoveredMasterUids(entry);
                uids.forEach(uid => {
                    result[uid] = dateStr;
                });
            });
        });
        return result;
    }

    // --- CALENDAR ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid'); grid.innerHTML='';
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        document.getElementById('monthDisplay').innerText = currentDate.toLocaleDateString('pl-PL',{month:'long',year:'numeric'});
        ["Pn","Wt","≈ör","Cz","Pt","Sb","Nd"].forEach(d=>{const x=document.createElement('div');x.className='cal-head';x.innerText=d;grid.appendChild(x)});
        const firstDay = new Date(y, m, 1).getDay() || 7;
        const daysInMonth = new Date(y, m+1, 0).getDate();
        for(let i=1; i<firstDay; i++) grid.appendChild(document.createElement('div'));
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div'); cell.className='cal-day';
            cell.onclick = () => openDayEdit(dateStr);
            cell.innerHTML = `<div class="day-num">${d}</div>`;
            
            if(appData.shifts[dateStr]) appData.shifts[dateStr].forEach(s => {
                const b=document.createElement('div'); b.className=`badge ${s.isOvernight?'bg-night':'bg-shift'}`;
                b.innerHTML=(s.isOvernight?'üåô ':'')+s.summary; if(s.timeInfo)b.title=s.timeInfo; cell.appendChild(b);
            });
            
            if(appData.schedule[dateStr]) {
                appData.schedule[dateStr].forEach(tr => {
                    const t = dbTrains.find(x=>x.id==tr.trainId);
                    const isManual = (tr.trainId === MANUAL_TRAIN_ID);
                    const b = document.createElement('div'); 
                    b.className = `badge ${isManual ? 'bg-manual' : 'bg-train'}`; 
                    b.innerText = isManual ? '‚úçÔ∏è Rƒôczny' : (t?t.number:'?'); 
                    cell.appendChild(b);
                });
            }
            grid.appendChild(cell);
        }
    }
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar(); renderReport();
        document.getElementById('printMonthInfo').innerText = `MiesiƒÖc: ${currentDate.toLocaleDateString('pl-PL',{month:'long',year:'numeric'})}`;
    }

    // --- REPORT RENDER ---
    function renderReport() {
        const tbody = document.querySelector('#reportTable tbody'); tbody.innerHTML='';
        const viewY = currentDate.getFullYear();
        const viewM = currentDate.getMonth();
        
        const allTimeHistory = analyzeHistory(null); 
        const today = new Date();

        let lpCounter = 1;

        dbMaster.forEach((m) => {
            // -- LEFT DOT LOGIC (Validity) --
            const lastDrivenDateStr = allTimeHistory[m._uid];
            let validityDot = 'dot-red';
            
            if(lastDrivenDateStr) {
                const lastDriven = new Date(lastDrivenDateStr);
                const diffTime = Math.abs(today - lastDriven);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if(diffDays <= 335) validityDot = 'dot-green';
                else if(diffDays <= 365) validityDot = 'dot-orange';
                else validityDot = 'dot-red';
            }

            // -- RIGHT DOT LOGIC (Monthly Activity) --
            let monthlyDateStr = '';
            let monthlyDot = 'dot-empty';
            
            const daysInMonth = new Date(viewY, viewM + 1, 0).getDate();
            for(let d=1; d<=daysInMonth; d++) {
                const checkDate = `${viewY}-${String(viewM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if(appData.schedule[checkDate]) {
                    const dayEntries = appData.schedule[checkDate];
                    for(let entry of dayEntries) {
                        const uids = getCoveredMasterUids(entry);
                        if(uids.includes(m._uid)) {
                            monthlyDateStr = checkDate;
                            monthlyDot = 'dot-green';
                            break; 
                        }
                    }
                }
                if(monthlyDot === 'dot-green') break;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="col-lp">${lpCounter++}</td>
                <td class="col-status"><span class="status-dot ${validityDot}" title="Status wa≈ºno≈õci"></span></td>
                <td>${m.start}</td>
                <td>${m.end}</td>
                <td class="col-via" title="${m.via}">${m.via==='-'?'':m.via}</td>
                <td class="col-date" onclick="openHistory(${m._uid})">
                    <span style="display:flex; align-items:center; gap:8px;">
                        <span class="status-dot ${monthlyDot}"></span>
                        ${monthlyDateStr || '<span style="color:#cbd5e1">-</span>'}
                    </span>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    // --- HISTORY MODAL LOGIC ---
    function openHistory(uid) {
        const m = dbMaster.find(x => x._uid === uid);
        if(!m) return alert('B≈ÇƒÖd: Nie znaleziono szlaku w bazie (UID mismatch).');

        const routeName = `${m.start} - ${m.end} ${m.via!=='-'?'('+m.via+')':''}`;
        document.getElementById('histTitle').innerText = "Historia przejazd√≥w";
        document.getElementById('histSubtitle').innerText = routeName;
        
        const ul = document.getElementById('historyList'); ul.innerHTML = '';
        
        let history = [];
        const sortedDates = Object.keys(appData.schedule).sort();

        sortedDates.forEach(dateStr => {
            appData.schedule[dateStr].forEach(entry => {
                try {
                    const uids = getCoveredMasterUids(entry);
                    if(uids.includes(uid)) {
                        let info = '';
                        if(entry.trainId === MANUAL_TRAIN_ID) {
                            info = 'Wpis rƒôczny';
                        } else {
                            const tr = dbTrains.find(t=>t.id == entry.trainId);
                            info = tr ? `PociƒÖg ${tr.number}` : 'PociƒÖg nieznany';
                        }
                        history.push({ date: dateStr, info: info });
                    }
                } catch(e) { console.error("Error matching", e); }
            });
        });

        history.reverse();

        if(history.length === 0) {
            ul.innerHTML = '<li style="padding:10px; color:gray; text-align:center">Brak zarejestrowanych przejazd√≥w.</li>';
        } else {
            history.forEach(h => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `<span class="hist-date">${h.date}</span> <span class="hist-info">${h.info}</span>`;
                ul.appendChild(li);
            });
        }
        openModal('historyModal');
    }

    // --- MANUAL ENTRY ---
    function openManualEntryModal() {
        document.getElementById('manualDate').valueAsDate = new Date();
        document.getElementById('manualRouteSearch').value = '';
        renderManualRouteList('');
        openModal('manualEntryModal');
    }

    function filterManualRoutes() {
        const txt = document.getElementById('manualRouteSearch').value.toLowerCase();
        renderManualRouteList(txt);
    }

    function renderManualRouteList(filter) {
        const sel = document.getElementById('manualRouteSelect');
        sel.innerHTML = '';
        dbMaster.forEach((m) => {
            const text = `${m.start} - ${m.end} ${m.via !== '-' ? '(przez ' + m.via + ')' : ''}`;
            if(filter === '' || text.toLowerCase().includes(filter)) {
                const opt = new Option(text, m._uid); 
                sel.appendChild(opt);
            }
        });
    }

    function saveManualEntry() {
        const dateVal = document.getElementById('manualDate').value;
        const uid = parseInt(document.getElementById('manualRouteSelect').value);
        
        if(!dateVal || isNaN(uid)) return alert("Wybierz datƒô i odcinek!");
        
        const m = dbMaster.find(x => x._uid === uid);
        if(!m) return;
        
        if(!appData.schedule[dateVal]) appData.schedule[dateVal] = [];
        appData.schedule[dateVal].push({ trainId: MANUAL_TRAIN_ID, from: m.start, to: m.end, via: m.via });
        saveData(); renderCalendar(); renderReport(); closeModal('manualEntryModal');
        alert("Dodano wpis rƒôczny.");
    }

    // --- DAY EDIT ---
    function openDayEdit(d) {
        selectedDateStr=d; document.getElementById('modalDateTitle').innerText=d; 
        document.getElementById('dayModal').style.display='flex';
        document.getElementById('trainFilter').value=''; filterTrains();
        document.getElementById('trainSelect').value=''; document.getElementById('routeArea').style.display='none';
        renderDayList();
    }
    function renderDayList() {
        const c = document.getElementById('dayTrainsList'); c.innerHTML='';
        const l = appData.schedule[selectedDateStr]||[];
        if(!l.length) c.innerHTML='<i style="color:#888;font-size:0.8rem">Brak wpis√≥w</i>';
        l.forEach((x,i)=>{
            const isManual = (x.trainId === MANUAL_TRAIN_ID);
            const t = dbTrains.find(z=>z.id==x.trainId);
            const d=document.createElement('div'); 
            d.style.cssText="display:flex;justify-content:space-between;background:#f1f5f9;padding:5px;border-radius:4px;font-size:0.85rem;align-items:center;";
            let label = isManual ? `‚úçÔ∏è <b>RƒòCZNY</b> ${x.from}-${x.to}` : `<b>${t?t.number:'?'}</b> ${x.from}-${x.to}`;
            d.innerHTML=`<span>${label}</span>`;
            const b=document.createElement('button'); b.className='btn btn-danger'; b.innerText='X';
            b.onclick=()=>{ appData.schedule[selectedDateStr].splice(i,1); if(!appData.schedule[selectedDateStr].length) delete appData.schedule[selectedDateStr]; saveData(); renderDayList(); renderCalendar(); renderReport(); };
            d.appendChild(b); c.appendChild(d);
        });
    }
    function fillTrainSelect() {
        const s = document.getElementById('trainSelect'); s.innerHTML='';
        dbTrains.sort((a,b)=>a.number.localeCompare(b.number));
        dbTrains.forEach(t=>{ const o=new Option(`${t.number} ${t.name||''} ${t.isCustom?'(W≈Çasny)':''}`,t.id); o.dataset.s=`${t.number} ${t.name||''}`.toLowerCase(); s.appendChild(o); });
    }
    function filterTrains() {
        const v = document.getElementById('trainFilter').value.toLowerCase();
        [...document.getElementById('trainSelect').options].forEach(o=>o.style.display=o.dataset.s.includes(v)?'':'none');
    }
    function updateRoute() {
        const tid=document.getElementById('trainSelect').value; const area=document.getElementById('routeArea');
        if(!tid){area.style.display='none';return}
        const t=dbTrains.find(x=>x.id==tid); if(!t||!t.route)return;
        area.style.display='block';
        const s1=document.getElementById('startSt'), s2=document.getElementById('endSt');
        s1.innerHTML='';s2.innerHTML='';
        const stops=[]; if(t.route.start) stops.push(t.route.start);
        t.route.segments.forEach(seg=>{if(stops[stops.length-1]!==seg.from)stops.push(seg.from);stops.push(seg.to)});
        stops.forEach(x=>{s1.appendChild(new Option(x));s2.appendChild(new Option(x))});
        if(stops.length>1)s2.selectedIndex=stops.length-1;
    }
    function addTrain() {
        const tid=document.getElementById('trainSelect').value, f=document.getElementById('startSt').value, t=document.getElementById('endSt').value;
        if(!tid||!f||!t)return;
        if(!appData.schedule[selectedDateStr]) appData.schedule[selectedDateStr]=[];
        appData.schedule[selectedDateStr].push({trainId:tid,from:f,to:t});
        saveData(); renderDayList(); renderCalendar(); renderReport();
    }

    // --- IO ---
    function loadData() {
        let r = localStorage.getItem(DB_KEY);
        if(!r) {
            const olds = ['kierownik_v3_0_data', 'kierownik_v2_9_data', 'kierownik_v2_8_data'];
            for(let k of olds) { let x=localStorage.getItem(k); if(x){r=x; localStorage.setItem(DB_KEY, r); break;} }
        }
        if(r) {
            try {
                const d=JSON.parse(r);
                if(d.schedule) appData.schedule=d.schedule;
                if(d.shifts) appData.shifts=d.shifts;
                if(d.customTrains) appData.customTrains=d.customTrains;
                if(d.profile) appData.profile=d.profile;
            } catch(e){}
        }
    }
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); }
    function exportData() {
        const b=new Blob([JSON.stringify(appData)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
    }
    function importData(inp) {
        const f=inp.files[0]; if(!f)return;
        const r=new FileReader(); r.onload=e=>{
            try {
                const d=JSON.parse(e.target.result);
                if(d.schedule) Object.assign(appData.schedule, d.schedule);
                if(d.shifts) Object.assign(appData.shifts, d.shifts);
                if(d.profile) appData.profile = d.profile;
                if(d.customTrains) d.customTrains.forEach(ct=>{if(!appData.customTrains.find(x=>x.id==ct.id)){appData.customTrains.push(ct);dbTrains.push(ct)}});
                startSystem(); saveData(); alert('Wczytano');
            } catch(err){alert('B≈ÇƒÖd pliku')}
        }; r.readAsText(f); inp.value='';
    }
    function handleIcs(inp) {
        const f=inp.files[0]; if(!f)return;
        const r=new FileReader(); r.onload=e=>{
            const lines=e.target.result.split(/\r\n|\n/); let evt=null;
            lines.forEach(l=>{
                if(l.startsWith('BEGIN:VEVENT')) evt={};
                else if(l.startsWith('END:VEVENT')) {
                    if(evt&&evt.s&&evt.d) {
                        const d=evt.d.slice(0,4)+'-'+evt.d.slice(4,6)+'-'+evt.d.slice(6,8);
                        if(!appData.shifts[d]) appData.shifts[d]=[];
                        if(!appData.shifts[d].find(x=>x.summary==evt.s)) appData.shifts[d].push({summary:evt.s, isOvernight:false});
                    } evt=null;
                } else if(evt) {
                    if(l.startsWith('SUMMARY:')) evt.s=l.substring(8);
                    if(l.startsWith('DTSTART')) evt.d=l.split(':')[1].split('T')[0];
                }
            });
            saveData(); renderCalendar(); alert('Grafik OK');
        }; r.readAsText(f); inp.value='';
    }
    function clearData() { if(confirm('Reset?')) { localStorage.removeItem(DB_KEY); location.reload(); } }
    
    // --- SMART CUSTOM TRAIN ---
    function openCustomModal() {
        tempCustRoute=[]; tempCustSegments=[]; 
        document.getElementById('custNum').value='';
        document.getElementById('variantSelector').style.display='none';
        renderCustNextSelect(); renderCustRoute(); document.getElementById('customModal').style.display='flex';
    }
    function renderCustNextSelect() {
        const sel = document.getElementById('custNextSt'); sel.innerHTML='';
        let options = [];
        if(tempCustRoute.length === 0) options = Object.keys(stationGraph).sort();
        else {
            const last = tempCustRoute[tempCustRoute.length-1];
            options = (stationGraph[last] || []).sort();
        }
        if(options.length === 0 && tempCustRoute.length > 0) {
            const opt = new Option("Koniec trasy", ""); opt.disabled=true; sel.appendChild(opt);
            document.getElementById('btnAddSt').disabled=true;
        } else {
            options.forEach(s => sel.appendChild(new Option(s)));
            document.getElementById('btnAddSt').disabled=false;
        }
    }
    function addCustSt() {
        const vDiv = document.getElementById('variantSelector');
        vDiv.style.display = 'none';
        const nextSt = document.getElementById('custNextSt').value;
        if(!nextSt) return;
        if(tempCustRoute.length === 0) {
            tempCustRoute.push(nextSt); renderCustRoute(); renderCustNextSelect(); return;
        }
        const lastSt = tempCustRoute[tempCustRoute.length-1];
        const possibleRoutes = dbMaster.filter(m => {
            const mf = m.start, mt = m.end;
            return (mf===lastSt && mt===nextSt) || (mf===nextSt && mt===lastSt);
        });
        if(possibleRoutes.length > 1) {
            vDiv.style.display = 'block';
            const vOpts = document.getElementById('variantOptions'); vOpts.innerHTML = '';
            possibleRoutes.forEach(r => {
                const btn = document.createElement('div');
                btn.className = 'variant-btn';
                btn.innerHTML = `<strong>Przez: ${r.via}</strong> <br><small>(${r.start} - ${r.end})</small>`;
                btn.onclick = () => confirmVariant(nextSt, r.via);
                vOpts.appendChild(btn);
            });
            document.getElementById('btnAddSt').disabled = true;
        } else {
            let viaVal = '-';
            if(possibleRoutes.length === 1) viaVal = possibleRoutes[0].via;
            confirmVariant(nextSt, viaVal);
        }
    }
    function confirmVariant(nextSt, viaVal) {
        document.getElementById('variantSelector').style.display = 'none';
        document.getElementById('btnAddSt').disabled = false;
        const lastSt = tempCustRoute[tempCustRoute.length-1];
        tempCustRoute.push(nextSt);
        tempCustSegments.push({ from: lastSt, to: nextSt, via: viaVal });
        renderCustRoute(); renderCustNextSelect();
    }
    function renderCustRoute() {
        const ul = document.getElementById('custRoute');
        if(tempCustRoute.length===0) ul.innerHTML='<li style="color:gray; list-style:none;">Start...</li>';
        else {
            ul.innerHTML = tempCustRoute.map((s,i) => {
                let extra = '';
                if(i > 0) {
                    const seg = tempCustSegments[i-1];
                    if(seg && seg.via !== '-') extra = ` <small style="color:#f59e0b">(przez ${seg.via})</small>`;
                }
                return `<li>${s}${extra} ${i===tempCustRoute.length-1 && i>0 ? `<span style="color:red;cursor:pointer;font-weight:bold;margin-left:5px;" onclick="undoCustSt()">[Cofnij]</span>` : ''}</li>`;
            }).join('');
        }
    }
    function undoCustSt() {
        if(tempCustRoute.length > 0) {
            tempCustRoute.pop(); if(tempCustSegments.length > 0) tempCustSegments.pop();
            document.getElementById('variantSelector').style.display='none'; document.getElementById('btnAddSt').disabled = false;
            renderCustRoute(); renderCustNextSelect();
        }
    }
    function saveCust() {
        const n=document.getElementById('custNum').value;
        if(tempCustRoute.length<2||!n) return alert('Wymagany numer i min. 2 stacje');
        const obj={ id:'c'+Date.now(), number:n, isCustom:true, route:{ start:tempCustRoute[0], segments:tempCustSegments } };
        appData.customTrains.push(obj); dbTrains.push(obj);
        fillTrainSelect(); saveData(); closeModal('customModal');
    }

    function closeModal(id){document.getElementById(id).style.display='none'}
    function openModal(id){document.getElementById(id).style.display='flex'}
    window.onclick=e=>{if(e.target.className==='modal-overlay')e.target.style.display='none'}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrolka Szlak贸w - Raport Miesiczny</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W05T4L1HFD');
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        :root { --primary-color: #2c3e50; }
        body { background-color: #f8f9fa; color: #212529; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-bottom: 60px; }
        .container { max-width: 1100px; }
        
        /* Interfejs */
        .control-panel { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; border: 1px solid #e9ecef; }
        
        /* Loader */
        #manual-loader { display: none; }
        .loader-box { border: 2px dashed #adb5bd; border-radius: 10px; padding: 40px; text-align: center; background-color: #fff; transition: all 0.3s; }
        .loader-box:hover { border-color: #0d6efd; background-color: #f1f8ff; }
        
        /* Tabela */
        .table-container { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; }
        th { background-color: var(--primary-color) !important; color: #ffffff !important; font-weight: 500; }
        .row-active { background-color: #e8f5e9 !important; transition: background-color 0.3s ease; }
        
        #map { height: 450px; width: 100%; border-radius: 4px; border: 1px solid #ccc; }

        .app-footer { position: fixed; bottom: 0; width: 100%; background-color: var(--primary-color); color: #ffffff; text-align: center; padding: 8px 0; font-size: 0.85rem; z-index: 1000; }
        .footer-version { font-size: 0.75rem; opacity: 0.7; }

        /* Print Styles */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background-color: white; padding: 0; margin: 0; font-size: 10pt; }
            .control-panel, .app-footer, .btn, .modal, .bi-map, .memory-counter, .no-print, #manual-loader { display: none !important; }
            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
            .table-container { box-shadow: none; border: none; }
            #printHeader { display: block !important; margin-bottom: 20px; text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; }
            .print-meta { display: flex; justify-content: space-between; margin-top: 20px; font-weight: bold; }
            table { width: 100% !important; border-collapse: collapse; }
            th, td { border: 1px solid black !important; padding: 4px !important; color: black !important; }
            th { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            input[type="date"] { border: none; background: transparent; padding: 0; font-family: inherit; font-weight: bold; color: black; width: auto; text-align: right; display: block; }
            input[type="date"]::-webkit-calendar-picker-indicator { display: none; }
            .row-active { background-color: white !important; }
        }
        #printHeader { display: none; }
    </style>
</head>
<body>

<div class="container mt-4">
    
    <div id="printHeader">
        <h2>WYKAZ ZNAJOMOCI SZLAKW</h2>
        <div class="print-meta px-4">
            <span>Imi i Nazwisko: ........................................................</span>
            <span>Miesic: ......................... Rok: .................</span>
        </div>
    </div>

    <header class="mb-4 text-center no-print">
        <h1 class="display-6 fw-bold text-secondary"><i class="bi bi-file-earmark-spreadsheet"></i> Kontrolka Szlak贸w</h1>
        <p class="text-muted">Elektroniczna Karta Znajomoci Szlak贸w</p>
    </header>

    <div id="manual-loader" class="container mb-4 no-print fade-in">
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <strong>Wymagana akcja u偶ytkownika.</strong><br>
                Prosz wskaza pliki bazy danych rcznie (blokada CORS lub brak plik贸w).
            </div>
        </div>
        
        <div class="loader-box">
            <i class="bi bi-cloud-upload fs-1 text-primary"></i>
            <h4 class="mt-3">Wgraj baz danych</h4>
            <p class="text-muted">Wybierz <code>szlaki_master.json</code> oraz <code>trains.json</code>.</p>
            
            <div class="d-flex justify-content-center gap-3 mt-3">
                <label class="btn btn-outline-primary btn-lg">
                    <input type="file" multiple accept=".json" onchange="handleManualUpload(this)" hidden>
                    <i class="bi bi-folder2-open"></i> Wybierz pliki JSON
                </label>
            </div>
            
            <div class="mt-3 text-start d-inline-block">
                <div id="status-szlaki" class="text-danger"><i class="bi bi-x-circle"></i> Szlaki Master</div>
                <div id="status-trains" class="text-danger"><i class="bi bi-x-circle"></i> Trains (Pocigi)</div>
            </div>
        </div>
    </div>

    <div class="control-panel no-print d-none" id="main-interface">
        <h5 class="border-bottom pb-2 mb-3">Rejestracja Przejazdu</h5>
        
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="inputDate" class="form-label fw-bold small text-muted">Data przejazdu</label>
                <input type="date" id="inputDate" class="form-control">
            </div>
            <div class="col-md-5">
                <label for="inputTrain" class="form-label fw-bold small text-muted">Numer pocigu</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-train-front-fill"></i></span>
                    <input type="text" id="inputTrain" class="form-control" placeholder="np. 12010..." aria-label="Numer pocigu">
                    <button class="btn btn-primary" id="btnSearchTrain">
                        <i class="bi bi-search"></i> Szukaj
                    </button>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group w-100">
                    <button class="btn btn-outline-danger" id="btnClearData">
                        <i class="bi bi-trash"></i> Reset
                    </button>
                    <button class="btn btn-success" onclick="window.print()">
                        <i class="bi bi-printer"></i> Drukuj / PDF
                    </button>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
            <small class="text-muted memory-counter" id="memoryUsage">Pami lokalna: ...</small>
        </div>
    </div>

    <div class="table-container table-responsive d-none" id="table-container">
        <table class="table table-hover table-bordered align-middle mb-0" id="routesTable">
            <thead>
                <tr>
                    <th class="text-center" style="width: 50px;">LP</th>
                    <th>Odcinek (Od - Do)</th>
                    <th>Przez (Via)</th>
                    <th class="text-center no-print" style="width: 50px;">Mapa</th>
                    <th style="width: 160px;" class="text-end">Data ost. przejazdu</th>
                </tr>
            </thead>
            <tbody id="routesTableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="segmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Potwierd藕 przebieg trasy</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light border mb-3" id="modalTrainInfo"></div>
                <div class="list-group list-group-flush border rounded" id="modalSegmentsList" style="max-height: 400px; overflow-y: auto;"></div>
                <div class="mt-2 text-muted small"><i class="bi bi-info-circle"></i> Szlaki dopasowane automatycznie (Smart Match).</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="btnConfirmSegments">Zapisz</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalTitle">Mapa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0"><div id="map"></div></div>
        </div>
    </div>
</div>

<footer class="app-footer">
    <div class="container">
        <span>Wsp贸autorzy: Gemini oraz Piotr M </span>
        <div class="footer-version">Wersja aplikacji: v1.2</div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    const STORAGE_KEY = 'kontrolka_szlakow_data_v1';
    let szlakiData = [];
    let trainsData = [];
    let mapInstance = null;

    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('inputDate').valueAsDate = new Date();
        
        try {
            // Pr贸ba zaadowania domylnych plik贸w
            const [szlakiRes, trainsRes] = await Promise.all([
                fetch('szlaki_master.json'),
                fetch('trains.json') // ZMIANA: trains.json zamiast pociagi.json
            ]);

            if (!szlakiRes.ok || !trainsRes.ok) throw new Error("Bd pobierania");

            szlakiData = await szlakiRes.json();
            trainsData = await trainsRes.json();
            initApp();

        } catch (error) {
            console.warn("Autoload failed. Show manual loader.");
            document.getElementById('manual-loader').style.display = 'block';
        }
    });

    // Obsuga rcznego wgrywania
    function handleManualUpload(input) {
        const files = Array.from(input.files);
        if(files.length === 0) return;

        let processed = 0;
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    // Prosta detekcja: trains.json ma pole 'category', szlaki maj 'start'
                    if (file.name.includes('szlaki') || (json[0] && json[0].start)) {
                        szlakiData = json;
                        updateStatus('szlaki', true);
                    } else if (file.name.includes('trains') || (json[0] && json[0].number)) {
                        trainsData = json;
                        updateStatus('trains', true);
                    }
                } catch(err) { console.error("JSON error", err); }
                
                processed++;
                if(szlakiData.length > 0 && trainsData.length > 0) {
                    setTimeout(() => {
                        document.getElementById('manual-loader').style.display = 'none';
                        initApp();
                    }, 500);
                }
            };
            reader.readAsText(file);
        });
    }

    function updateStatus(type, ok) {
        const el = document.getElementById(`status-${type}`);
        if(ok) {
            el.className = 'text-success fw-bold';
            el.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${type === 'szlaki' ? 'Szlaki' : 'Pocigi'} OK`;
        }
    }

    function initApp() {
        szlakiData.sort((a, b) => a.id - b.id);
        document.getElementById('main-interface').classList.remove('d-none');
        document.getElementById('table-container').classList.remove('d-none');
        renderTable();
        updateMemoryUsage();
    }

    // --- Renderowanie Tabeli (szlaki_master) ---
    function renderTable() {
        const tbody = document.getElementById('routesTableBody');
        tbody.innerHTML = '';
        const savedData = getSavedData();

        szlakiData.forEach(route => {
            const tr = document.createElement('tr');
            tr.dataset.id = route.id;
            
            const savedDate = savedData[route.id] || '';
            if (savedDate) tr.classList.add('row-active');

            const hasGeo = (route.geometry || route.coordinates);
            const mapBtn = `<button class="btn btn-sm btn-link text-secondary no-print" 
                onclick="showMap(${route.id})" ${hasGeo ? '' : 'disabled'}><i class="bi bi-map"></i></button>`;

            tr.innerHTML = `
                <td class="text-center fw-bold text-muted small">${route.id}</td>
                <td>${route.start} - ${route.end}</td>
                <td class="small text-muted">${route.via !== '-' ? route.via : ''}</td>
                <td class="text-center">${mapBtn}</td>
                <td>
                    <input type="date" class="form-control form-control-sm border-0 bg-transparent fw-bold" 
                           value="${savedDate}" 
                           onchange="manualUpdate(${route.id}, this.value)">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Wyszukiwanie Pocigu ---
    document.getElementById('btnSearchTrain').addEventListener('click', () => {
        const query = document.getElementById('inputTrain').value.trim().toLowerCase().replace(/\s/g, '');
        if (!query) return alert("Wpisz numer pocigu.");

        const train = trainsData.find(p => p.number.toString().toLowerCase().includes(query));

        if (!train) return alert("Nie znaleziono pocigu.");
        showSegmentModal(train);
    });

    function showSegmentModal(train) {
        const list = document.getElementById('modalSegmentsList');
        const info = document.getElementById('modalTrainInfo');
        list.innerHTML = '';

        // Obsuga struktury z trains.json (route.start / route.end)
        const relOd = train.route ? train.route.start : '???';
        const relDo = train.route ? train.route.end : '???';
        
        info.innerHTML = `<strong>${train.category || ''} ${train.number}</strong> (${train.name || ''})<br>Relacja: ${relOd} &rarr; ${relDo}`;
        
        // Pobierz segmenty z train.route.segments
        const segments = (train.route && train.route.segments) ? train.route.segments : [];

        if (segments.length === 0) {
            list.innerHTML = '<div class="p-3 text-danger">Ten pocig nie ma zdefiniowanej trasy.</div>';
            new bootstrap.Modal(document.getElementById('segmentModal')).show();
            return;
        }

        segments.forEach((seg, idx) => {
            // ZMIANA: W trains.json segmenty maj pola 'from' i 'to' (nie 'od'/'do')
            const sFrom = (seg.from || seg.od || '').trim();
            const sTo = (seg.to || seg.do || '').trim();

            // Smart Match: Szukaj w szlakiData
            const matchedRoute = szlakiData.find(m => {
                const mStart = m.start.trim();
                const mEnd = m.end.trim();
                return (mStart === sFrom && mEnd === sTo) || (mStart === sTo && mEnd === sFrom);
            });

            let label = `${sFrom} - ${sTo}`;
            let value = "";
            let isDisabled = false;
            let isChecked = true;
            let badge = "";

            if (matchedRoute) {
                value = matchedRoute.id;
                label = `<strong>[${matchedRoute.id}]</strong> ${matchedRoute.start} - ${matchedRoute.end}`;
                if(matchedRoute.via && matchedRoute.via !== '-') label += ` <small class="text-muted">(${matchedRoute.via})</small>`;
            } else {
                badge = '<span class="badge bg-warning text-dark ms-2">Brak w Bazie</span>';
                isDisabled = true;
                isChecked = false;
                label += " (Brak dopasowania)";
            }

            const div = document.createElement('div');
            div.className = "list-group-item";
            if(isDisabled) div.classList.add('bg-light', 'text-muted');

            div.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${value}" id="segCheck${idx}" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                    <label class="form-check-label w-100" for="segCheck${idx}">${label} ${badge}</label>
                </div>
            `;
            list.appendChild(div);
        });

        new bootstrap.Modal(document.getElementById('segmentModal')).show();
    }

    document.getElementById('btnConfirmSegments').addEventListener('click', () => {
        const dateInput = document.getElementById('inputDate').value;
        if (!dateInput) return alert("Wybierz dat.");

        const checkboxes = document.querySelectorAll('#modalSegmentsList input:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (ids.length === 0) return alert("Brak zaznaczonych szlak贸w.");

        const savedData = getSavedData();
        let updated = 0;
        ids.forEach(id => {
            const curr = savedData[id];
            // Nadpisz jeli brak daty LUB nowa data jest nowsza
            if (!curr || new Date(dateInput) >= new Date(curr)) {
                savedData[id] = dateInput;
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) { row.querySelector('input').value = dateInput; row.classList.add('row-active'); }
                updated++;
            }
        });
        saveData(savedData);
        bootstrap.Modal.getInstance(document.getElementById('segmentModal')).hide();
        if(updated === 0) alert("Brak zmian (istniejce daty s nowsze).");
    });

    window.manualUpdate = function(id, val) {
        const d = getSavedData();
        const r = document.querySelector(`tr[data-id="${id}"]`);
        if (val) { d[id] = val; r.classList.add('row-active'); } else { delete d[id]; r.classList.remove('row-active'); }
        saveData(d);
    };

    window.showMap = function(id) {
        const r = szlakiData.find(x => x.id === id);
        if (!r) return;
        const modalEl = document.getElementById('mapModal');
        document.getElementById('mapModalTitle').innerText = `Szlak ${r.id}: ${r.start} - ${r.end}`;
        new bootstrap.Modal(modalEl).show();

        modalEl.addEventListener('shown.bs.modal', () => {
            if (mapInstance) mapInstance.remove();
            mapInstance = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
            const geo = r.geometry || r.coordinates;
            if (geo) {
                let gj = Array.isArray(geo) ? { "type": "LineString", "coordinates": geo } : geo;
                const l = L.geoJSON(gj, { style: { color: '#e74c3c', weight: 6 } }).addTo(mapInstance);
                try { mapInstance.fitBounds(l.getBounds(), { padding: [50, 50] }); } catch(e){}
            }
        }, { once: true });
    };

    function getSavedData() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch (e) { return {}; } }
    function saveData(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); updateMemoryUsage(); }
    document.getElementById('btnClearData').addEventListener('click', () => { if(confirm("Usun dane?")) { localStorage.removeItem(STORAGE_KEY); renderTable(); updateMemoryUsage(); } });
    function updateMemoryUsage() {
        let t = 0; for (let k in localStorage) if (localStorage.hasOwnProperty(k)) t += (localStorage[k].length + k.length) * 2;
        document.getElementById('memoryUsage').innerText = `Pami: ${(t / 1024).toFixed(2)} KB`;
    }
</script>
</body>
</html>
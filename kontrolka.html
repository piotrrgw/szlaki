<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karta Znajomo≈õci Szlak√≥w - Kontrolka v1.5</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W05T4L1HFD');
    </script>

    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #6c757d;
            --accent-color: #ffc107;
            --success-color: #28a745;
            --bg-color: #f4f6f8;
            --text-color: #333;
            --paper-bg: #fff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.8rem;
            text-align: center;
            flex-shrink: 0;
        }

        /* --- LAYOUT G≈Å√ìWNY (SPLIT VIEW) --- */
        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden; /* Scrollujemy tylko kolumny */
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .column-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-right: 10px;
        }

        .column-right {
            flex: 0 0 50%; /* Prawa kolumna zajmuje po≈Çowƒô (dla podglƒÖdu A4) */
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            align-items: center;
            background: #e9ecef;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }

        /* Responsywno≈õƒá dla ma≈Çych ekran√≥w */
        @media (max-width: 1024px) {
            .main-wrapper { flex-direction: column; overflow: auto; }
            .column-right { flex: auto; width: 100%; }
        }

        /* --- UI COMPONENTS --- */
        .panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: opacity 0.2s;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { opacity: 0.9; }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-warning { background-color: var(--accent-color); color: #000; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: #dc3545; color: white; }

        input, select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        /* --- KALENDARZ --- */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .month-title { font-size: 1.3rem; font-weight: bold; }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #dee2e6;
            border: 1px solid #dee2e6;
        }

        .calendar-header {
            background: #e9ecef;
            text-align: center;
            padding: 5px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 4px;
            cursor: pointer;
            position: relative;
            font-size: 0.85rem;
        }
        .calendar-day:hover { background-color: #f8f9fa; }
        .calendar-day.empty { background: #f4f4f4; cursor: default; }

        .day-num { font-weight: bold; margin-bottom: 2px; display: block; }
        
        .badge {
            display: inline-block;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .badge-shift { background-color: var(--accent-color); color: black; }
        .badge-shift.night { background-color: #343a40; color: white; }
        .badge-train { background-color: var(--primary-color); color: white; }

        /* --- PODGLƒÑD A4 (PREVIEW) --- */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            padding: 10mm;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            color: black;
            font-size: 9pt; /* PodglƒÖd taki jak druk */
            position: relative;
        }

        .preview-header {
            text-align: center;
            border-bottom: 2px solid black;
            margin-bottom: 10px;
            padding-bottom: 5px;
        }
        .preview-header h2 { margin: 0; text-transform: uppercase; font-size: 14pt; }

        table.preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        table.preview-table th, table.preview-table td {
            border: 1px solid black;
            padding: 2px 4px;
            font-size: 8pt;
        }
        table.preview-table th { background-color: #eee; }

        /* --- MODALE --- */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 8px;
            width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
        }
        
        /* Styl dla filtra pociƒÖg√≥w */
        .train-filter-container {
            position: relative;
            margin-bottom: 10px;
        }
        #trainSearchInput {
            padding-left: 30px; /* Miejsce na ikonƒô */
        }
        .search-icon {
            position: absolute; left: 8px; top: 8px; color: #888;
        }

        /* Lista budowania trasy custom */
        .route-builder-list {
            list-style: none; padding: 0; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 4px;
            max-height: 150px; overflow-y: auto;
        }
        .route-builder-list li {
            padding: 5px 10px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem;
        }
        .route-builder-list li:last-child { border-bottom: none; }

        /* --- PRINT --- */
        @media print {
            body { display: block; height: auto; background: white; }
            .column-left, header, footer, .no-print { display: none !important; }
            .main-wrapper { display: block; padding: 0; margin: 0; }
            .column-right { 
                display: block; width: 100%; margin: 0; padding: 0; border: none; 
                background: white; overflow: visible;
            }
            .a4-page {
                box-shadow: none; margin: 0; padding: 0; width: 100%; min-height: auto;
            }
            @page { size: A4; margin: 1cm; }
        }
    </style>
</head>
<body>

<header class="no-print">
    <h1>Karta Znajomo≈õci Szlak√≥w v1.5</h1>
</header>

<div class="main-wrapper">
    
    <div class="column-left">
        
        <div class="panel">
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
                <input type="file" id="icsFileInput" accept=".ics" style="display: none;" onchange="handleIcsUpload(this)">
                <button class="btn btn-warning" onclick="document.getElementById('icsFileInput').click()">üìÖ Importuj Grafik (ICS)</button>
                
                <button class="btn btn-success" onclick="openCustomTrainModal()">‚ûï Stw√≥rz w≈Çasny pociƒÖg</button>
                
                <button class="btn btn-secondary" onclick="exportData()">üíæ Kopia (Backup)</button>
                <input type="file" id="backupInput" accept=".json" style="display:none;" onchange="importData(this)">
                <button class="btn btn-secondary" onclick="document.getElementById('backupInput').click()">üìÇ Wczytaj</button>
            </div>
            
            <div style="display:flex; flex-wrap:wrap; gap:5px;">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Drukuj Raport</button>
                <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Reset</button>
            </div>
        </div>

        <div class="panel">
            <div class="calendar-controls">
                <button class="btn btn-secondary" onclick="changeMonth(-1)">‚óÄ</button>
                <span class="month-title" id="monthDisplay">Stycze≈Ñ 2026</span>
                <button class="btn btn-secondary" onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div id="fallback-upload" class="panel" style="display:none; border:2px dashed red;">
            <h3>‚ö†Ô∏è Brak plik√≥w danych</h3>
            <p>Wgraj pliki rƒôcznie:</p>
            <input type="file" id="manualTrainsFile" accept=".json"><br><br>
            <input type="file" id="manualSzlakiFile" accept=".json"><br><br>
            <button class="btn btn-primary" onclick="processManualFiles()">Start</button>
        </div>
    </div>

    <div class="column-right">
        <div class="no-print" style="margin-bottom:10px; color:#666; font-size:0.9rem;">
            üëÅÔ∏è PodglƒÖd wydruku (Aktualizowany na ≈ºywo)
        </div>
        
        <div class="a4-page">
            <div class="preview-header">
                <h2>Wykaz znajomo≈õci szlak√≥w</h2>
                <p style="margin:5px 0 0 0; font-size:10pt;">Podsumowanie miesiƒÖca</p>
            </div>
            <table class="preview-table" id="reportTable">
                <thead>
                    <tr>
                        <th style="width:30px">LP</th>
                        <th>Od</th>
                        <th>Do</th>
                        <th>Przez</th>
                        <th style="width:80px">Data</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div style="margin-top:20px; text-align:right; font-size:10pt;">
                .......................................................<br>
                (Podpis pracownika)
            </div>
        </div>
    </div>
</div>

<div class="modal" id="dayModal">
    <div class="modal-content">
        <h3 id="modalDateTitle">Edycja dnia</h3>
        <div id="existingTrainsList" style="margin-bottom:15px;"></div>
        <hr>
        <h4>Dodaj pociƒÖg</h4>
        
        <div class="train-filter-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="trainSearchInput" placeholder="Wpisz numer pociƒÖgu..." onkeyup="filterTrainList()">
        </div>
        
        <div class="form-group">
            <select id="trainSelect" size="5" style="height: 100px;" onchange="updateStationSelectors()">
                </select>
        </div>

        <div class="form-group" id="routeSelectorContainer" style="display:none; margin-top:15px;">
            <label>Odcinek (Twoja zmiana):</label>
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <small>Od:</small>
                    <select id="startStation"></select>
                </div>
                <div style="flex:1">
                    <small>Do:</small>
                    <select id="endStation"></select>
                </div>
            </div>
        </div>

        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeModal('dayModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="addTrainToDay()">Zapisz</button>
        </div>
    </div>
</div>

<div class="modal" id="customTrainModal">
    <div class="modal-content">
        <h3>Stw√≥rz w≈Çasny pociƒÖg</h3>
        <p style="font-size:0.85rem; color:#666;">Zdefiniuj pociƒÖg, je≈õli nie ma go w bazie preset√≥w.</p>

        <label>Numer pociƒÖgu:</label>
        <input type="text" id="customTrainNumber" placeholder="np. 99999">
        
        <div style="margin-top:15px;">
            <label>Budowanie trasy (dodawaj stacje po kolei):</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="customStationInput" list="masterStationsList" placeholder="Nazwa stacji...">
                <datalist id="masterStationsList"></datalist>
                <button class="btn btn-success" onclick="addStationToBuilder()">‚ûï</button>
            </div>
        </div>

        <ul id="customRouteList" class="route-builder-list">
            </ul>
        <div id="customRouteError" style="color:red; font-size:0.8rem; display:none;">Dodaj min. 2 stacje!</div>

        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeModal('customTrainModal')">Anuluj</button>
            <button class="btn btn-primary" onclick="saveCustomTrain()">Zapisz PociƒÖg</button>
        </div>
    </div>
</div>

<footer class="no-print" style="text-align:center; padding:10px; font-size:0.8rem; color:#666;">
    Wersja aplikacji: v1.5 | Wsp√≥≈Çautorzy: Gemini & Piotr M üöÇ
</footer>

<script>
    // --- STAN APLIKACJI ---
    let currentDate = new Date();
    let trainsData = []; // Baza pociƒÖg√≥w (Original + Custom)
    let originalTrainsData = []; // Tylko te z JSON
    let masterSzlakiData = [];
    let uniqueStations = new Set(); // Do podpowiedzi

    let userSchedule = {}; 
    let importedShifts = {};
    let customTrains = []; // Zapisane przez u≈ºytkownika

    // --- START ---
    document.addEventListener('DOMContentLoaded', async () => {
        loadLocalStorage();
        await attemptAutoLoad();
    });

    // --- ≈ÅADOWANIE DANYCH ---
    async function attemptAutoLoad() {
        try {
            const [tRes, mRes] = await Promise.all([ fetch('./trains.json'), fetch('./szlaki_master.json') ]);
            if (!tRes.ok || !mRes.ok) throw new Error();
            
            originalTrainsData = await tRes.json();
            masterSzlakiData = await mRes.json();
            
            initDataProcessing();
        } catch (e) {
            document.getElementById('fallback-upload').style.display = 'block';
        }
    }

    function processManualFiles() {
        const tFile = document.getElementById('manualTrainsFile').files[0];
        const mFile = document.getElementById('manualSzlakiFile').files[0];
        if(!tFile || !mFile) return alert("Wybierz pliki!");
        
        const r1 = new FileReader(); r1.onload = e => { originalTrainsData = JSON.parse(e.target.result); check(); };
        const r2 = new FileReader(); r2.onload = e => { masterSzlakiData = JSON.parse(e.target.result); check(); };
        
        let loaded = 0;
        const check = () => { if(++loaded===2) { document.getElementById('fallback-upload').style.display='none'; initDataProcessing(); }};
        
        r1.readAsText(tFile); r2.readAsText(mFile);
    }

    function initDataProcessing() {
        // Scalanie Custom Trains z Original
        mergeTrains();
        
        // Generowanie listy stacji do podpowiedzi
        masterSzlakiData.forEach(m => {
            uniqueStations.add(m.start);
            uniqueStations.add(m.end);
        });
        const dataList = document.getElementById('masterStationsList');
        dataList.innerHTML = '';
        [...uniqueStations].sort().forEach(st => {
            const opt = document.createElement('option');
            opt.value = st;
            dataList.appendChild(opt);
        });

        populateTrainList(); // Wype≈Çnij listƒô wyboru
        renderCalendar();
        generateReport();
    }

    function mergeTrains() {
        // trainsData to baza z pliku + baza usera
        trainsData = [...originalTrainsData, ...customTrains];
    }

    // --- UI KALENDARZA ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        
        // Nag≈Ç√≥wki
        const days = ["Pon","Wt","≈ör","Czw","Pt","Sob","Nd"];
        days.forEach(d => {
            const h = document.createElement('div');
            h.className = 'calendar-header';
            h.textContent = d;
            grid.appendChild(h);
        });

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('monthDisplay').textContent = 
            currentDate.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay() || 7; 
        const totalDays = new Date(year, month + 1, 0).getDate();

        // Puste
        for(let i=1; i<firstDay; i++) {
            const d = document.createElement('div'); d.className='calendar-day empty'; grid.appendChild(d);
        }

        // Dni
        for(let i=1; i<=totalDays; i++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            cell.onclick = () => openDayModal(dateStr);

            // Numer
            const num = document.createElement('span');
            num.className = 'day-num';
            num.textContent = i;
            cell.appendChild(num);

            // S≈Çu≈ºby (ICS)
            if(importedShifts[dateStr]) {
                importedShifts[dateStr].forEach(s => {
                    const b = document.createElement('span');
                    b.className = `badge badge-shift ${s.isOvernight?'night':''}`;
                    b.textContent = s.summary + (s.isOvernight?' üåô':'');
                    b.title = s.timeInfo || '';
                    cell.appendChild(b);
                });
            }

            // PociƒÖgi (User)
            if(userSchedule[dateStr]) {
                userSchedule[dateStr].forEach(entry => {
                    const t = trainsData.find(x => x.id == entry.trainId);
                    const b = document.createElement('div');
                    b.className = 'badge badge-train';
                    b.textContent = t ? `üöÇ ${t.number}` : '???';
                    cell.appendChild(b);
                });
            }
            grid.appendChild(cell);
        }
    }
    
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // --- OBS≈ÅUGA MODALA EDYCJI DNIA ---
    let selectedDate = null;

    function openDayModal(dateStr) {
        selectedDate = dateStr;
        document.getElementById('modalDateTitle').textContent = "Edycja: " + dateStr;
        document.getElementById('dayModal').style.display = 'flex';
        
        // Reset formularza
        document.getElementById('trainSearchInput').value = '';
        filterTrainList(); // Poka≈º wszystkie
        document.getElementById('trainSelect').value = '';
        document.getElementById('routeSelectorContainer').style.display = 'none';

        renderExistingTrains();
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        if(id === 'dayModal') selectedDate = null;
    }

    // --- LISTA POCIƒÑG√ìW (SEARCHABLE) ---
    function populateTrainList() {
        const sel = document.getElementById('trainSelect');
        sel.innerHTML = '';
        
        // Sortowanie
        trainsData.sort((a,b) => a.number.localeCompare(b.number));

        trainsData.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.textContent = `${t.number} ${t.name||''} ${t.isCustom?'(W≈Çasny)':''}`;
            opt.dataset.search = `${t.number} ${t.name||''}`.toLowerCase(); // Do szukania
            sel.appendChild(opt);
        });
    }

    function filterTrainList() {
        const term = document.getElementById('trainSearchInput').value.toLowerCase();
        const opts = document.getElementById('trainSelect').options;
        for(let opt of opts) {
            const txt = opt.dataset.search;
            if(txt.includes(term)) opt.style.display = '';
            else opt.style.display = 'none';
        }
    }

    function updateStationSelectors() {
        const tid = document.getElementById('trainSelect').value;
        const div = document.getElementById('routeSelectorContainer');
        const s1 = document.getElementById('startStation');
        const s2 = document.getElementById('endStation');
        
        if(!tid) { div.style.display='none'; return; }
        
        const train = trainsData.find(t => t.id == tid);
        if(!train || !train.route || !train.route.segments) { div.style.display='none'; return; }

        // Zbieranie stacji w kolejno≈õci
        const stops = [];
        if(train.route.start) stops.push(train.route.start);
        train.route.segments.forEach(seg => {
            if(stops[stops.length-1] !== seg.from) stops.push(seg.from);
            stops.push(seg.to);
        });

        s1.innerHTML = ''; s2.innerHTML = '';
        stops.forEach(st => {
            s1.add(new Option(st, st));
            s2.add(new Option(st, st));
        });

        if(stops.length > 1) {
            s1.selectedIndex = 0;
            s2.selectedIndex = stops.length - 1;
        }
        div.style.display = 'block';
    }

    // --- CUSTOM TRAIN CREATOR ---
    let builderStations = [];

    function openCustomTrainModal() {
        builderStations = [];
        document.getElementById('customTrainNumber').value = '';
        document.getElementById('customStationInput').value = '';
        document.getElementById('customRouteError').style.display = 'none';
        renderBuilderList();
        document.getElementById('customTrainModal').style.display = 'flex';
    }

    function addStationToBuilder() {
        const val = document.getElementById('customStationInput').value.trim();
        if(!val) return;
        builderStations.push(val);
        document.getElementById('customStationInput').value = '';
        document.getElementById('customStationInput').focus();
        renderBuilderList();
    }

    function renderBuilderList() {
        const ul = document.getElementById('customRouteList');
        ul.innerHTML = '';
        builderStations.forEach((st, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${idx+1}. ${st}</span> <button class="btn btn-danger" style="padding:2px 6px; font-size:0.7rem;" onclick="removeBuilderStation(${idx})">Usu≈Ñ</button>`;
            ul.appendChild(li);
        });
    }
    
    // Musi byƒá globalne ≈ºeby onclick w HTML widzia≈Ç
    window.removeBuilderStation = function(idx) {
        builderStations.splice(idx, 1);
        renderBuilderList();
    }

    function saveCustomTrain() {
        const num = document.getElementById('customTrainNumber').value.trim();
        if(!num || builderStations.length < 2) {
            document.getElementById('customRouteError').style.display = 'block';
            return;
        }

        // Konwersja listy stacji na segmenty
        const segments = [];
        for(let i=0; i<builderStations.length-1; i++) {
            segments.push({
                from: builderStations[i],
                to: builderStations[i+1],
                via: "-" // Domy≈õlne
            });
        }

        const newTrain = {
            id: 'custom_' + Date.now(),
            number: num,
            name: "W≈Çasny",
            isCustom: true,
            route: {
                start: builderStations[0],
                segments: segments
            }
        };

        customTrains.push(newTrain);
        mergeTrains();
        populateTrainList(); // Od≈õwie≈º listƒô
        saveLocalStorage();
        
        closeModal('customTrainModal');
        alert("PociƒÖg dodany! Mo≈ºesz go teraz wybraƒá z listy.");
    }

    // --- OPERACJE NA DANYCH DNIA ---
    function addTrainToDay() {
        const tid = document.getElementById('trainSelect').value;
        const from = document.getElementById('startStation').value;
        const to = document.getElementById('endStation').value;
        
        if(!tid || !from || !to) return;
        
        if(!userSchedule[selectedDate]) userSchedule[selectedDate] = [];
        userSchedule[selectedDate].push({ trainId: tid, from, to });
        
        saveLocalStorage();
        renderExistingTrains();
        renderCalendar();
        generateReport();
    }

    function renderExistingTrains() {
        const div = document.getElementById('existingTrainsList');
        div.innerHTML = '';
        if(!userSchedule[selectedDate] || !userSchedule[selectedDate].length) {
            div.innerHTML = '<span style="color:#999">Brak pociƒÖg√≥w tego dnia.</span>';
            return;
        }
        
        userSchedule[selectedDate].forEach((entry, idx) => {
            const t = trainsData.find(x => x.id == entry.trainId);
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'space-between';
            row.style.alignItems = 'center';
            row.style.background = '#f8f9fa';
            row.style.padding = '5px';
            row.style.marginBottom = '4px';
            row.style.borderRadius = '4px';
            
            row.innerHTML = `
                <div><strong>${t?t.number:'???'}</strong> <small>${entry.from}‚ûî${entry.to}</small></div>
                <button class="btn btn-danger" style="padding:2px 5px; font-size:0.7rem;" onclick="removeTrain(${idx})">X</button>
            `;
            div.appendChild(row);
        });
    }

    window.removeTrain = function(idx) {
        userSchedule[selectedDate].splice(idx, 1);
        if(!userSchedule[selectedDate].length) delete userSchedule[selectedDate];
        saveLocalStorage();
        renderExistingTrains();
        renderCalendar();
        generateReport();
    }

    // --- RAPORT ---
    function generateReport() {
        const tbody = document.querySelector('#reportTable tbody');
        tbody.innerHTML = '';
        const visited = {}; // { masterId: lastDate }

        Object.keys(userSchedule).forEach(date => {
            userSchedule[date].forEach(entry => {
                const train = trainsData.find(t => t.id == entry.trainId);
                if(!train) return;

                // Znajd≈∫ segmenty na trasie pociƒÖgu
                let active = false;
                for(let seg of train.route.segments) {
                    if(seg.from === entry.from) active = true;
                    if(active) matchSegment(seg, date, visited);
                    if(seg.to === entry.to) { active = false; break; }
                }
            });
        });

        // Generuj tabelƒô
        masterSzlakiData.forEach((m, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center">${idx+1}</td>
                <td>${m.start}</td>
                <td>${m.end}</td>
                <td>${m.via==='-'?'':m.via}</td>
                <td style="text-align:center; font-weight:bold;">${visited[m.id] || ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function matchSegment(seg, date, visited) {
        const norm = s => s ? s.toLowerCase().trim() : "";
        const tf = norm(seg.from);
        const tt = norm(seg.to);
        
        const match = masterSzlakiData.find(m => {
            const mf = norm(m.start);
            const mt = norm(m.end);
            const stMatch = (mf===tf && mt===tt) || (mf===tt && mt===tf);
            if(!stMatch) return false;
            
            if(m.via && m.via !== '-' && m.via.length > 2) {
                const mv = norm(m.via);
                const tv = norm(seg.via);
                return tv.includes(mv) || mv.includes(tv);
            }
            return true;
        });

        if(match) {
            if(!visited[match.id] || date > visited[match.id]) {
                visited[match.id] = date;
            }
        }
    }

    // --- EXPORT / IMPORT / ICS ---
    function handleIcsUpload(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                parseICS(e.target.result);
                saveLocalStorage();
                renderCalendar();
                alert("Grafik wczytany!");
            } catch(err) { alert("B≈ÇƒÖd ICS"); }
        };
        reader.readAsText(file);
        input.value='';
    }

    function parseICS(txt) {
        importedShifts = {};
        const lines = txt.replace(/\r\n/g, '\n').split('\n');
        let evt = null;
        
        lines.forEach(line => {
            line = line.trim();
            if(line === 'BEGIN:VEVENT') evt = {};
            else if(line === 'END:VEVENT') {
                if(evt && evt.summary && evt.start) processEvent(evt);
                evt = null;
            } else if(evt) {
                if(line.startsWith('SUMMARY:')) evt.summary = line.substring(8);
                else if(line.startsWith('DTSTART')) evt.start = parseIcsDate(line);
                else if(line.startsWith('DTEND')) evt.end = parseIcsDate(line);
            }
        });
    }

    function parseIcsDate(line) {
        // DTSTART;VALUE=DATE:20251213 lub DTSTART:20251213T120000
        const parts = line.split(':');
        const val = parts[parts.length-1];
        const y = parseInt(val.substr(0,4));
        const m = parseInt(val.substr(4,2))-1;
        const d = parseInt(val.substr(6,2));
        if(val.includes('T')) {
            const t = val.split('T')[1];
            return new Date(y,m,d, parseInt(t.substr(0,2)), parseInt(t.substr(2,2)));
        }
        return new Date(y,m,d); // All day
    }

    function processEvent(evt) {
        const k = `${evt.start.getFullYear()}-${String(evt.start.getMonth()+1).padStart(2,'0')}-${String(evt.start.getDate()).padStart(2,'0')}`;
        
        let isOvernight = false;
        let info = '';
        
        // Je≈õli ma czas i r√≥≈ºnica dni
        if(evt.end && (evt.start.getHours() !== 0 || evt.start.getMinutes() !== 0)) {
            if(evt.start.getDate() !== evt.end.getDate()) isOvernight = true;
            const fmt = {hour:'2-digit', minute:'2-digit'};
            info = `${evt.start.toLocaleTimeString([],fmt)} - ${evt.end.toLocaleTimeString([],fmt)}`;
        }

        if(!importedShifts[k]) importedShifts[k] = [];
        if(!importedShifts[k].find(x => x.summary === evt.summary)) {
            importedShifts[k].push({ summary: evt.summary, isOvernight, timeInfo: info });
        }
    }

    // --- ZAPIS I ODCZYT (BACKUP) ---
    function saveLocalStorage() {
        const data = { schedule: userSchedule, shifts: importedShifts, customTrains: customTrains };
        localStorage.setItem('kierownik_v1_5', JSON.stringify(data));
    }
    
    function loadLocalStorage() {
        const raw = localStorage.getItem('kierownik_v1_5');
        if(raw) {
            try {
                const d = JSON.parse(raw);
                userSchedule = d.schedule || {};
                importedShifts = d.shifts || {};
                customTrains = d.customTrains || [];
            } catch(e) {}
        }
    }

    function exportData() {
        const data = { 
            version: "1.5", 
            date: new Date().toISOString(),
            schedule: userSchedule, 
            shifts: importedShifts,
            customTrains: customTrains
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_kierownik_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const d = JSON.parse(e.target.result);
                if(d.schedule) userSchedule = d.schedule;
                if(d.shifts) importedShifts = d.shifts;
                if(d.customTrains) customTrains = d.customTrains;
                
                mergeTrains();
                populateTrainList();
                saveLocalStorage();
                renderCalendar();
                generateReport();
                alert("Dane przywr√≥cone pomy≈õlnie!");
            } catch(err) { alert("B≈ÇƒÖd pliku backupu"); }
        };
        reader.readAsText(file);
        input.value='';
    }
    
    function clearData() {
        if(confirm("Czy na pewno chcesz usunƒÖƒá wszystko?")) {
            localStorage.removeItem('kierownik_v1_5');
            userSchedule = {}; importedShifts = {}; customTrains = [];
            mergeTrains(); populateTrainList();
            renderCalendar(); generateReport();
        }
    }

    window.onclick = e => { 
        if(e.target.classList.contains('modal')) e.target.style.display='none'; 
    }

</script>
</body>
</html>
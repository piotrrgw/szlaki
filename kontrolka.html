<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karta Znajomo≈õci Szlak√≥w - Kontrolka v1.4</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W05T4L1HFD');
    </script>

    <style>
        :root {
            --primary-color: #0056b3;
            --accent-color: #ffc107; /* ≈ª√≥≈Çty dla s≈Çu≈ºb */
            --night-color: #2c3e50;  /* Ciemny dla nocek */
            --bg-color: #f8f9fa;
            --text-color: #333;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- AWARYJNE ≈ÅADOWANIE --- */
        #fallback-upload {
            display: none;
            background-color: white;
            border: 2px dashed var(--primary-color);
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        #fallback-upload h3 { margin-top: 0; color: var(--primary-color); }
        .file-input-group { margin: 15px 0; }

        /* --- KALENDARZ --- */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .month-display {
            font-size: 1.5rem;
            font-weight: bold;
            min-width: 200px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background-color: #e9ecef;
            font-size: 0.9rem;
        }

        .calendar-day {
            min-height: 100px;
            border: 1px solid var(--border-color);
            padding: 5px;
            cursor: pointer;
            position: relative;
            background: white;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background-color: #f1f8ff;
        }

        .calendar-day.empty {
            background-color: transparent;
            border: none;
            cursor: default;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
            flex-wrap: wrap;
            gap: 2px;
        }

        .day-number {
            font-weight: bold;
            font-size: 1.1rem;
            margin-right: 5px;
        }

        /* Stylizacja S≈Çu≈ºb (ICS) */
        .shifts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: flex-end;
            flex-grow: 1;
        }

        .shift-badge {
            background-color: var(--accent-color);
            color: #000;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            cursor: help;
            border: 1px solid #e0a800;
        }

        .shift-badge.overnight {
            background-color: var(--night-color);
            color: #fff;
            border-color: #1a252f;
        }

        .train-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.7rem;
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- TABELA WYNIKOWA --- */
        .report-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        table.report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        table.report-table th, table.report-table td {
            border: 1px solid black;
            padding: 6px;
            text-align: left;
        }

        table.report-table th {
            background-color: #e9ecef;
        }
        
        table.report-table tr:nth-child(even) {
            background-color: #fcfcfc;
        }

        /* --- MODAL --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 5px;
            font-size: 0.9rem;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-warning { background-color: var(--accent-color); color: #000; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }

        .train-list-item {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            font-size: 0.8rem;
            color: #666;
        }

        /* --- DRUKOWANIE (ULTRA COMPACT MODE) --- */
        @media print {
            @page {
                size: A4;
                margin: 0.5cm 0.8cm; /* Bardzo ma≈Çe marginesy: G√≥ra/D√≥≈Ç, Lewo/Prawo */
            }

            body { 
                background: white; 
                -webkit-print-color-adjust: exact; 
                font-family: 'Arial', sans-serif;
                color: black;
            }

            /* Ukrywamy UI aplikacji */
            header, .calendar-controls, .calendar-grid, footer, .no-print, #fallback-upload, .modal {
                display: none !important;
            }
            
            .container { width: 100%; max-width: none; padding: 0; margin: 0; }
            .report-section { box-shadow: none; padding: 0; border: none; margin: 0; }
            
            /* Tytu≈Ç raportu */
            h2 { 
                margin: 0 0 5px 0; 
                font-size: 12pt; 
                text-align: center; 
                text-transform: uppercase;
                border-bottom: 1px solid #000;
                padding-bottom: 5px;
            }
            
            /* Tabela skompresowana */
            table.report-table {
                font-size: 8pt; /* Ma≈Ça czcionka = klucz do sukcesu */
                width: 100%;
                border-collapse: collapse;
                border-spacing: 0;
            }
            
            table.report-table th, table.report-table td {
                padding: 1px 3px;
                border: 1px solid #000;
                line-height: 1.1; /* Ma≈Ça interlinia */
            }

            table.report-table th {
                background-color: #eee !important;
                font-weight: bold;
            }

            /* Ustawienia szeroko≈õci kolumn */
            table.report-table th:nth-child(1) { width: 25px; text-align: center; } /* LP */
            table.report-table th:nth-child(5) { width: 70px; text-align: center; } /* Data */

            /* Zapobieganie ≈Çamaniu wewnƒÖtrz wiersza */
            tr { page-break-inside: avoid; }
            
            /* Nag≈Ç√≥wek tabeli na ka≈ºdej stronie */
            thead { display: table-header-group; }
            
            /* Stopka wydruku (tylko na druku) */
            .print-footer {
                display: block;
                position: fixed;
                bottom: 0;
                width: 100%;
                text-align: center;
                font-size: 6pt;
                color: #555;
                border-top: 1px solid #ccc;
            }
        }
    </style>
</head>
<body>

<header>
    <h1>Karta Znajomo≈õci Szlak√≥w</h1>
    <p>Generator Podsumowania MiesiƒÖca</p>
</header>

<div class="container">

    <div id="fallback-upload">
        <h3>‚ö†Ô∏è Nie znaleziono plik√≥w danych</h3>
        <p>Aplikacja nie mog≈Ça automatycznie pobraƒá plik√≥w `trains.json` i `szlaki_master.json`.<br>Za≈Çaduj je rƒôcznie poni≈ºej:</p>
        
        <div class="file-input-group">
            <label>Plik <strong>trains.json</strong>:</label><br>
            <input type="file" id="manualTrainsFile" accept=".json">
        </div>
        <div class="file-input-group">
            <label>Plik <strong>szlaki_master.json</strong>:</label><br>
            <input type="file" id="manualSzlakiFile" accept=".json">
        </div>
        <button class="btn btn-primary" onclick="processManualFiles()">Wczytaj pliki i uruchom</button>
    </div>

    <div class="calendar-controls">
        <div>
            <button class="btn btn-secondary" onclick="changeMonth(-1)">‚óÄ Poprzedni</button>
            <span class="month-display" id="monthDisplay">Stycze≈Ñ 2026</span>
            <button class="btn btn-secondary" onclick="changeMonth(1)">Nastƒôpny ‚ñ∂</button>
        </div>
        
        <div>
            <input type="file" id="icsFileInput" accept=".ics" style="display: none;" onchange="handleIcsUpload(this)">
            <button class="btn btn-warning no-print" onclick="document.getElementById('icsFileInput').click()">üìÖ Importuj Grafik (ICS)</button>
            <button class="btn btn-primary no-print" onclick="window.print()">üñ®Ô∏è Drukuj Kartƒô</button>
            <button class="btn btn-danger no-print" onclick="clearData()">üóëÔ∏è Reset</button>
        </div>
    </div>

    <div class="calendar-grid" id="calendarGrid">
        </div>

    <div class="report-section">
        <h2>Wykaz znajomo≈õci szlak√≥w</h2>
        <table class="report-table" id="reportTable">
            <thead>
                <tr>
                    <th>LP</th>
                    <th>Od</th>
                    <th>Do</th>
                    <th>Przez</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<div class="print-footer" style="display:none;">
    Wygenerowano aplikacjƒÖ: Karta Znajomo≈õci Szlak√≥w v1.4 | Autorzy: Gemini & Piotr M üöÇ
</div>

<div class="modal" id="dayModal">
    <div class="modal-content">
        <h3 id="modalDateTitle">Edycja dnia</h3>
        
        <div id="existingTrainsList">
            </div>

        <hr style="margin: 20px 0; border-top: 1px solid #eee;">
        
        <h4>Dodaj pociƒÖg</h4>
        <div class="form-group">
            <label for="trainSelect">Wybierz pociƒÖg:</label>
            <select id="trainSelect" onchange="updateStationSelectors()">
                <option value="">-- Wybierz pociƒÖg --</option>
            </select>
        </div>

        <div class="form-group" id="routeSelectorContainer" style="display:none;">
            <label for="startStation">Odcinek od:</label>
            <select id="startStation"></select>
            
            <label for="endStation" style="margin-top:10px;">Odcinek do:</label>
            <select id="endStation"></select>
        </div>

        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeModal()">Zamknij</button>
            <button class="btn btn-primary" onclick="addTrainToDay()">Zapisz</button>
        </div>
    </div>
</div>

<footer>
    <p>Wsp√≥≈Çautorzy: Gemini & Piotr M üöÇ</p>
    <p>Wersja aplikacji: v1.4</p>
</footer>

<script>
    // --- ZMIENNE GLOBALNE ---
    let currentDate = new Date();
    let trainsData = [];
    let masterSzlakiData = [];
    
    let userSchedule = {}; 
    let importedShifts = {}; // { date: [ {summary, isOvernight, timeInfo} ] }

    // --- INICJALIZACJA ---
    document.addEventListener('DOMContentLoaded', async () => {
        loadLocalStorage();
        await attemptAutoLoad();
    });

    // --- ≈ÅADOWANIE PLIK√ìW ---
    async function attemptAutoLoad() {
        try {
            const [trainsRes, masterRes] = await Promise.all([
                fetch('./trains.json'),
                fetch('./szlaki_master.json')
            ]);
            if (!trainsRes.ok || !masterRes.ok) throw new Error("B≈ÇƒÖd sieci");

            trainsData = await trainsRes.json();
            masterSzlakiData = await masterRes.json();
            initializeApp();
        } catch (error) {
            console.warn("Autoload fail:", error);
            document.getElementById('fallback-upload').style.display = 'block';
            document.querySelector('.calendar-controls').style.display = 'none';
            document.querySelector('.calendar-grid').style.display = 'none';
            document.querySelector('.report-section').style.display = 'none';
        }
    }

    function processManualFiles() {
        const tFile = document.getElementById('manualTrainsFile').files[0];
        const mFile = document.getElementById('manualSzlakiFile').files[0];
        if (!tFile || !mFile) return alert("Wybierz oba pliki!");

        const rT = new FileReader();
        const rM = new FileReader();
        let tOk = false, mOk = false;

        rT.onload = (e) => { trainsData = JSON.parse(e.target.result); tOk = true; check(); };
        rM.onload = (e) => { masterSzlakiData = JSON.parse(e.target.result); mOk = true; check(); };

        rT.readAsText(tFile);
        rM.readAsText(mFile);

        function check() {
            if (tOk && mOk) {
                document.getElementById('fallback-upload').style.display = 'none';
                document.querySelector('.calendar-controls').style.display = 'flex';
                document.querySelector('.calendar-grid').style.display = 'grid';
                document.querySelector('.report-section').style.display = 'block';
                initializeApp();
            }
        }
    }

    function initializeApp() {
        populateTrainSelect();
        renderCalendar();
        generateReport();
    }

    // --- OBS≈ÅUGA ICS (FIXED v1.4) ---
    function handleIcsUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                parseICS(e.target.result);
                saveLocalStorage();
                renderCalendar();
                alert("Grafik zaimportowany poprawnie!");
            } catch (err) {
                console.error(err);
                alert("B≈ÇƒÖd pliku ICS: " + err.message);
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    function parseICS(content) {
        // Resetujemy grafiki przy imporcie (lub mo≈ºna zrobiƒá merge)
        importedShifts = {}; 

        // Normalizacja ko≈Ñca linii
        const lines = content.replace(/\r\n/g, "\n").split("\n");
        
        let inEvent = false;
        let eventData = {};
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            if (line === "BEGIN:VEVENT") {
                inEvent = true;
                eventData = {};
                continue;
            }
            
            if (line === "END:VEVENT") {
                inEvent = false;
                if (eventData.summary && eventData.dtstart) {
                    processEvent(eventData);
                }
                continue;
            }
            
            if (inEvent) {
                if (line.startsWith("SUMMARY:")) eventData.summary = line.substring(8);
                // Obs≈Çuga dat z parametrami, np. DTSTART;VALUE=DATE:20251213
                else if (line.startsWith("DTSTART")) {
                    const parts = line.split(":");
                    eventData.dtstart = parts[parts.length - 1]; // warto≈õƒá po ostatnim dwukropku
                    if (line.includes("VALUE=DATE")) eventData.isAllDay = true;
                }
                else if (line.startsWith("DTEND")) {
                    const parts = line.split(":");
                    eventData.dtend = parts[parts.length - 1];
                }
            }
        }
    }

    function processEvent(data) {
        const parse = (str) => {
            if (!str) return null;
            // Format YYYYMMDD lub YYYYMMDDTHHMMSS
            const y = parseInt(str.substring(0,4));
            const m = parseInt(str.substring(4,6)) - 1;
            const d = parseInt(str.substring(6,8));
            
            if (str.includes("T")) {
                const t = str.split("T")[1];
                return new Date(y, m, d, parseInt(t.substring(0,2)), parseInt(t.substring(2,4)));
            }
            return new Date(y, m, d);
        };

        const start = parse(data.dtstart);
        let end = parse(data.dtend);
        
        if (!start) return;

        // Logika dla VALUE=DATE (wydarzenia ca≈Çodniowe)
        if (data.isAllDay) {
            // W ICS data ko≈Ñca dla all-day jest exclusive (+1 dzie≈Ñ).
            // Np. Start: 13, End: 14 -> to jest tylko 13-ty.
            // Ignorujemy datƒô End dla wy≈õwietlania na kalendarzu, traktujemy jako zdarzenie w dniu Start.
            // Je≈õli r√≥≈ºnica dni > 1, to wtedy wielodniowe.
            const dateKey = formatDateKey(start);
            addToShifts(dateKey, data.summary, false, "");
            return;
        }

        // Logika dla wydarze≈Ñ czasowych (T...)
        const dateKey = formatDateKey(start);
        let isOvernight = false;
        let timeInfo = "";

        if (end) {
            // Sprawdzenie nocki
            if (start.getDate() !== end.getDate()) {
                isOvernight = true;
            }
            const opts = {hour:'2-digit', minute:'2-digit'};
            timeInfo = `${start.toLocaleTimeString([], opts)} - ${end.toLocaleTimeString([], opts)}`;
        }

        addToShifts(dateKey, data.summary, isOvernight, timeInfo);
    }

    function addToShifts(dateKey, summary, isOvernight, timeInfo) {
        if (!importedShifts[dateKey]) importedShifts[dateKey] = [];
        
        // Unikaj duplikat√≥w
        const exists = importedShifts[dateKey].some(s => s.summary === summary);
        if (!exists) {
            importedShifts[dateKey].push({
                summary: summary,
                isOvernight: isOvernight,
                timeInfo: timeInfo
            });
        }
    }

    function formatDateKey(dateObj) {
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
        const d = String(dateObj.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    // --- KALENDARZ UI ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const display = document.getElementById('monthDisplay');
        grid.innerHTML = '';

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthNames = ["Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec", "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"];
        display.textContent = `${monthNames[month]} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const daysOfWeek = ["Pon", "Wt", "≈ör", "Czw", "Pt", "Sob", "Nd"];
        daysOfWeek.forEach(day => {
            const div = document.createElement('div');
            div.className = 'calendar-day-header';
            div.textContent = day;
            grid.appendChild(div);
        });

        let startDay = firstDayOfMonth === 0 ? 7 : firstDayOfMonth;
        
        for (let i = 1; i < startDay; i++) {
            const div = document.createElement('div');
            div.className = 'calendar-day empty';
            grid.appendChild(div);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const div = document.createElement('div');
            div.className = 'calendar-day';
            div.onclick = () => openDayModal(dateStr);

            const headerDiv = document.createElement('div');
            headerDiv.className = 'day-header';
            
            const numSpan = document.createElement('span');
            numSpan.className = 'day-number';
            numSpan.textContent = day;
            headerDiv.appendChild(numSpan);

            // RENDEROWANIE S≈ÅU≈ªB (ICS)
            const shiftsContainer = document.createElement('div');
            shiftsContainer.className = 'shifts-container';

            if (importedShifts[dateStr]) {
                const shifts = importedShifts[dateStr];
                shifts.forEach(shift => {
                    const badge = document.createElement('span');
                    badge.className = `shift-badge ${shift.isOvernight ? 'overnight' : ''}`;
                    let content = shift.summary;
                    if (shift.isOvernight) content += ' üåô';
                    badge.textContent = content;
                    if (shift.timeInfo) badge.title = shift.timeInfo;
                    shiftsContainer.appendChild(badge);
                });
            }
            headerDiv.appendChild(shiftsContainer);
            div.appendChild(headerDiv);

            // RENDEROWANIE POCIƒÑG√ìW
            if (userSchedule[dateStr]) {
                userSchedule[dateStr].forEach(entry => {
                    const train = trainsData.find(t => t.id == entry.trainId);
                    if (train) {
                        const badge = document.createElement('div');
                        badge.className = 'train-badge';
                        badge.textContent = `üöÇ ${train.number}`;
                        div.appendChild(badge);
                    }
                });
            }

            grid.appendChild(div);
        }
    }

    function changeMonth(offset) {
        currentDate.setMonth(currentDate.getMonth() + offset);
        renderCalendar();
    }

    // --- MODAL ---
    let selectedDate = null;

    function openDayModal(dateStr) {
        selectedDate = dateStr;
        document.getElementById('modalDateTitle').textContent = `Edycja dnia: ${dateStr}`;
        document.getElementById('dayModal').style.display = 'flex';
        document.getElementById('trainSelect').value = "";
        document.getElementById('routeSelectorContainer').style.display = 'none';
        renderExistingTrainsList();
    }

    function closeModal() {
        document.getElementById('dayModal').style.display = 'none';
        selectedDate = null;
    }

    function updateStationSelectors() {
        const trainId = document.getElementById('trainSelect').value;
        const container = document.getElementById('routeSelectorContainer');
        const startSelect = document.getElementById('startStation');
        const endSelect = document.getElementById('endStation');

        if (!trainId) { container.style.display = 'none'; return; }
        const train = trainsData.find(t => t.id == trainId);
        if (!train || !train.route) { container.style.display = 'none'; return; }

        const stations = [];
        if (train.route.start) stations.push(train.route.start);
        if (train.route.segments) {
            train.route.segments.forEach(seg => {
                if (!stations.includes(seg.from)) stations.push(seg.from);
                if (!stations.includes(seg.to)) stations.push(seg.to);
            });
        }

        startSelect.innerHTML = '';
        endSelect.innerHTML = '';
        stations.forEach(st => {
            const opt1 = document.createElement('option'); opt1.value = st; opt1.textContent = st; startSelect.appendChild(opt1);
            const opt2 = document.createElement('option'); opt2.value = st; opt2.textContent = st; endSelect.appendChild(opt2);
        });

        if (stations.length > 0) {
            startSelect.selectedIndex = 0;
            endSelect.selectedIndex = stations.length - 1;
        }
        container.style.display = 'block';
    }

    function addTrainToDay() {
        if (!selectedDate) return;
        const tId = document.getElementById('trainSelect').value;
        const sSt = document.getElementById('startStation').value;
        const eSt = document.getElementById('endStation').value;
        if (!tId || !sSt || !eSt) return alert("Uzupe≈Çnij dane!");

        if (!userSchedule[selectedDate]) userSchedule[selectedDate] = [];
        userSchedule[selectedDate].push({ trainId: tId, from: sSt, to: eSt });
        saveLocalStorage();
        renderExistingTrainsList();
        renderCalendar();
        generateReport();
    }

    function removeTrainFromDay(idx) {
        if (!userSchedule[selectedDate]) return;
        userSchedule[selectedDate].splice(idx, 1);
        if (userSchedule[selectedDate].length === 0) delete userSchedule[selectedDate];
        saveLocalStorage();
        renderExistingTrainsList();
        renderCalendar();
        generateReport();
    }

    function renderExistingTrainsList() {
        const container = document.getElementById('existingTrainsList');
        container.innerHTML = '';
        if (!userSchedule[selectedDate]) { container.innerHTML = '<p style="color:#888;">Brak pociƒÖg√≥w.</p>'; return; }

        userSchedule[selectedDate].forEach((entry, idx) => {
            const train = trainsData.find(t => t.id == entry.trainId);
            const div = document.createElement('div');
            div.className = 'train-list-item';
            div.innerHTML = `<div><strong>${train ? train.number : '???'}</strong> <small>${entry.from}‚ûî${entry.to}</small></div><button class="btn btn-danger" onclick="removeTrainFromDay(${idx})">X</button>`;
            container.appendChild(div);
        });
    }

    function populateTrainSelect() {
        const select = document.getElementById('trainSelect');
        select.innerHTML = '<option value="">-- Wybierz pociƒÖg --</option>';
        if(!trainsData) return;
        trainsData.sort((a,b) => a.number.localeCompare(b.number));
        trainsData.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.textContent = `${t.number} ${t.name || ''}`;
            select.appendChild(opt);
        });
    }

    // --- RAPORT (ZAAWANSOWANE PAROWANIE) ---
    function generateReport() {
        const tbody = document.querySelector('#reportTable tbody');
        tbody.innerHTML = '';
        const segmentsDriven = {};

        Object.keys(userSchedule).forEach(dateStr => {
            userSchedule[dateStr].forEach(entry => {
                const train = trainsData.find(t => t.id == entry.trainId);
                if (!train || !train.route || !train.route.segments) return;
                
                // Znajd≈∫ segmenty pociƒÖgu miƒôdzy Start a End wybranym przez u≈ºytkownika
                let capturing = false;
                for(let seg of train.route.segments) {
                    if (seg.from === entry.from) capturing = true;
                    if (capturing) {
                        matchAndSave(seg, dateStr);
                    }
                    if (seg.to === entry.to) {
                        capturing = false;
                        break;
                    }
                }
            });
        });

        function matchAndSave(seg, date) {
            const norm = s => s ? s.toLowerCase().trim() : "";
            const tF = norm(seg.from);
            const tT = norm(seg.to);

            const match = masterSzlakiData.find(m => {
                const mF = norm(m.start);
                const mT = norm(m.end);
                
                // ≈öCIS≈ÅE DOPASOWANIE STACJI (Zapobiega "Warszawa" == "Warszawa Zach")
                // MuszƒÖ byƒá identyczne po normalizacji
                const stationsMatch = (mF === tF && mT === tT) || (mF === tT && mT === tF);
                
                if(!stationsMatch) return false;

                // LU≈πNE DOPASOWANIE VIA (Tutaj includes jest OK)
                if(m.via && m.via !== "-" && m.via.length > 1) {
                    const mV = norm(m.via);
                    const tV = norm(seg.via);
                    return tV.includes(mV) || mV.includes(tV);
                }
                return true;
            });

            if (match) {
                if (!segmentsDriven[match.id] || date > segmentsDriven[match.id]) {
                    segmentsDriven[match.id] = date;
                }
            }
        }

        if(!masterSzlakiData.length) { tbody.innerHTML = '<tr><td colspan="5">Brak bazy szlak√≥w</td></tr>'; return; }

        masterSzlakiData.forEach((m, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center">${i+1}</td>
                <td>${m.start}</td>
                <td>${m.end}</td>
                <td>${m.via === '-' ? '' : m.via}</td>
                <td style="text-align:center; font-weight:bold">${segmentsDriven[m.id] || ""}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- ZAPIS ---
    function saveLocalStorage() {
        localStorage.setItem('kierownik_v1_data', JSON.stringify({ schedule: userSchedule, shifts: importedShifts }));
    }
    function loadLocalStorage() {
        const raw = localStorage.getItem('kierownik_v1_data');
        if (raw) {
            try {
                const d = JSON.parse(raw);
                if (d.schedule) userSchedule = d.schedule;
                if (d.shifts) importedShifts = d.shifts;
            } catch(e) {}
        }
    }
    function clearData() {
        if(confirm("UsunƒÖƒá wszystko?")) {
            userSchedule = {}; importedShifts = {};
            localStorage.removeItem('kierownik_v1_data');
            renderCalendar(); generateReport();
        }
    }
    window.onclick = function(e) { if(e.target == document.getElementById('dayModal')) closeModal(); }
</script>

</body>
</html>
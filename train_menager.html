<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Tras PociÄ…gÃ³w v1.6</title>
    <link rel="icon" type="image/svg+xml" href="favicon_trainmgr.svg">
    <link rel="apple-touch-icon" href="apple-touch-icon_trainmgr.png">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W05T4L1HFD');
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <style>
        :root {
            --primary-color: #0056b3;
            --accent-color: #ff9800;
            --bg-color: #f4f4f9;
            --text-color: #333;
            --border-radius: 8px;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 { margin: 0; padding-left: 20px; font-size: 1.5rem; }
        header .version { padding-right: 20px; font-size: 0.8rem; opacity: 0.8; }

        main {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 1024px) {
            main { grid-template-columns: 1fr; }
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; color: var(--primary-color); }
        h3 { margin-bottom: 10px; color: #555; }

        .form-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .form-group { margin-bottom: 15px; flex: 1; }

        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }

        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .calendar-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            background: #fff;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f1f1f1;
            padding: 10px;
            font-weight: bold;
        }

        .calendar-header button {
            width: auto;
            padding: 5px 10px;
            font-size: 1rem;
            background: white;
            color: #333;
            border: 1px solid #ccc;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
        }

        .calendar-day-header {
            background: #f8f9fa;
            text-align: center;
            padding: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #666;
        }

        .calendar-day {
            background: white;
            min-height: 40px;
            padding: 5px;
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .calendar-day:hover { background-color: #f0f8ff; }
        .calendar-day.empty { background-color: #fafafa; cursor: default; }
        .calendar-day.selected { background-color: var(--success-color); color: white; font-weight: bold; }
        .calendar-day.today { border: 2px solid var(--accent-color); }

        .dates-generator {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .weekdays-fieldset {
            border: none;
            padding: 0;
            margin: 5px 0 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .checkbox-label {
            font-weight: normal;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            background: white;
            padding: 3px 8px;
            border: 1px solid #ddd;
            border-radius: 12px;
        }
        .checkbox-label input { width: auto; margin: 0; }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { background-color: #004494; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        button.secondary { background-color: #6c757d; }
        button.accent { background-color: var(--accent-color); color: #fff; }
        button.danger { background-color: var(--danger-color); }

        #map { height: 400px; width: 100%; border-radius: var(--border-radius); z-index: 1; margin-bottom: 20px; }

        .scrollable-list {
            list-style: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .list-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .train-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .train-actions button {
            width: auto;
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .json-preview-container {
            position: relative;
            margin-top: 20px;
        }
        textarea#jsonOutput {
            font-family: monospace;
            font-size: 0.8rem;
            height: 150px;
            background: #2d2d2d;
            color: #50fa7b;
            resize: vertical;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: auto;
            padding: 5px 10px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
        }

        .status-msg {
            padding: 10px; margin-bottom: 10px; border-radius: 4px; display: none; font-size: 0.9rem;
        }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-success { background-color: #d4edda; color: #155724; }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 0.8rem;
            margin-top: auto;
        }
    </style>
</head>
<body>

<header>
    <h1>Generator Tras PociÄ…gÃ³w</h1>
    <div class="version">v1.6</div>
</header>

<main>
    <div class="panel">
        <h2>1. Dane PociÄ…gu</h2>
        <div id="status" class="status-msg"></div>

        <div id="file-upload-section" class="form-group">
             <label for="jsonFile" style="cursor:pointer; text-decoration: underline; font-size: 0.8rem; color: #666;">
                 (Opcjonalnie) Wgraj szlaki_master.json rÄ™cznie
             </label>
            <input type="file" id="jsonFile" accept=".json" style="display:none;">
        </div>

        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label for="trainCategory">Kategoria:</label>
                <select id="trainCategory">
                    <option value="TLK">TLK</option>
                    <option value="IC">IC</option>
                    <option value="EIC">EIC</option>
                    <option value="EIP">EIP</option>
                    <option value="REG">REG</option>
                    <option value="SKA">SKA</option>
                    <option value="KM">KM</option>
                    <option value="LKA">LKA</option>
                    <option value="KD">KD</option>
                    <option value="KÅš">KÅš</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="trainNumber">Numer:</label>
                <input type="text" id="trainNumber" placeholder="np. 12102">
            </div>
        </div>

        <div class="form-group">
            <label for="trainName">Nazwa PociÄ…gu:</label>
            <input type="text" id="trainName" placeholder="np. CHEÅMOÅƒSKI">
        </div>

        <div class="form-group">
            <label>Terminy kursowania:</label>
            
            <div class="dates-generator">
                <div class="form-row" style="margin-bottom: 5px;">
                    <div style="flex:1;">
                        <label style="font-weight:normal; font-size:0.8rem;">Od:</label>
                        <input type="date" id="dateFrom">
                    </div>
                    <div style="flex:1;">
                        <label style="font-weight:normal; font-size:0.8rem;">Do:</label>
                        <input type="date" id="dateTo">
                    </div>
                </div>
                
                <fieldset class="weekdays-fieldset">
                    <label class="checkbox-label"><input type="checkbox" name="wd" value="1" checked> Pn</label>
                    <label class="checkbox-label"><input type="checkbox" name="wd" value="2" checked> Wt</label>
                    <label class="checkbox-label"><input type="checkbox" name="wd" value="3" checked> Åšr</label>
                    <label class="checkbox-label"><input type="checkbox" name="wd" value="4" checked> Czw</label>
                    <label class="checkbox-label"><input type="checkbox" name="wd" value="5" checked> Pt</label>
                    <label class="checkbox-label"><input type="checkbox" name="wd" value="6" checked> Sb</label>
                    <label class="checkbox-label"><input type="checkbox" name="wd" value="0" checked> Nd</label>
                </fieldset>

                <button type="button" id="btnGenerateDates" class="secondary" style="font-size: 0.85rem; width:100%;">
                    Dodaj zakres do kalendarza
                </button>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button type="button" id="prevMonth">&lt;</button>
                    <span id="calendarTitle">StyczeÅ„ 2025</span>
                    <button type="button" id="nextMonth">&gt;</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                <span style="font-size:0.85rem;">Zaznaczone dni: <strong id="selectedCount">0</strong></span>
                <button type="button" id="btnClearDates" class="danger" style="width: auto; font-size: 0.7rem; padding: 2px 5px;">
                    WyczyÅ›Ä‡ wszystko
                </button>
            </div>
        </div>

        <h2>2. Konstruktor Trasy</h2>
        <div id="route-builder">
            <div class="form-group">
                <label for="startStation">Stacja PoczÄ…tkowa:</label>
                <select id="startStation" disabled>
                    <option value="">Wczytywanie danych...</option>
                </select>
            </div>
            <button id="btnStartRoute" disabled>Rozpocznij TrasÄ™</button>

            <div id="active-route-controls" style="display:none; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px;">
                <p>Aktualna stacja: <strong id="currentStationLabel" style="color: var(--primary-color);"></strong></p>
                <div class="form-group">
                    <label for="nextSegment">NastÄ™pny przystanek:</label>
                    <select id="nextSegment"><option value="">Wybierz...</option></select>
                </div>
                <div class="form-row">
                    <button id="btnAddSegment">Dodaj</button>
                    <button id="btnUndo" class="secondary">Cofnij</button>
                </div>
                <h3>Aktualny przebieg:</h3>
                <ul id="currentRouteList" class="scrollable-list" style="height: 150px;">
                    <li class="list-item" style="color: #777; justify-content: center;">Trasa pusta</li>
                </ul>
                <div style="margin-top: 15px;">
                    <button id="btnSaveToDB" class="accent">Zapisz pociÄ…g do bazy</button>
                    <button id="btnCancelRoute" class="danger" style="margin-top:5px;">Anuluj edycjÄ™</button>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>PodglÄ…d Mapy</h2>
        <div id="map"></div>

        <h2>3. Baza PociÄ…gÃ³w (PamiÄ™Ä‡)</h2>
        <div style="display:flex; flex-wrap: wrap; gap: 5px; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="display:flex; gap:5px;">
                <label for="importTrainsFile" class="secondary" style="cursor:pointer; padding: 5px 10px; border-radius:4px; font-size:0.75rem; background:#6c757d; color:white; font-weight:bold;">
                    Wczytaj trains.json
                </label>
                <input type="file" id="importTrainsFile" accept=".json" style="display:none;">
            </div>
            <button id="btnClearDB" class="danger" style="width: auto; padding: 5px 10px; font-size: 0.75rem;">WyczyÅ›Ä‡ bazÄ™</button>
        </div>

        <ul id="dbTrainList" class="scrollable-list">
            <li class="list-item" style="justify-content: center; color: #777;">Brak pociÄ…gÃ³w w bazie</li>
        </ul>

        <div class="json-preview-container">
            <label for="jsonOutput">PodglÄ…d pliku trains.json:</label>
            <button id="btnCopyJSON" class="copy-btn">Kopiuj Kod</button>
            <textarea id="jsonOutput" readonly></textarea>
        </div>
        <button id="btnDownloadJSON" class="secondary" style="margin-top: 10px;">Pobierz trains.json</button>
    </div>
</main>

<footer>
    WspÃ³Å‚autorzy: Gemini, Piotr M ðŸš‚ <br>
    Wersja aplikacji: v1.6
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    /**
     * Wersja aplikacji: v1.6
     * Changes: Added trains.json offline import functionality, UI improvements.
     */

    let map, routeLayerGroup;
    let graph = {};   
    let allStations = new Set();
    let editingId = null; 
    let currentRoute = []; 
    let currentStation = null;
    let selectedDates = new Set(); 
    let currentCalMonth = new Date().getMonth();
    let currentCalYear = new Date().getFullYear();
    let trainsDB = [];

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        loadLocalStorage(); 
        loadSzlakiData();   
        updateJSONPreview();
        setDefaultDates();
        renderCalendar();
    });

    function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateFrom').value = today;
    }

    function initMap() {
        map = L.map('map').setView([51.9194, 19.1451], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OSM' }).addTo(map);
        L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© ORM' }).addTo(map);
        routeLayerGroup = L.featureGroup().addTo(map);
    }

    // --- IMPORT TRAINS.JSON ---
    document.getElementById('importTrainsFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (!Array.isArray(importedData)) throw new Error("Format musi byÄ‡ tablicÄ… pociÄ…gÃ³w.");

                const mode = confirm("Czy chcesz dodaÄ‡ wczytane pociÄ…gi do obecnej bazy? \n(Kliknij 'Anuluj', aby zastÄ…piÄ‡ caÅ‚Ä… bazÄ™)");
                
                if (mode) {
                    // Dodawanie (z unikaniem duplikatÃ³w ID na wszelki wypadek)
                    importedData.forEach(t => {
                        const exists = trainsDB.some(old => old.id === t.id);
                        if (exists) t.id = Date.now() + Math.random(); 
                        trainsDB.push(t);
                    });
                    showStatus(`Dodano ${importedData.length} pociÄ…gÃ³w.`, 'success');
                } else {
                    trainsDB = importedData;
                    showStatus(`Wczytano ${importedData.length} pociÄ…gÃ³w (baza zastÄ…piona).`, 'success');
                }

                saveAndUpdate();
            } catch (err) {
                showStatus("BÅ‚Ä…d importu: " + err.message, 'error');
            }
            e.target.value = ""; // reset input
        };
        reader.readAsText(file);
    });

    // --- RESZTA LOGIKI (BEZ ZMIAN W DANYCH) ---
    async function loadSzlakiData() {
        try {
            const response = await fetch('./szlaki_master.json');
            if (response.ok) {
                const data = await response.json();
                buildGraph(data);
            } else { throw new Error(); }
        } catch (e) {
            showStatus("Brak szlaki_master.json online.", 'error');
            document.getElementById('file-upload-section').querySelector('input').style.display = 'block';
        }
    }

    document.getElementById('jsonFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { buildGraph(JSON.parse(e.target.result)); showStatus("Szlaki wczytane.", 'success'); } 
            catch (err) { showStatus("BÅ‚Ä…d JSON!", 'error'); }
        };
        reader.readAsText(file);
    });

    function buildGraph(data) {
        graph = {}; allStations = new Set();
        data.forEach(segment => {
            const { start, end, via, geometry } = segment;
            allStations.add(start); allStations.add(end);
            if (!graph[start]) graph[start] = [];
            if (!graph[end]) graph[end] = [];
            graph[start].push({ target: end, via: via, geometry: geometry });
            graph[end].push({ target: start, via: via, geometry: geometry }); 
        });
        populateStartDropdown();
        document.getElementById('btnStartRoute').disabled = false;
        document.getElementById('startStation').disabled = false;
    }

    function populateStartDropdown() {
        const select = document.getElementById('startStation');
        select.innerHTML = '<option value="">Wybierz stacjÄ™ poczÄ…tkowÄ…...</option>';
        Array.from(allStations).sort().forEach(st => {
            const opt = document.createElement('option'); opt.value = st; opt.textContent = st; select.appendChild(opt);
        });
    }

    // --- KALENDARZ ---
    const monthNames = ["StyczeÅ„", "Luty", "Marzec", "KwiecieÅ„", "Maj", "Czerwiec", "Lipiec", "SierpieÅ„", "WrzesieÅ„", "PaÅºdziernik", "Listopad", "GrudzieÅ„"];
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const title = document.getElementById('calendarTitle');
        grid.innerHTML = ""; title.textContent = `${monthNames[currentCalMonth]} ${currentCalYear}`;
        ["Pn", "Wt", "Åšr", "Cz", "Pt", "Sb", "Nd"].forEach(n => {
            const c = document.createElement('div'); c.className = 'calendar-day-header'; c.textContent = n; grid.appendChild(c);
        });
        const first = new Date(currentCalYear, currentCalMonth, 1);
        const days = new Date(currentCalYear, currentCalMonth + 1, 0).getDate();
        let start = first.getDay() - 1; if (start === -1) start = 6;
        for (let i = 0; i < start; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'calendar-day empty'}));
        for (let d = 1; d <= days; d++) {
            const dateStr = `${currentCalYear}-${(currentCalMonth+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const cell = document.createElement('div'); cell.className = 'calendar-day'; cell.textContent = d;
            if (selectedDates.has(dateStr)) cell.classList.add('selected');
            cell.onclick = () => { if(selectedDates.has(dateStr)) selectedDates.delete(dateStr); else selectedDates.add(dateStr); updateSelectedCount(); renderCalendar(); };
            grid.appendChild(cell);
        }
    }

    function updateSelectedCount() { document.getElementById('selectedCount').textContent = selectedDates.size; }
    document.getElementById('prevMonth').addEventListener('click', () => { currentCalMonth--; if(currentCalMonth<0){currentCalMonth=11;currentCalYear--;} renderCalendar(); });
    document.getElementById('nextMonth').addEventListener('click', () => { currentCalMonth++; if(currentCalMonth>11){currentCalMonth=0;currentCalYear++;} renderCalendar(); });

    document.getElementById('btnGenerateDates').addEventListener('click', () => {
        const dFrom = document.getElementById('dateFrom').value, dTo = document.getElementById('dateTo').value;
        const wds = Array.from(document.querySelectorAll('input[name="wd"]:checked')).map(cb => parseInt(cb.value));
        if (!dFrom || !dTo || wds.length === 0) return alert("BÅ‚Ä…d danych.");
        let cur = new Date(dFrom), end = new Date(dTo);
        while(cur <= end) { if(wds.includes(cur.getDay())) selectedDates.add(cur.toISOString().split('T')[0]); cur.setDate(cur.getDate()+1); }
        renderCalendar(); updateSelectedCount();
    });

    // --- TRASA ---
    document.getElementById('btnStartRoute').addEventListener('click', () => {
        const s = document.getElementById('startStation').value; if(!s) return;
        document.getElementById('btnStartRoute').disabled = true; document.getElementById('startStation').disabled = true;
        document.getElementById('active-route-controls').style.display = 'block';
        currentStation = s; updateCurrentRouteUI(); updateNextOptions();
    });

    function updateNextOptions() {
        const sel = document.getElementById('nextSegment'); sel.innerHTML = '<option value="">Wybierz...</option>';
        (graph[currentStation] || []).forEach((c, i) => {
            const opt = document.createElement('option'); opt.value = i; opt.text = `${c.target} (${c.via})`; sel.add(opt);
        });
    }

    document.getElementById('btnAddSegment').addEventListener('click', () => {
        const idx = document.getElementById('nextSegment').value; if(idx==="") return;
        const conn = graph[currentStation][idx];
        currentRoute.push({ from: currentStation, to: conn.target, via: conn.via });
        if(conn.geometry) L.geoJSON(conn.geometry, {style:{color:'blue',weight:4}}).addTo(routeLayerGroup);
        currentStation = conn.target; updateNextOptions(); updateCurrentRouteUI();
    });

    document.getElementById('btnUndo').addEventListener('click', () => {
        if(currentRoute.length===0) return;
        currentStation = currentRoute.pop().from;
        routeLayerGroup.clearLayers();
        currentRoute.forEach(s => {
            const c = graph[s.from].find(x => x.target===s.to && x.via===s.via);
            if(c && c.geometry) L.geoJSON(c.geometry, {style:{color:'blue',weight:4}}).addTo(routeLayerGroup);
        });
        updateNextOptions(); updateCurrentRouteUI();
    });

    function updateCurrentRouteUI() {
        document.getElementById('currentStationLabel').textContent = currentStation;
        const ul = document.getElementById('currentRouteList'); ul.innerHTML = '';
        if(currentRoute.length===0) ul.innerHTML = `<li class="list-item">Start: <b>${currentStation}</b></li>`;
        else {
            ul.innerHTML = `<li class="list-item">Start: <b>${currentRoute[0].from}</b></li>`;
            currentRoute.forEach(s => ul.innerHTML += `<li class="list-item">â†“ ${s.to} (${s.via})</li>`);
        }
    }

    function resetRouteEditor() {
        currentRoute = []; currentStation = null; editingId = null; selectedDates.clear();
        routeLayerGroup.clearLayers(); document.getElementById('active-route-controls').style.display = 'none';
        document.getElementById('btnStartRoute').disabled = false; document.getElementById('startStation').disabled = false;
        document.getElementById('trainNumber').value = ""; document.getElementById('trainName').value = "";
        renderCalendar(); updateSelectedCount();
    }

    // --- BAZA ---
    document.getElementById('btnSaveToDB').addEventListener('click', () => {
        const cat = document.getElementById('trainCategory').value, num = document.getElementById('trainNumber').value, name = document.getElementById('trainName').value;
        if(!num || !name || currentRoute.length===0 || selectedDates.size===0) return alert("Braki w danych!");
        const train = { id: editingId || Date.now(), category: cat, number: num, name: name, dates: Array.from(selectedDates).sort(), route: { start: currentRoute[0].from, end: currentRoute[currentRoute.length-1].to, segments: [...currentRoute] } };
        if(editingId) { const i = trainsDB.findIndex(t=>t.id===editingId); trainsDB[i]=train; } else trainsDB.push(train);
        saveAndUpdate(); resetRouteEditor(); showStatus("Zapisano!", 'success');
    });

    function renderTrainDBList() {
        const ul = document.getElementById('dbTrainList'); ul.innerHTML = trainsDB.length ? '' : '<li class="list-item">Brak pociÄ…gÃ³w</li>';
        trainsDB.forEach((t, i) => {
            const li = document.createElement('li'); li.className = 'list-item';
            li.innerHTML = `<div><strong>${t.category} ${t.number}</strong> "${t.name}"<br><small>${t.route.start} â†’ ${t.route.end}</small></div>
            <div class="train-actions"><button onclick="editTrain(${i})">âœŽ</button><button onclick="deleteTrain(${i})" class="danger">âœ•</button></div>`;
            ul.appendChild(li);
        });
    }

    window.editTrain = function(i) {
        const t = trainsDB[i];
        document.getElementById('trainCategory').value = t.category; document.getElementById('trainNumber').value = t.number; document.getElementById('trainName').value = t.name;
        editingId = t.id; selectedDates = new Set(t.dates); currentRoute = [...t.route.segments];
        document.getElementById('startStation').value = t.route.start;
        document.getElementById('active-route-controls').style.display = 'block';
        currentStation = t.route.end; routeLayerGroup.clearLayers();
        currentRoute.forEach(s => {
            const c = graph[s.from]?.find(x => x.target===s.to && x.via===s.via);
            if(c?.geometry) L.geoJSON(c.geometry, {style:{color:'blue',weight:4}}).addTo(routeLayerGroup);
        });
        updateCurrentRouteUI(); updateNextOptions(); renderCalendar(); updateSelectedCount();
    }

    window.deleteTrain = (i) => { if(confirm("UsunÄ…Ä‡?")) { trainsDB.splice(i,1); saveAndUpdate(); } };
    function saveAndUpdate() { localStorage.setItem('savedTrains', JSON.stringify(trainsDB)); renderTrainDBList(); updateJSONPreview(); }
    function loadLocalStorage() { const s = localStorage.getItem('savedTrains'); if(s) { trainsDB = JSON.parse(s); renderTrainDBList(); } }
    function updateJSONPreview() { document.getElementById('jsonOutput').value = JSON.stringify(trainsDB, null, 2); }
    document.getElementById('btnCopyJSON').onclick = () => { navigator.clipboard.writeText(document.getElementById('jsonOutput').value); showStatus("Skopiowano!", "success"); };
    document.getElementById('btnDownloadJSON').onclick = () => {
        const b = new Blob([document.getElementById('jsonOutput').value], {type:'application/json'});
        const u = URL.createObjectURL(b); const a = document.createElement('a');
        a.href=u; a.download='trains.json'; a.click();
    };

    function showStatus(m, t) {
        const e = document.getElementById('status'); e.textContent = m; e.className = `status-msg status-${t}`; e.style.display = 'block';
        setTimeout(() => e.style.display = 'none', 4000);
    }
</script>
</body>
</html>
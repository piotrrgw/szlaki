<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAIN MANAGER v8.0</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W05T4L1HFD');
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border: 1px solid #e2e8f0; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer; background: white; transition: all 0.1s; }
        .day-active { background: #3b82f6; color: white; font-weight: 600; }
        .day-inactive { background: #f8fafc; color: #cbd5e1; }
        #map { z-index: 1; isolation: isolate; }
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 text-white h-14 flex items-center justify-between px-4 shrink-0 shadow-md z-50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 w-8 h-8 rounded flex items-center justify-center font-bold shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-train-track"></i>
            </div>
            <h1 class="font-bold text-lg tracking-wide">TRAIN MANAGER <span class="text-slate-500 text-xs font-normal">v8.0</span></h1>
            <div class="h-6 w-px bg-slate-700 mx-2"></div>
            <div class="text-xs text-slate-400 flex gap-3 font-mono">
                <span id="stat-szlaki" class="text-red-400"><i class="fa-solid fa-database mr-1"></i>Szlaki: <span id="count-segments">0</span></span>
                <span id="stat-pociagi" class="text-blue-400"><i class="fa-solid fa-list mr-1"></i>Pocigi: <span id="count-trains">0</span></span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="document.getElementById('file-input-szlaki').click()" class="bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1.5 rounded transition border border-slate-700 text-red-300">
                <i class="fa-solid fa-upload mr-1"></i> Szlaki
            </button>
            <button onclick="document.getElementById('file-input-pociagi').click()" class="bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1.5 rounded transition border border-slate-700 text-blue-300">
                <i class="fa-solid fa-upload mr-1"></i> Pocigi
            </button>
            <button onclick="downloadData()" class="w-8 h-8 flex items-center justify-center bg-green-600 hover:bg-green-500 rounded text-white transition shadow-lg shadow-green-900/20" title="Pobierz Pocigi">
                <i class="fa-solid fa-download"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col shrink-0 z-20 shadow-sm relative">
            <div class="p-3 border-b border-slate-100 bg-white z-10">
                <button onclick="addNewTrain()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded shadow-sm shadow-blue-200 text-sm font-semibold transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> Nowy Pocig
                </button>
                <input type="text" id="search-input" onkeyup="renderTrainList()" placeholder="Szukaj pocigu..." class="mt-2 w-full bg-slate-50 border border-slate-200 rounded py-1.5 px-3 text-xs outline-none focus:border-blue-400">
            </div>

            <div id="train-list" class="flex-1 overflow-y-auto p-0">
                </div>
            
            <div class="p-2 border-t border-slate-100 text-center text-[10px] text-slate-400 bg-slate-50 flex flex-col gap-1">
                <span>Wersja aplikacji: v8.0</span>
                <span>Autorzy: Piotr M  & Gemini</span>
                <span>&bull; OpenRailwayMap &bull;</span>
                <div id="memory-usage" class="mt-1 text-blue-400 font-mono">Mem: OK</div>
            </div>
        </aside>

        <main class="flex-1 bg-slate-50 flex flex-col relative overflow-hidden">
            <div id="map" class="h-1/2 w-full border-b border-slate-200"></div>

            <div id="editor-panel" class="flex-1 bg-white flex flex-col overflow-hidden">
                <div class="border-b border-slate-200 px-4 h-10 flex items-center justify-between bg-slate-50">
                    <span class="text-xs font-bold text-slate-500 uppercase">Edytor Danych</span>
                    <button onclick="saveCurrentTrain()" class="text-xs text-blue-600 font-bold hover:underline">Zapisz zmiany (lokalne)</button>
                </div>
                
                <div class="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-400">Numer</label>
                            <input type="text" id="inp-numer" class="w-full border border-slate-300 rounded p-2 text-sm font-mono font-bold">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-400">Nazwa</label>
                            <input type="text" id="inp-nazwa" class="w-full border border-slate-300 rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-400">Tabor</label>
                            <select id="inp-tabor" class="w-full border border-slate-300 rounded p-2 text-sm">
                                <option value="ED160">ED160</option>
                                <option value="ED161">ED161</option>
                                <option value="ED250">ED250</option>
                                <option value="Wagonowy">Skad Wagonowy</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex flex-col h-full">
                        <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Struktura Trasy (JSON)</label>
                        <textarea id="inp-trasa-json" class="w-full flex-1 border border-slate-300 rounded p-2 text-xs font-mono bg-slate-50" placeholder='[{"master_id": 1}, ...]'></textarea>
                        <button onclick="parseRouteJson()" class="mt-2 text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded">Odwie偶 Map z JSON</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="file-input-szlaki" accept=".json" class="hidden" onchange="loadSzlaki(this)">
    <input type="file" id="file-input-pociagi" accept=".json" class="hidden" onchange="loadPociagi(this)">

    <script>
        // --- ZMIENNE GLOBALNE ---
        let map;
        let routeLayer;
        let trainsData = [];
        let szlakiData = []; // Baza geometrii
        let activeTrainId = null;

        // --- INICJALIZACJA ---
        window.onload = function() {
            map = L.map('map').setView([52.0, 19.0], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            routeLayer = L.featureGroup().addTo(map);
        };

        // --- OBSUGA PLIKW ---
        function loadSzlaki(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    szlakiData = JSON.parse(e.target.result);
                    document.getElementById('count-segments').innerText = szlakiData.length;
                    alert(`Zaadowano ${szlakiData.length} odcink贸w tras.`);
                    if(activeTrainId !== null) drawRoute(); // Odwie偶 map jeli pocig wybrany
                } catch(err) { alert("Bd pliku szlak贸w: " + err); }
            };
            reader.readAsText(file);
        }

        function loadPociagi(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    trainsData = JSON.parse(e.target.result);
                    document.getElementById('count-trains').innerText = trainsData.length;
                    renderTrainList();
                } catch(err) { alert("Bd pliku pocig贸w: " + err); }
            };
            reader.readAsText(file);
        }

        // --- UI LOGIKA ---
        function renderTrainList() {
            const list = document.getElementById('train-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            list.innerHTML = '';
            
            trainsData.forEach((t, index) => {
                if(t.numer.toLowerCase().includes(search) || t.nazwa.toLowerCase().includes(search)) {
                    const div = document.createElement('div');
                    div.className = "p-3 border-b border-slate-100 hover:bg-blue-50 cursor-pointer transition text-sm";
                    div.innerHTML = `<strong>${t.numer}</strong> <span class="text-slate-500 text-xs">${t.nazwa}</span>`;
                    div.onclick = () => loadTrainToEditor(index);
                    list.appendChild(div);
                }
            });
        }

        function loadTrainToEditor(index) {
            activeTrainId = index;
            const t = trainsData[index];
            
            document.getElementById('inp-numer').value = t.numer || "";
            document.getElementById('inp-nazwa').value = t.nazwa || "";
            document.getElementById('inp-tabor').value = t.tabor || "ED160";
            document.getElementById('inp-trasa-json').value = JSON.stringify(t.trasa || [], null, 2);
            
            drawRoute();
        }

        function addNewTrain() {
            const newTrain = { numer: "NOWY", nazwa: "Pocig", trasa: [] };
            trainsData.unshift(newTrain);
            renderTrainList();
            loadTrainToEditor(0);
        }

        function parseRouteJson() {
            if (activeTrainId === null) return;
            try {
                const newRoute = JSON.parse(document.getElementById('inp-trasa-json').value);
                trainsData[activeTrainId].trasa = newRoute;
                drawRoute();
            } catch (e) {
                alert("Bd skadni JSON trasy!");
            }
        }

        // --- POPRAWIONA FUNKCJA RYSOWANIA (v8.0 FIX) ---
        function drawRoute() {
            routeLayer.clearLayers();
            if (activeTrainId === null || !trainsData[activeTrainId].trasa) return;

            const trasa = trainsData[activeTrainId].trasa;
            const latlngs = [];
            let missingSegments = 0;

            trasa.forEach((item, index) => {
                // Szukanie geometrii po ID w bazie szlak贸w
                // Obsuguje zar贸wno string ID jak i number ID
                const segment = szlakiData.find(s => s.id == item.master_id);

                if (segment && segment.geometry && segment.geometry.coordinates) {
                    // Konwersja GeoJSON [lon, lat] -> Leaflet [lat, lon]
                    const segmentLatLngs = segment.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    L.polyline(segmentLatLngs, { color: '#2563eb', weight: 4, opacity: 0.8 }).addTo(routeLayer);
                    latlngs.push(...segmentLatLngs);
                } else {
                    console.warn(`Brakujcy segment ID: ${item.master_id} w pozycji ${index}`);
                    missingSegments++;
                }
            });

            if (latlngs.length > 0) {
                map.fitBounds(latlngs, { padding: [50, 50] });
            }

            if (missingSegments > 0) {
                console.error(`Pocig ma ${missingSegments} brakujcych odcink贸w w bazie szlak贸w.`);
            }
        }

        function saveCurrentTrain() {
            if(activeTrainId !== null) {
                trainsData[activeTrainId].numer = document.getElementById('inp-numer').value;
                trainsData[activeTrainId].nazwa = document.getElementById('inp-nazwa').value;
                trainsData[activeTrainId].tabor = document.getElementById('inp-tabor').value;
                parseRouteJson(); // Zapisuje te偶 JSON trasy
                renderTrainList();
                alert("Zapisano zmiany w pamici lokalnej (nie zapomnij pobra pliku!)");
            }
        }

        function downloadData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(trainsData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "pociagi_v8.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrolka Szlak贸w - Raport Miesiczny</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W05T4L1HFD');
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body {
            background-color: #f8f9fa;
            color: #212529;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 80px;
        }
        .container { max-width: 1000px; }
        
        .control-panel {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .table-responsive {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        th { background-color: #343a40; color: #ffffff; }
        
        /* Wiersz zaktualizowany */
        .row-updated { 
            background-color: #d1e7dd !important; 
            transition: background-color 0.5s; 
        }
        
        /* Mapa */
        #map { height: 400px; width: 100%; border-radius: 4px; }

        .app-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #343a40;
            color: #ffffff;
            text-align: center;
            padding: 10px 0;
            font-size: 0.9rem;
            z-index: 1000;
        }
        .footer-version { font-size: 0.8rem; opacity: 0.8; }

        /* DRUKOWANIE */
        @media print {
            body { background-color: white; padding: 0; margin: 0; }
            .control-panel, .app-footer, .btn, .modal, .bi-map, .memory-counter, .d-print-none { display: none !important; }
            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
            .table-responsive { box-shadow: none; border: none; overflow: visible; }
            table { width: 100% !important; border-collapse: collapse; font-size: 11px; }
            th, td { border: 1px solid black !important; padding: 2px 4px !important; color: black !important; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
            .row-updated { background-color: white !important; }
            
            #printHeader {
                display: block !important;
                margin-bottom: 15px;
                text-align: center;
                border-bottom: 2px solid black;
                padding-bottom: 10px;
            }
            input[type="date"] {
                border: none;
                background: transparent;
                padding: 0;
                font-family: inherit;
                color: black;
                width: auto;
                text-align: right;
                font-size: 11px;
            }
            input[type="date"]::-webkit-calendar-picker-indicator { display: none; }
        }
        
        #printHeader { display: none; }
    </style>
</head>
<body>

<div class="container mt-4">
    <div id="printHeader">
        <h2>Karta Znajomoci Szlak贸w</h2>
        <div class="d-flex justify-content-between mt-3 px-5">
            <span>Imi i Nazwisko: ........................................................</span>
            <span>Miesic: ......................... Rok: .................</span>
        </div>
    </div>

    <header class="mb-4 text-center d-print-none">
        <h1>Kontrolka Szlak贸w</h1>
        <p class="lead">Narzdzie raportowania (Smart Match v1.2)</p>
    </header>

    <div class="control-panel d-print-none">
        <h2 class="h5 mb-3">Rejestracja Przejazdu</h2>
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="inputDate" class="form-label">Data przejazdu</label>
                <input type="date" id="inputDate" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="inputTrain" class="form-label">Numer pocigu</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-train-front"></i></span>
                    <input type="text" id="inputTrain" class="form-control" placeholder="np. 1000">
                </div>
            </div>
            <div class="col-md-5">
                <button class="btn btn-primary w-100" id="btnSearchTrain">
                    <i class="bi bi-search"></i> Znajd藕 tras (Smart Match)
                </button>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="d-flex justify-content-between align-items-center">
            <div class="memory-counter text-muted small" id="memoryUsage">Pami: ...</div>
            <div>
                <button class="btn btn-outline-danger btn-sm me-2" id="btnClearData">Reset</button>
                <button class="btn btn-success btn-sm" onclick="window.print()">
                    <i class="bi bi-printer"></i> Drukuj
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle mb-0" id="routesTable">
            <thead class="table-dark">
                <tr>
                    <th class="text-center" style="width: 50px;">ID</th>
                    <th>Odcinek (Od - Do)</th>
                    <th>Przez (Via)</th>
                    <th class="text-center" style="width: 50px;">Mapa</th>
                    <th style="width: 150px;">Data ost. przejazdu</th>
                </tr>
            </thead>
            <tbody id="routesTableBody">
                <tr><td colspan="5" class="text-center py-4">adowanie danych...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="trainSegmentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Trasa Pocigu (Wykryte Szlaki)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light border" id="modalTrainInfo"></div>
                <div class="list-group" id="modalSegmentsList"></div>
                <div class="mt-2 text-muted small fst-italic">
                    * Szlaki zostay dopasowane na podstawie nazw stacji, ignorujc bdne ID w bazie pocig贸w.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="btnConfirmSegments">Zatwierd藕 Przejazd</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalTitle">Podgld Szlaku</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<footer class="app-footer">
    <div class="container">
        <span>Wsp贸autorzy: Gemini oraz Piotr M </span>
        <div class="footer-version">Wersja aplikacji: v1.2</div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    /**
     * Wersja kodu: 1.2 (2025-12-29)
     * Zmiany: Dodano "Smart Matching" - ignorowanie master_id z pociagi.json na rzecz parowania po nazwach stacji.
     */

    const STORAGE_KEY = 'kontrolka_szlakow_v1';
    let szlakiData = [];
    let pociagiData = [];
    let mapInstance = null;

    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('inputDate').valueAsDate = new Date();
        
        try {
            const [szlakiRes, pociagiRes] = await Promise.all([
                fetch('szlaki_master.json'),
                fetch('pociagi.json')
            ]);

            if (!szlakiRes.ok || !pociagiRes.ok) throw new Error("Bd wczytywania plik贸w JSON");

            szlakiData = await szlakiRes.json();
            pociagiData = await pociagiRes.json();
            
            szlakiData.sort((a, b) => a.id - b.id);
            renderTable();
            updateMemoryUsage();
        } catch (e) {
            console.error(e);
            document.getElementById('routesTableBody').innerHTML = `<tr class="table-danger"><td colspan="5" class="text-center">Bd: Brak plik贸w JSON. Upewnij si, 偶e s w folderze.</td></tr>`;
        }
    });

    function renderTable() {
        const tbody = document.getElementById('routesTableBody');
        tbody.innerHTML = '';
        const savedData = getSavedData();

        szlakiData.forEach(route => {
            const tr = document.createElement('tr');
            tr.dataset.id = route.id;
            
            const savedDate = savedData[route.id] || '';
            if (savedDate) tr.classList.add('row-updated');

            const hasGeo = (route.geometry || route.coordinates);
            const mapBtn = `<button class="btn btn-sm btn-light border" 
                onclick="showMap(${route.id})" ${hasGeo ? '' : 'disabled'} title="Poka偶 na mapie">
                <i class="bi bi-map"></i></button>`;

            tr.innerHTML = `
                <td class="text-center fw-bold small">${route.id}</td>
                <td>${route.start} - ${route.end}</td>
                <td class="small text-muted">${route.via !== '-' ? route.via : ''}</td>
                <td class="text-center">${mapBtn}</td>
                <td>
                    <input type="date" class="form-control form-control-sm date-input shadow-none" 
                           value="${savedDate}" 
                           onchange="manualDateUpdate(${route.id}, this.value)">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- SMART MATCHING LOGIC ---
    document.getElementById('btnSearchTrain').addEventListener('click', () => {
        const query = document.getElementById('inputTrain').value.trim().replace(/\s/g, '').toLowerCase();
        if (!query) return alert('Wpisz numer pocigu.');

        const train = pociagiData.find(p => p.numer.toString().toLowerCase().replace(/\s/g, '').includes(query));

        if (!train) return alert('Nie znaleziono pocigu.');
        
        openSegmentModal(train);
    });

    function openSegmentModal(train) {
        const list = document.getElementById('modalSegmentsList');
        const info = document.getElementById('modalTrainInfo');
        list.innerHTML = '';

        info.innerHTML = `<strong>${train.numer}</strong> (${train.relacja_od} &rarr; ${train.relacja_do})`;
        
        if (!train.trasa || train.trasa.length === 0) {
            list.innerHTML = '<div class="text-danger p-3">Brak trasy w bazie.</div>';
            return;
        }

        train.trasa.forEach((segment, idx) => {
            // TUTAJ JEST KLUCZOWA ZMIANA:
            // Zamiast ufa segment.master_id (kt贸re jest bdne w pociagi.json),
            // szukamy szlaku w szlakiData, kt贸ry pasuje nazwami stacji.
            
            const segOd = segment.od.trim().toLowerCase();
            const segDo = segment.do.trim().toLowerCase();
            
            // Szukamy w obie strony (A->B lub B->A)
            const matchedRoute = szlakiData.find(master => {
                const mStart = master.start.trim().toLowerCase();
                const mEnd = master.end.trim().toLowerCase();
                return (mStart === segOd && mEnd === segDo) || (mStart === segDo && mEnd === segOd);
            });

            let label = `${segment.od} - ${segment.do}`;
            let value = "";
            let isDisabled = "";
            let isChecked = "checked";
            let badge = "";

            if (matchedRoute) {
                // Znaleziono prawdziwy szlak!
                value = matchedRoute.id;
                label = `<strong>[ID ${matchedRoute.id}]</strong> ${matchedRoute.start} - ${matchedRoute.end}`;
                if (matchedRoute.via && matchedRoute.via !== '-') {
                    label += ` <small class="text-muted">przez ${matchedRoute.via}</small>`;
                }
            } else {
                // Nie znaleziono dopasowania w masterze
                badge = '<span class="badge bg-danger ms-2">Bd danych</span>';
                isDisabled = "disabled";
                isChecked = "";
                label += " (Nie znaleziono w Szlaki Master)";
            }

            const item = document.createElement('label');
            item.className = `list-group-item d-flex align-items-center gap-3 ${isDisabled ? 'bg-light text-muted' : ''}`;
            item.innerHTML = `
                <input class="form-check-input flex-shrink-0" type="checkbox" value="${value}" ${isChecked} ${isDisabled} style="transform: scale(1.3);">
                <span>${label} ${badge}</span>
            `;
            list.appendChild(item);
        });

        new bootstrap.Modal(document.getElementById('trainSegmentsModal')).show();
    }

    // --- Reszta logiki bez zmian ---

    document.getElementById('btnConfirmSegments').addEventListener('click', () => {
        const inputDate = document.getElementById('inputDate').value;
        if (!inputDate) return alert("Wybierz dat.");

        const checkboxes = document.querySelectorAll('#modalSegmentsList input:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value)).filter(id => !isNaN(id));

        if (ids.length === 0) return alert("Brak wybranych poprawnych szlak贸w.");

        const savedData = getSavedData();
        let count = 0;

        ids.forEach(id => {
            const current = savedData[id];
            // Nadpisz tylko jeli nowa data jest nowsza lub brak starej
            if (!current || new Date(inputDate) >= new Date(current)) {
                savedData[id] = inputDate;
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) {
                    row.querySelector('.date-input').value = inputDate;
                    row.classList.add('row-updated');
                }
                count++;
            }
        });

        saveData(savedData);
        bootstrap.Modal.getInstance(document.getElementById('trainSegmentsModal')).hide();
        
        if(count === 0) alert("Brak zmian - istniejce daty s nowsze.");
    });

    window.manualDateUpdate = function(id, date) {
        const savedData = getSavedData();
        if (date) {
            savedData[id] = date;
            document.querySelector(`tr[data-id="${id}"]`).classList.add('row-updated');
        } else {
            delete savedData[id];
            document.querySelector(`tr[data-id="${id}"]`).classList.remove('row-updated');
        }
        saveData(savedData);
    };

    window.showMap = function(id) {
        const route = szlakiData.find(r => r.id === id);
        if (!route || !route.geometry) return;

        const modalEl = document.getElementById('mapModal');
        const title = document.getElementById('mapModalTitle');
        title.textContent = `Szlak ${route.id}: ${route.start} - ${route.end}`;
        
        const bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();

        modalEl.addEventListener('shown.bs.modal', () => {
            if (mapInstance) mapInstance.remove();
            mapInstance = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OSM'
            }).addTo(mapInstance);

            const layer = L.geoJSON(route.geometry, {
                style: { color: '#0d6efd', weight: 5 }
            }).addTo(mapInstance);
            mapInstance.fitBounds(layer.getBounds());
        }, { once: true });
    };

    function getSavedData() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    function saveData(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); updateMemoryUsage(); }
    
    document.getElementById('btnClearData').addEventListener('click', () => {
        if(confirm("Usun wszystkie dane?")) {
            localStorage.removeItem(STORAGE_KEY);
            renderTable();
            updateMemoryUsage();
        }
    });

    function updateMemoryUsage() {
        let total = 0;
        for(let key in localStorage) {
            if(localStorage.hasOwnProperty(key)) total += (localStorage[key].length + key.length) * 2;
        }
        document.getElementById('memoryUsage').innerText = `Pami: ${(total/1024).toFixed(2)} KB`;
    }
</script>

</body>
</html>
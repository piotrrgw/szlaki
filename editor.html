<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - Baza PociÄ…gÃ³w (RJ)</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script> 
    <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-W05T4L1HFD'); </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }
        #container { display: flex; height: 100vh; overflow: hidden; }

        /* LEWY PANEL - FORMULARZ I EDYCJA */
        #editor-panel {
            width: 450px;
            background: white;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 10;
            overflow-y: auto;
        }

        /* PRAWY PANEL - MAPA I PODGLÄ„D BAZY */
        #preview-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        h2, h3 { margin-top: 0; color: #2c3e50; }
        .section-title { font-size: 0.85rem; text-transform: uppercase; color: #888; font-weight: bold; margin-bottom: 5px; margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;}

        /* FORMULARZE */
        .form-row { margin-bottom: 10px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 3px; color: #555; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        input:focus { border-color: #007bff; outline: none; }

        /* SELECTOR SZLAKÃ“W */
        #segment-selector {
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 150px;
            overflow-y: auto;
            background: #fafafa;
            margin-top: 5px;
        }
        .segment-option {
            padding: 6px 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.85rem; display: flex; justify-content: space-between;
        }
        .segment-option:hover { background: #e9ecef; }
        .segment-option .add-icon { color: green; font-weight: bold; }

        /* LISTA WYBRANYCH (AKTUALNY PRZEBIEG) */
        #current-route-list {
            min-height: 100px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
            margin-top: 5px;
        }
        .route-item {
            background: #e3f2fd;
            padding: 5px 8px;
            margin-bottom: 4px;
            border-radius: 3px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remove-btn { color: red; cursor: pointer; font-weight: bold; margin-left: 10px; }

        /* PRZYCISKI */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add { background: #28a745; color: white; } /* Zielony */
        .btn-add:hover { background: #218838; }
        .btn-clear { background: #6c757d; color: white; }
        .btn-export { background: #007bff; color: white; width: auto; padding: 10px 20px;}

        /* TABELA BAZY DANYCH (NA DOLE) */
        #database-view {
            height: 250px; /* StaÅ‚a wysokoÅ›Ä‡ na dole */
            background: #fff;
            border-top: 2px solid #ccc;
            padding: 10px;
            overflow-y: auto;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
        tr:nth-child(even) { background: #f9f9f9; }

        /* MAPA */
        #map { flex-grow: 1; width: 100%; }
        
        .footer { font-size: 0.7rem; color: #aaa; margin-top: 20px; text-align: center; }
    </style>
</head>
<body>

<div id="container">
    <div id="editor-panel">
        <h2>Nowy PociÄ…g</h2>
        
        <div class="section-title">1. Metadane</div>
        <div class="form-row">
            <label>Numer pociÄ…gu / Nazwa</label>
            <input type="text" id="trainNr" placeholder="np. IC 1234 MAZURY">
        </div>
        <div class="form-row">
            <label>RozkÅ‚ad Jazdy (RJ)</label>
            <input type="text" id="trainRJ" value="2025/2026 ZRJ1">
        </div>
        <div class="form-row">
            <label>Uwagi</label>
            <textarea id="trainNotes" rows="2" placeholder="np. Kursuje w (D), zmiana czoÅ‚a w..."></textarea>
        </div>
        <div class="form-row" style="display:flex; gap:10px;">
            <div style="flex:1">
                <label>WprowadzajÄ…cy</label>
                <input type="text" id="trainAuthor" value="Piotr M">
            </div>
            <div style="flex:1">
                <label>Data wprowadzenia</label>
                <input type="date" id="trainDate">
            </div>
        </div>

        <div class="section-title">2. Przebieg trasy (Szlaki)</div>
        <input type="text" id="searchBox" placeholder="Szukaj szlaku (np. Koluszki)..." onkeyup="filterSegments()">
        
        <div id="segment-selector">
            </div>

        <div style="margin-top:10px; font-size:0.8rem; font-weight:bold;">Aktualna trasa (kolejnoÅ›Ä‡):</div>
        <div id="current-route-list">
            <div style="color:#999; text-align:center; padding:10px;">Brak wybranych szlakÃ³w</div>
        </div>

        <div class="btn-group">
            <button class="btn-clear" onclick="clearForm()">WyczyÅ›Ä‡</button>
            <button class="btn-add" onclick="addTrainToDB()">âž• DODAJ DO BAZY</button>
        </div>

        <div class="footer">
            Admin Panel | WspÃ³Å‚autorzy: Gemini & Piotr M ðŸš‚
        </div>
    </div>

    <div id="preview-panel">
        <div style="position:absolute; top:10px; right:10px; z-index:1000; background:white; padding:10px; border-radius:4px; box-shadow:0 0 5px rgba(0,0,0,0.2);">
            <strong>Opcje mapy:</strong><br>
            <label style="cursor:pointer; color:#007bff; display:inline-block; margin-top:5px;">
                ðŸ“‚ Wczytaj <em>szlaki_master.json</em> (geometria)
                <input type="file" onchange="loadMasterFile(this)" style="display:none">
            </label>
        </div>

        <div id="map"></div>
        
        <div id="database-view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>Baza Danych (W pamiÄ™ci)</h3>
                <div>
                    Liczba pociÄ…gÃ³w: <strong id="db-count">0</strong>
                    <button class="btn-export" onclick="exportDatabase()">ðŸ’¾ POBIERZ JSON</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Nr PociÄ…gu</th>
                        <th>RJ</th>
                        <th>Trasa (iloÅ›Ä‡ odcinkÃ³w)</th>
                        <th>Uwagi</th>
                        <th>WprowadziÅ‚</th>
                    </tr>
                </thead>
                <tbody id="db-table-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // --- DANE STARTOWE (Szablon szlakÃ³w - nazwy) ---
    // JeÅ›li nie wczytasz JSON-a z geometriÄ…, uÅ¼yjemy tego do nazw
    let availableSegments = [
        {id: 1, start: "ÅÃ³dÅº Fabryczna", end: "ÅÃ³dÅº Widzew", via: "-"},
        {id: 2, start: "ÅÃ³dÅº Widzew", end: "ÅÃ³dÅº Chojny", via: "ÅÃ³dÅº DÄ…browa"},
        {id: 3, start: "ÅÃ³dÅº Widzew", end: "ÅÃ³dÅº Chojny", via: "ÅÃ³dÅº OlechÃ³w"},
        {id: 4, start: "ÅÃ³dÅº Chojny", end: "ÅÃ³dÅº Lublinek", via: "-"},
        {id: 5, start: "ÅÃ³dÅº Chojny", end: "ÅÃ³dÅº Kaliska", via: "-"},
        {id: 6, start: "ÅÃ³dÅº Kaliska", end: "ÅÃ³dÅº Lublinek", via: "-"},
        {id: 7, start: "ÅÃ³dÅº Kaliska", end: "Zgierz", via: "ÅÃ³dÅº Å»abieniec"},
        {id: 8, start: "ÅÃ³dÅº Widzew", end: "Zgierz", via: "ÅÃ³dÅº ArturÃ³wek"},
        {id: 9, start: "Zgierz", end: "Kutno", via: "ÅÄ™czyca"},
        {id: 10, start: "Zgierz", end: "Åowicz GÅ‚Ã³wny", via: "StrykÃ³w"},
        {id: 11, start: "Åowicz GÅ‚Ã³wny", end: "Kutno", via: "-"},
        {id: 12, start: "ÅÃ³dÅº Widzew", end: "Koluszki", via: "-"},
        {id: 13, start: "Koluszki", end: "Grodzisk Maz.", via: "Skierniewice"},
        {id: 14, start: "Koluszki", end: "Åowicz GÅ‚Ã³wny", via: "Skierniewice Park, BeÅ‚chÃ³w"},
        {id: 15, start: "Åowicz GÅ‚Ã³wny", end: "W-wa Zachodnia", via: "Sochaczew, W-wa WÅ‚ochy"},
        {id: 16, start: "Åowicz GÅ‚Ã³wny", end: "Grodzisk Maz.", via: "BeÅ‚chÃ³w, Å»yrardÃ³w"},
        {id: 17, start: "Åowicz GÅ‚Ã³wny", end: "W-wa GÅ‚Ã³wna Towarowa", via: "Sochaczew"},
        {id: 18, start: "Grodzisk Maz.", end: "W-wa Zachodnia", via: "W-wa WÅ‚ochy"},
        {id: 19, start: "Grodzisk Maz.", end: "W-wa GdaÅ„ska", via: "W-wa MÅ‚ynÃ³w"},
        {id: 20, start: "Grodzisk Maz.", end: "W-wa GÅ‚Ã³wna Towarowa", via: "-"},
        {id: 21, start: "Grodzisk Maz.", end: "Idzikowice", via: "Szeligi"},
        {id: 22, start: "W-wa GÅ‚Ã³wna Towarowa", end: "W-wa GdaÅ„ska", via: "W-wa Jelonki"},
        {id: 23, start: "W-wa GÅ‚Ã³wna Towarowa", end: "W-wa Zachodnia", via: "W-wa Odolany"},
        {id: 24, start: "W-wa Zachodnia", end: "W-wa Wschodnia", via: "W-wa Centralna"},
        {id: 25, start: "W-wa Zachodnia", end: "W-wa Wschodnia", via: "W-wa ÅšrÃ³dmieÅ›cie"},
        {id: 26, start: "W-wa Zachodnia", end: "W-wa GÅ‚Ã³wna.", via: "-"},
        {id: 27, start: "W-wa Wschodnia", end: "W-wa GrochÃ³w", via: "-"},
        {id: 28, start: "W-wa GdaÅ„ska", end: "W-wa Wschodnia", via: "W-wa ZOO"},
        {id: 29, start: "W-wa GdaÅ„ska", end: "W-wa GrochÃ³w", via: "W-wa ZOO"},
        {id: 30, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa Olszynka Grochowska, Otwock"},
        {id: 31, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa Wsch Towarowa, Otwock"},
        {id: 32, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa RembertÃ³w, Grzebowilk"},
        {id: 33, start: "Pilawa", end: "Lublin GÅ‚Ã³wny", via: "DÄ™blin, NaÅ‚Ä™czÃ³w"},
        {id: 34, start: "W-wa Wschodnia", end: "TÅ‚uszcz", via: "W-wa RembertÃ³w"},
        {id: 35, start: "TÅ‚uszcz", end: "BiaÅ‚ystok", via: "MaÅ‚kinia"},
        {id: 36, start: "W-wa Wschodnia", end: "DziaÅ‚dowo", via: "CiechanÃ³w"},
        {id: 37, start: "DziaÅ‚dowo", end: "IÅ‚awa GÅ‚Ã³wna", via: "-"},
        {id: 38, start: "IÅ‚awa GÅ‚Ã³wna", end: "Tczew", via: "Prabuty, Malbork"},
        {id: 39, start: "Tczew", end: "Gdynia GÅ‚Ã³wna", via: "GdaÅ„sk GÅ‚Ã³wny"},
        {id: 40, start: "ÅÃ³dÅº Lublinek", end: "Gajewniki", via: "Pabianice"},
        {id: 41, start: "Gajewniki", end: "Kalisz", via: "Sieradz"},
        {id: 42, start: "Gajewniki", end: "KoÅ‚o", via: "PoddÄ™bice, BarÅ‚ogi"},
        {id: 43, start: "Gajewniki", end: "InowrocÅ‚aw RÄ…binek", via: "PoddÄ™bice, PiotrkÃ³w Kujawski"},
        {id: 44, start: "Kalisz", end: "OstrÃ³w Wielkopolski", via: "-"},
        {id: 45, start: "Kalisz", end: "Jarocin", via: "Pleszew"},
        {id: 46, start: "OstrÃ³w Wielkopolski", end: "Jarocin", via: "Pleszew"},
        {id: 47, start: "Jarocin", end: "PoznaÅ„ GÅ‚Ã³wny", via: "Åšroda Wielkopolska"},
        {id: 48, start: "Jarocin", end: "PoznaÅ„ GÅ‚Ã³wny", via: "WrzeÅ›nia"},
        {id: 49, start: "Kutno", end: "Bydgoszcz GÅ‚Ã³wna", via: "ToruÅ„ GÅ‚Ã³wny"},
        {id: 50, start: "Bydgoszcz GÅ‚Ã³wna", end: "Tczew", via: "Laskowice Pomorskie"},
        {id: 51, start: "Kutno", end: "PÅ‚ock Trzepowo", via: "Gostynin"},
        {id: 52, start: "Kutno", end: "SwarzÄ™dz", via: "-"},
        {id: 53, start: "Kutno", end: "SwarzÄ™dz", via: "WrzeÅ›nia"},
        {id: 54, start: "SwarzÄ™dz", end: "PoznaÅ„ GÅ‚Ã³wny", via: "PoznaÅ„ WschÃ³d"},
        {id: 55, start: "SwarzÄ™dz", end: "PoznaÅ„ GÅ‚Ã³wny", via: "PoznaÅ„ Franowo"},
        {id: 56, start: "PoznaÅ„ GÅ‚Ã³wny", end: "PiÅ‚a GÅ‚Ã³wna", via: "Oborniki Wielkopolskie, ChodzieÅ¼"},
        {id: 57, start: "PoznaÅ„ GÅ‚Ã³wny", end: "KrzyÅ¼", via: "PoznaÅ„ Wola, SzamotuÅ‚y"},
        {id: 58, start: "KrzyÅ¼", end: "Szczecin DÄ…bie", via: "Choszczno"},
        {id: 59, start: "Szczecin DÄ…bie", end: "Szczecin GÅ‚Ã³wny", via: "Dziewoklicz"},
        {id: 60, start: "Szczecin DÄ…bie", end: "Szczecin GÅ‚Ã³wny", via: "Szczecin Port Centr."},
        {id: 61, start: "PoznaÅ„ GÅ‚Ã³wny", end: "ZbÄ…szynek", via: "Opalenica, Nowy TomyÅ›l"},
        {id: 62, start: "ZbÄ…szynek", end: "Zielona GÃ³ra GÅ‚Ã³wna", via: "-"},
        {id: 63, start: "ZbÄ…szynek", end: "Rzepin", via: "Åšwiebodzin"},
        {id: 64, start: "ZbÄ…szynek", end: "GorzÃ³w Wielkopolski", via: "MiÄ™dzyrzecz, Skwierzyna"},
        {id: 65, start: "Kutno", end: "InowrocÅ‚aw RÄ…binek", via: "ZamkÃ³w, PiotrkÃ³w Kujawski"},
        {id: 66, start: "InowrocÅ‚aw RÄ…binek", end: "PoznaÅ„ GÅ‚Ã³wny", via: "Gniezno, Kobylnica"},
        {id: 67, start: "InowrocÅ‚aw RÄ…binek", end: "PoznaÅ„ GÅ‚Ã³wny", via: "Gniezno, WrzeÅ›nia"},
        {id: 68, start: "InowrocÅ‚aw RÄ…binek", end: "Bydgoszcz GÅ‚Ã³wna", via: "ZÅ‚otniki Kujawskie, Brzoza Bydgoska"},
        {id: 69, start: "InowrocÅ‚aw RÄ…binek", end: "Bydgoszcz GÅ‚Ã³wna", via: "ZÅ‚otniki Kujawskie, Bydgoszcz LeÅ›na"},
        {id: 70, start: "OstrÃ³w Wielkopolski", end: "WrocÅ‚aw GÅ‚Ã³wny", via: "TwardogÃ³ra"},
        {id: 71, start: "OstrÃ³w Wielkopolski", end: "WrocÅ‚aw GÅ‚Ã³wny", via: "Krotoszyn, Milicz"},
        {id: 72, start: "ÅÃ³dÅº Widzew", end: "PiotrkÃ³w Trybunalski", via: "BÄ™zelin"},
        {id: 73, start: "Koluszki", end: "PiotrkÃ³w Trybunalski", via: "-"},
        {id: 74, start: "PiotrkÃ³w Trybunalski", end: "CzÄ™stochowa", via: "Radomsko, Wyczerpy"},
        {id: 75, start: "CzÄ™stochowa", end: "Lubliniec", via: "Herby Stare"},
        {id: 76, start: "Lubliniec", end: "WrocÅ‚aw GÅ‚Ã³wny", via: "Opole, Brzeg"},
        {id: 77, start: "CzÄ™stochowa", end: "Zawiercie", via: "Poraj"},
        {id: 78, start: "Zawiercie", end: "Dorota", via: "DÄ…browa GÃ³rnicza Huta Katowice"},
        {id: 79, start: "Zawiercie", end: "Dorota", via: "Przemiarki, KozioÅ‚"},
        {id: 80, start: "Dorota", end: "Jaworzno Szczakowa", via: "Sosnowiec Maczki"},
        {id: 81, start: "Dorota", end: "Katowice", via: "Sosnowiec DaÅ„dÃ³wka, Sosnowiec PoÅ‚udniowy"},
        {id: 82, start: "Dorota", end: "Katowice", via: "Sosnowiec Maczki, MysÅ‚owice"},
        {id: 83, start: "Zawiercie", end: "Katowice", via: "DÄ…browa GÃ³rnicza, Sosnowiec GÅ‚Ã³wny"},
        {id: 84, start: "Katowice", end: "Jaworzno Szczakowa", via: "MysÅ‚owice"},
        {id: 85, start: "Jaworzno Szczakowa", end: "KrakÃ³w GÅ‚Ã³wny", via: "Trzebinia, KrakÃ³w Mydlniki"},
        {id: 86, start: "CzÄ™stochowa", end: "Koniecpol", via: "Julianka"},
        {id: 87, start: "Koniecpol", end: "KozÅ‚Ã³w", via: "Starzyny"},
        {id: 88, start: "KozÅ‚Ã³w", end: "KrakÃ³w GÅ‚Ã³wny", via: "MiechÃ³w, ZastÃ³w"},
        {id: 89, start: "KrakÃ³w GÅ‚Ã³wny", end: "KrakÃ³w PÅ‚aszÃ³w", via: "-"},
        {id: 90, start: "Koniecpol", end: "WÅ‚oszczowa PÃ³Å‚noc", via: "Å»elisÅ‚awice"},
        {id: 91, start: "ÅÃ³dÅº Widzew", end: "TomaszÃ³w Mazowiecki", via: "-"},
        {id: 92, start: "Koluszki", end: "TomaszÃ³w Mazowiecki", via: "SÅ‚otwiny"},
        {id: 93, start: "TomaszÃ³w Mazowiecki", end: "Idzikowice", via: "-"},
        {id: 94, start: "TomaszÃ³w Mazowiecki", end: "Idzikowice", via: "Radzice"},
        {id: 95, start: "Idzikowice", end: "WÅ‚oszczowa PÃ³Å‚noc", via: "Opoczno PoÅ‚udnie"},
        {id: 96, start: "WÅ‚oszczowa PÃ³Å‚noc", end: "KozÅ‚Ã³w", via: "Starzyny"},
        {id: 97, start: "WÅ‚oszczowa PÃ³Å‚noc", end: "Zawiercie", via: "GÃ³ra WÅ‚odowska"},
        {id: 98, start: "TomaszÃ³w Mazowiecki", end: "Radom GÅ‚Ã³wny", via: "Drzewica, Przysucha"},
        {id: 99, start: "Radom GÅ‚Ã³wny", end: "Lublin GÅ‚Ã³wny", via: "Pionki, NaÅ‚Ä™czÃ³w"}
    ];

    // --- STAN APLIKACJI ---
    let trainsDatabase = []; // Tutaj lÄ…dujÄ… zatwierdzone pociÄ…gi
    let currentRoute = [];   // Tutaj budujemy trasÄ™ obecnego pociÄ…gu (lista ID)
    
    // Ustawienie daty na dzisiaj
    document.getElementById('trainDate').value = new Date().toISOString().split('T')[0];

    // --- MAPA ---
    var map = L.map('map').setView([52.0, 19.2], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OSM contributors'
    }).addTo(map);
    var routeLayer = new L.FeatureGroup().addTo(map);

    // --- FUNKCJE UI (Formularze) ---

    function filterSegments() {
        const query = document.getElementById('searchBox').value.toLowerCase();
        const container = document.getElementById('segment-selector');
        container.innerHTML = '';

        availableSegments.forEach(seg => {
            const txt = `${seg.id}. ${seg.start} - ${seg.end} ${seg.via}`.toLowerCase();
            if (txt.includes(query)) {
                const div = document.createElement('div');
                div.className = 'segment-option';
                div.innerHTML = `
                    <span>${seg.start} -> ${seg.end} <small>(${seg.via})</small></span>
                    <span class="add-icon">+</span>
                `;
                div.onclick = () => addSegmentToCurrent(seg.id);
                container.appendChild(div);
            }
        });
    }
    // Inicjalizacja listy
    filterSegments();

    function addSegmentToCurrent(id) {
        const seg = availableSegments.find(s => s.id === id);
        currentRoute.push(seg);
        renderCurrentRoute();
        drawRoute();
    }

    function removeSegment(index) {
        currentRoute.splice(index, 1);
        renderCurrentRoute();
        drawRoute();
    }

    function renderCurrentRoute() {
        const container = document.getElementById('current-route-list');
        container.innerHTML = '';
        
        if (currentRoute.length === 0) {
            container.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">Brak wybranych szlakÃ³w</div>';
            return;
        }

        currentRoute.forEach((seg, idx) => {
            const div = document.createElement('div');
            div.className = 'route-item';
            div.innerHTML = `
                <span>${idx + 1}. ${seg.start} - ${seg.end}</span>
                <span class="remove-btn" onclick="removeSegment(${idx})">&times;</span>
            `;
            container.appendChild(div);
        });
    }

    // --- OBSÅUGA BAZY DANYCH ---

    function addTrainToDB() {
        // Walidacja
        const nr = document.getElementById('trainNr').value.trim();
        if (!nr) { alert("Podaj numer pociÄ…gu!"); return; }
        if (currentRoute.length === 0) { alert("PociÄ…g musi mieÄ‡ trasÄ™!"); return; }

        // Tworzenie rekordu
        const record = {
            id: Date.now().toString(), // unikalne ID
            nr: nr,
            rj: document.getElementById('trainRJ').value,
            uwagi: document.getElementById('trainNotes').value,
            autor: document.getElementById('trainAuthor').value,
            data_wprowadzenia: document.getElementById('trainDate').value,
            trasa_ids: currentRoute.map(s => s.id), // zapisujemy tylko ID szlakÃ³w
            trasa_opis: currentRoute.map(s => `${s.start}-${s.end}`).join(', ') // dla czytelnoÅ›ci JSON
        };

        trainsDatabase.push(record);
        renderDatabaseTable();
        clearForm(true); // WyczyÅ›Ä‡ formularz ale nie autora/daty
        
        // Mrugnij mapÄ… na zielono (opcjonalnie)
        alert(`PociÄ…g ${record.nr} dodany do bazy! MoÅ¼esz wprowadzaÄ‡ kolejny.`);
    }

    function clearForm(keepMetadata = false) {
        document.getElementById('trainNr').value = '';
        document.getElementById('trainNotes').value = '';
        currentRoute = [];
        renderCurrentRoute();
        drawRoute();
        
        if (!keepMetadata) {
            document.getElementById('trainRJ').value = '2025/2026 ZRJ1';
            // Autora i daty zazwyczaj nie czyÅ›cimy dla wygody admina
        }
    }

    function renderDatabaseTable() {
        const tbody = document.getElementById('db-table-body');
        tbody.innerHTML = '';
        
        trainsDatabase.forEach(train => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${train.nr}</strong></td>
                <td>${train.rj}</td>
                <td>${train.trasa_ids.length} odcinkÃ³w</td>
                <td>${train.uwagi}</td>
                <td>${train.autor}</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('db-count').innerText = trainsDatabase.length;
    }

    function exportDatabase() {
        if (trainsDatabase.length === 0) { alert("Baza jest pusta!"); return; }

        const output = {
            meta: { generator: "Admin Panel Trains", date: new Date().toISOString() },
            trains: trainsDatabase
        };

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(output, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = `baza_pociagow_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    // --- FUNKCJE MAPY (GEOMETRIA) ---
    
    // Wczytanie pliku master od admina (opcjonalne)
    function loadMasterFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                // Aktualizujemy naszÄ… bazÄ™ segmentÃ³w o geometriÄ™ z pliku
                if(Array.isArray(json)) {
                    availableSegments = json; 
                    filterSegments(); // odÅ›wieÅ¼ listÄ™ (moÅ¼e siÄ™ zmieniÅ‚y nazwy?)
                    alert("Geometria zaÅ‚adowana! Mapa bÄ™dzie dziaÅ‚aÄ‡.");
                }
            } catch(err) { console.error(err); alert("BÅ‚Ä…d pliku JSON"); }
        };
        reader.readAsText(file);
    }

    function drawRoute() {
        routeLayer.clearLayers();
        let hasGeo = false;

        currentRoute.forEach(seg => {
            if (seg.geometry) {
                hasGeo = true;
                L.geoJSON(seg.geometry, { style: {color: 'blue', weight: 5} }).addTo(routeLayer);
            }
        });

        if (hasGeo) {
            try { map.fitBounds(routeLayer.getBounds()); } catch(e){}
        }
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrolka Szlak贸w - Raport Miesiczny</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W05T4L1HFD');
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body {
            background-color: #f8f9fa;
            color: #212529;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 80px;
        }
        .container { max-width: 1000px; }
        
        /* Styl panelu sterowania */
        .control-panel {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        /* Styl tabeli */
        .table-responsive {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        th { background-color: #343a40; color: #ffffff; }
        .row-updated { background-color: #d1e7dd !important; transition: background-color 0.5s; }
        
        /* Mapa w modalu */
        #map { height: 400px; width: 100%; }

        /* Stopka */
        .app-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #343a40;
            color: #ffffff;
            text-align: center;
            padding: 10px 0;
            font-size: 0.9rem;
            z-index: 1000;
        }
        .footer-version { font-size: 0.8rem; opacity: 0.8; }

        /* --- STYL DRUKOWANIA (PDF) --- */
        @media print {
            body { background-color: white; padding: 0; margin: 0; }
            .control-panel, .app-footer, .btn, .modal, .bi-map, .memory-counter { display: none !important; }
            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
            .table-responsive { box-shadow: none; border: none; }
            table { width: 100% !important; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid black !important; padding: 4px !important; color: black !important; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
            .row-updated { background-color: white !important; }
            
            /* Nag贸wek wydruku */
            #printHeader {
                display: block !important;
                margin-bottom: 20px;
                text-align: center;
                border-bottom: 2px solid black;
                padding-bottom: 10px;
            }
            /* Ukryj inputy daty, poka偶 tekst */
            input[type="date"] {
                border: none;
                background: transparent;
                padding: 0;
                font-family: inherit;
                color: black;
                width: auto;
                text-align: right;
            }
            /* Usu ikony kalendarza w druku */
            input[type="date"]::-webkit-calendar-picker-indicator { display: none; }
        }
        
        #printHeader { display: none; } /* Domylnie ukryty */
    </style>
</head>
<body>

<div class="container mt-4">
    <div id="printHeader">
        <h2>Karta Znajomoci Szlak贸w</h2>
        <div class="d-flex justify-content-between mt-3 px-5">
            <span>Imi i Nazwisko: ........................................................</span>
            <span>Miesic: ......................... Rok: .................</span>
        </div>
    </div>

    <header class="mb-4 text-center d-print-none">
        <h1>Kontrolka Szlak贸w</h1>
        <p class="lead">Narzdzie raportowania dla Kierownika Pocigu</p>
    </header>

    <div class="control-panel d-print-none">
        <h2 class="h5 mb-3">Rejestracja Przejazdu</h2>
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="inputDate" class="form-label">Data przejazdu</label>
                <input type="date" id="inputDate" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="inputTrain" class="form-label">Numer pocigu</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-train-front"></i></span>
                    <input type="text" id="inputTrain" class="form-control" placeholder="np. 14000">
                </div>
            </div>
            <div class="col-md-5">
                <button class="btn btn-primary w-100" id="btnSearchTrain">
                    <i class="bi bi-search"></i> Znajd藕 tras i wybierz odcinki
                </button>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="d-flex justify-content-between align-items-center">
            <div class="memory-counter" id="memoryUsage">Pami: obliczanie...</div>
            <div>
                <button class="btn btn-outline-danger btn-sm me-2" id="btnClearData">Wyczy dane</button>
                <button class="btn btn-success btn-sm" onclick="window.print()">
                    <i class="bi bi-printer"></i> Drukuj Raport / PDF
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle mb-0" id="routesTable">
            <thead class="table-dark">
                <tr>
                    <th class="text-center" style="width: 50px;">LP</th>
                    <th>Odcinek (Od - Do)</th>
                    <th>Przez (Via)</th>
                    <th class="text-center" style="width: 60px;"><i class="bi bi-geo-alt"></i></th>
                    <th style="width: 170px;">Data ost. przejazdu</th>
                </tr>
            </thead>
            <tbody id="routesTableBody">
                <tr><td colspan="5" class="text-center py-4">adowanie danych...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="trainSegmentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Wybierz obsugiwane odcinki</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2" id="modalTrainInfo"></div>
                <div class="list-group" id="modalSegmentsList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="btnConfirmSegments">Zatwierd藕 Przejazd</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalTitle">Geometria Szlaku</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<footer class="app-footer">
    <div class="container">
        <span>Wsp贸autorzy: Gemini oraz Piotr M </span>
        <div class="footer-version">Wersja aplikacji: v1.1</div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- Konfiguracja i Zmienne ---
    const VERSION = "1.1";
    const STORAGE_KEY = 'kontrolka_szlakow_v1';
    let szlakiData = []; // szlaki_master.json
    let pociagiData = []; // pociagi.json
    let mapInstance = null; // Instancja mapy Leaflet

    // --- Inicjalizacja ---
    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('inputDate').valueAsDate = new Date();
        
        try {
            const [szlakiRes, pociagiRes] = await Promise.all([
                fetch('szlaki_master.json'),
                fetch('pociagi.json')
            ]);

            if (!szlakiRes.ok || !pociagiRes.ok) throw new Error("Bd wczytywania plik贸w JSON");

            szlakiData = await szlakiRes.json();
            pociagiData = await pociagiRes.json();
            
            // Sortowanie dla porzdku
            szlakiData.sort((a, b) => a.id - b.id);

            renderTable();
            updateMemoryUsage();
        } catch (e) {
            console.error(e);
            document.getElementById('routesTableBody').innerHTML = `<tr class="table-danger"><td colspan="5" class="text-center">Bd: Brak plik贸w JSON (szlaki_master.json, pociagi.json).</td></tr>`;
        }
    });

    // --- Renderowanie Tabeli ---
    function renderTable() {
        const tbody = document.getElementById('routesTableBody');
        tbody.innerHTML = '';
        const savedData = getSavedData();

        szlakiData.forEach(route => {
            const tr = document.createElement('tr');
            tr.dataset.id = route.id;
            
            const savedDate = savedData[route.id] || '';
            if (savedDate) tr.classList.add('row-updated');

            // Sprawd藕 czy mamy geometri do mapy
            const hasGeo = (route.geometry || route.coordinates || (route.geoJSON)); 
            // Zakadam r贸偶ne nazwy p贸l, dostosuj jeli w jsonie jest inaczej
            
            const mapBtn = `<button class="btn btn-sm btn-outline-secondary border-0" 
                onclick="showMap(${route.id})" title="Poka偶 na mapie">
                <i class="bi bi-map"></i></button>`;

            tr.innerHTML = `
                <td class="text-center fw-bold">${route.id}</td>
                <td>${route.start} - ${route.end}</td>
                <td><small class="text-muted">${route.via !== '-' ? route.via : ''}</small></td>
                <td class="text-center">${mapBtn}</td>
                <td>
                    <input type="date" class="form-control form-control-sm date-input shadow-none" 
                           value="${savedDate}" 
                           onchange="manualDateUpdate(${route.id}, this.value)">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Logika: Wyszukiwanie Pocigu ---
    document.getElementById('btnSearchTrain').addEventListener('click', () => {
        const query = document.getElementById('inputTrain').value.trim().replace(/\s/g, '').toLowerCase();
        if (!query) return alert('Wpisz numer pocigu.');

        // Szukanie pocigu (po numerze lub nazwie)
        const train = pociagiData.find(p => p.numer.toString().toLowerCase().includes(query));

        if (!train) return alert('Nie znaleziono pocigu o takim numerze.');
        
        openSegmentModal(train);
    });

    function openSegmentModal(train) {
        const list = document.getElementById('modalSegmentsList');
        const info = document.getElementById('modalTrainInfo');
        list.innerHTML = '';

        info.innerHTML = `<strong>Pocig ${train.numer}</strong> (${train.relacja_od} &rarr; ${train.relacja_do})`;
        
        if (!train.trasa || train.trasa.length === 0) {
            list.innerHTML = '<div class="text-danger p-3">Ten pocig nie ma zdefiniowanej trasy w bazie.</div>';
        } else {
            train.trasa.forEach((segment, idx) => {
                // Pr贸bujemy dopasowa segment do szlaku master
                // Jeli segment.master_id jest tablic (gdy jeden odcinek pocigu to kilka szlak贸w), obsu偶 to
                // W tym prostym kodzie zakadamy mapowanie 1:1 lub u偶ycie master_id z pociagi.json
                
                const masterId = segment.master_id; 
                let label = `${segment.od} - ${segment.do}`;
                let badge = '';
                let isDisabled = '';
                let isChecked = 'checked';

                // Walidacja z baz master
                const masterRoute = szlakiData.find(m => m.id == masterId);
                
                if (masterRoute) {
                    label = `<strong>[${masterRoute.id}]</strong> ${masterRoute.start} - ${masterRoute.end}`;
                    if (masterRoute.via && masterRoute.via !== '-') label += ` <small class="text-muted">przez ${masterRoute.via}</small>`;
                } else {
                    badge = '<span class="badge bg-warning text-dark ms-2">Brak w Master</span>';
                    isDisabled = 'disabled';
                    isChecked = '';
                }

                const item = document.createElement('label');
                item.className = `list-group-item d-flex align-items-center gap-3 ${isDisabled ? 'bg-light text-muted' : ''}`;
                item.innerHTML = `
                    <input class="form-check-input flex-shrink-0" type="checkbox" value="${masterId}" ${isChecked} ${isDisabled} style="transform: scale(1.3);">
                    <span>${label} ${badge}</span>
                `;
                list.appendChild(item);
            });
        }

        new bootstrap.Modal(document.getElementById('trainSegmentsModal')).show();
    }

    // --- Logika: Zatwierdzanie Dat (Ostatni Przejazd) ---
    document.getElementById('btnConfirmSegments').addEventListener('click', () => {
        const inputDate = document.getElementById('inputDate').value;
        if (!inputDate) return alert("Musisz wybra dat przejazdu.");

        const checkboxes = document.querySelectorAll('#modalSegmentsList input:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value)).filter(id => !isNaN(id));

        if (ids.length === 0) return alert("Nie zaznaczono 偶adnych szlak贸w.");

        const savedData = getSavedData();
        let updatedCount = 0;

        ids.forEach(id => {
            const currentSavedDate = savedData[id];
            
            // LOGIKA: Nadpisz tylko jeli nowa data jest nowsza lub r贸wna
            // LUB jeli nie byo 偶adnej daty wczeniej.
            if (!currentSavedDate || new Date(inputDate) >= new Date(currentSavedDate)) {
                savedData[id] = inputDate;
                
                // Aktualizuj DOM
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) {
                    const input = row.querySelector('.date-input');
                    input.value = inputDate;
                    row.classList.add('row-updated');
                }
                updatedCount++;
            }
        });

        saveData(savedData);
        bootstrap.Modal.getInstance(document.getElementById('trainSegmentsModal')).hide();
        
        if (updatedCount > 0) {
            // Opcjonalne powiadomienie toast lub ciche
        } else {
            alert("Nie zaktualizowano danych - wybrane szlaki maj ju偶 nowsze daty w systemie.");
        }
    });

    // --- Rczna Edycja Daty ---
    window.manualDateUpdate = function(id, newDate) {
        const savedData = getSavedData();
        if (newDate) {
            savedData[id] = newDate;
            document.querySelector(`tr[data-id="${id}"]`).classList.add('row-updated');
        } else {
            delete savedData[id];
            document.querySelector(`tr[data-id="${id}"]`).classList.remove('row-updated');
        }
        saveData(savedData);
    };

    // --- Mapa (Leaflet) ---
    window.showMap = function(id) {
        const route = szlakiData.find(r => r.id === id);
        if (!route) return;

        // Tutaj logika wydobycia geometrii. Zakadam, 偶e w JSON jest pole 'geometry' (GeoJSON) 
        // lub 'coordinates' (tablica punkt贸w). 
        // PRZYKAD dla 'geometry': { "type": "LineString", "coordinates": [...] }
        
        const modalEl = document.getElementById('mapModal');
        const title = document.getElementById('mapModalTitle');
        title.textContent = `Szlak ${route.id}: ${route.start} - ${route.end}`;
        
        const bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();

        // Inicjalizacja mapy po otwarciu modala
        modalEl.addEventListener('shown.bs.modal', () => {
            if (mapInstance) {
                mapInstance.remove(); // Usu star map
            }
            mapInstance = L.map('map');
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(mapInstance);

            // Rysowanie linii
            // Dostosuj to do struktury swojego pliku szlaki_master.json
            let geoJsonData = null;

            if (route.geometry) {
                geoJsonData = route.geometry;
            } else if (route.coordinates) {
                geoJsonData = {
                    "type": "LineString",
                    "coordinates": route.coordinates
                };
            }

            if (geoJsonData) {
                const layer = L.geoJSON(geoJsonData, {
                    style: { color: 'blue', weight: 5 }
                }).addTo(mapInstance);
                
                // Dopasuj widok do linii
                mapInstance.fitBounds(layer.getBounds());
            } else {
                // Fallback, jeli brak geometrii
                mapInstance.setView([52.0, 19.0], 6); // rodek Polski
                L.popup()
                    .setLatLng([52.0, 19.0])
                    .setContent("Brak danych geometrycznych dla tego szlaku w pliku JSON.")
                    .openOn(mapInstance);
            }
        }, { once: true });
    };

    // --- Pami i Narzdzia ---
    function getSavedData() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    }

    function saveData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        updateMemoryUsage();
    }

    document.getElementById('btnClearData').addEventListener('click', () => {
        if(confirm("Czy na pewno usun histori?")) {
            localStorage.removeItem(STORAGE_KEY);
            renderTable();
            updateMemoryUsage();
        }
    });

    function updateMemoryUsage() {
        let total = 0;
        for(let key in localStorage) {
            if(localStorage.hasOwnProperty(key)) {
                total += (localStorage[key].length + key.length) * 2;
            }
        }
        const kb = (total / 1024).toFixed(2);
        document.getElementById('memoryUsage').innerText = `Pami LocalStorage: ${kb} KB`;
    }
</script>

</body>
</html>
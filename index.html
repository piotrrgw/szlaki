<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Przejazdu PociÄ…gu - Wizualizacja</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script> 
    <script> 
        window.dataLayer = window.dataLayer || []; 
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date()); 
        gtag('config', 'G-W05T4L1HFD'); 
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #004494;
            --text-color: #333;
            --bg-color: #f4f4f9;
            --container-bg: #ffffff;
            --border-color: #ccc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 { margin: 0; font-size: 1.5rem; }

        .header-links a {
            color: white;
            text-decoration: none;
            background-color: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: bold;
            transition: background 0.3s;
        }
        .header-links a:hover { background-color: rgba(255,255,255,0.4); }

        main {
            flex: 1;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .controls-container {
            background: var(--container-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 200px;
        }

        label { margin-bottom: 0.5rem; font-weight: bold; }

        select, input[type="date"], input[type="text"], input[type="file"] {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }

        .search-wrapper { position: relative; }
        #train-search { margin-bottom: 0.5rem; }

        button {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        button:hover { background-color: var(--secondary-color); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .btn-debug {
            background-color: #607d8b;
            margin-left: 10px;
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
        }

        #fallback-upload {
            display: none;
            width: 100%;
            border-top: 1px solid #ddd;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .fallback-visible {
            display: flex !important;
            flex-direction: column;
            gap: 1rem;
            background-color: #fff3e0;
            padding: 1rem;
            border: 1px solid #ffcc80;
            border-radius: 4px;
        }

        #message-area {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            display: none;
            font-weight: 500;
        }
        .msg-error { background-color: #ffcdd2; color: #b71c1c; display: block !important; }
        .msg-success { background-color: #c8e6c9; color: #1b5e20; display: block !important; }
        .msg-info { background-color: #e3f2fd; color: #0d47a1; display: block !important; }

        #debug-output {
            display: none;
            background: #eee;
            padding: 1rem;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            height: calc(100vh - 400px);
            min-height: 500px;
        }

        #route-list {
            flex: 1;
            min-width: 300px;
            background: var(--container-bg);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            height: 100%;
        }

        #route-list ul { padding-left: 1.5rem; }
        #route-list li { margin-bottom: 0.5rem; line-height: 1.4; }
        .segment-ok { color: #2e7d32; font-weight: bold; }
        .segment-missing { color: #c62828; }

        #map {
            flex: 3;
            min-width: 300px;
            height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1;
        }

        footer {
            background-color: #333;
            color: #ccc;
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
            margin-top: auto;
        }

        @media (max-width: 768px) {
            .content-wrapper { height: auto; display: block; }
            #map { height: 400px; margin-top: 1rem; }
            .controls-container { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Wizualizacja Trasy PociÄ…gu</h1>
        <div class="header-links">
            <a href="https://piotrrgw.github.io/szlaki/kontrolka.html" target="_blank" rel="noopener noreferrer">
                ðŸ“Š KONTROLKA SZLAKÃ“W
            </a>
        </div>
    </header>

    <main>
        <section class="controls-container">
            <div class="form-group">
                <label for="date-picker">Wybierz datÄ™ podrÃ³Å¼y:</label>
                <input type="date" id="date-picker">
            </div>
            
            <div class="form-group search-wrapper">
                <label for="train-search">Wybierz pociÄ…g:</label>
                <input type="text" id="train-search" placeholder="Wpisz numer lub nazwÄ™ (np. 1234)..." disabled>
                <select id="train-select" disabled size="5" style="height: 120px;">
                    <option value="">Wczytywanie danych...</option>
                </select>
                <small style="color: #666; margin-top: 4px;">Kliknij na pociÄ…g z listy powyÅ¼ej.</small>
            </div>

            <div class="form-group" style="flex: 0; min-width: auto;">
                 <label>&nbsp;</label>
                 <div style="display: flex;">
                    <button id="check-btn" disabled>PokaÅ¼ TrasÄ™</button>
                    <button id="debug-btn" class="btn-debug">ðŸ›  Diagnostyka</button>
                 </div>
            </div>

            <div id="fallback-upload">
                <strong>Problem z automatycznym pobraniem danych.</strong>
                <p>Wgraj pliki rÄ™cznie, aby kontynuowaÄ‡:</p>
                <div class="form-group">
                    <label for="file-trains">Wgraj trains.json:</label>
                    <input type="file" id="file-trains" accept=".json">
                </div>
                <div class="form-group">
                    <label for="file-szlaki">Wgraj szlaki_master.json:</label>
                    <input type="file" id="file-szlaki" accept=".json">
                </div>
            </div>
        </section>

        <div id="message-area"></div>
        <div id="debug-output"></div>

        <div class="content-wrapper">
            <section id="route-list">
                <h2>Przebieg trasy:</h2>
                <p id="route-info-text">Wybierz pociÄ…g i datÄ™.</p>
                <ul id="segments-ul"></ul>
            </section>
            
            <section id="map" aria-label="Mapa z przebiegiem trasy pociÄ…gu"></section>
        </div>
    </main>

    <footer>
        <p>Wersja aplikacji: v1.3 | Autorzy: Gemini, Piotr M ðŸš‚</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        /* Version: 1.3 - Fix JSON path for segments (train.route.segments) */
        
        // --- Zmienne globalne ---
        let trainsData = null;
        let szlakiData = null; // Surowe dane
        let szlakiList = null; // PÅ‚aska lista do przeszukiwania
        let map = null;
        let routeLayerGroup = null;
        let allTrainOptions = [];

        // --- Inicjalizacja Mapy ---
        function initMap() {
            map = L.map('map').setView([52.0, 19.0], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: 'Map style: Â© OpenRailwayMap (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            }).addTo(map);

            routeLayerGroup = L.layerGroup().addTo(map);
        }

        // --- ObsÅ‚uga Daty ---
        function setDefaultDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date-picker').value = `${yyyy}-${mm}-${dd}`;
        }

        // --- Pobieranie Danych ---
        async function loadData() {
            showMessage("PrÃ³ba pobrania danych...", "info");
            try {
                const [trainsRes, szlakiRes] = await Promise.all([
                    fetch('trains.json'),
                    fetch('szlaki_master.json')
                ]);

                if (!trainsRes.ok || !szlakiRes.ok) throw new Error("BÅ‚Ä…d HTTP");

                trainsData = await trainsRes.json();
                szlakiData = await szlakiRes.json();
                
                processSzlakiData(); // Przetwarzanie struktury szlakÃ³w
                initializeAppWithData();
                showMessage("Gotowe. Wybierz pociÄ…g.", "success");
                setTimeout(() => document.getElementById('message-area').style.display = 'none', 3000);

            } catch (error) {
                console.warn("Fetch error:", error);
                showMessage("BÅ‚Ä…d pobierania. UÅ¼yj formularza rÄ™cznego.", "error");
                document.getElementById('fallback-upload').classList.add('fallback-visible');
            }
        }

        // --- Przetwarzanie struktury szlakÃ³w ---
        function processSzlakiData() {
            if (Array.isArray(szlakiData)) {
                szlakiList = szlakiData;
            } else if (szlakiData && szlakiData.type === "FeatureCollection" && Array.isArray(szlakiData.features)) {
                szlakiList = szlakiData.features;
            } else {
                console.error("Nieznana struktura szlaki_master.json");
                szlakiList = [];
            }
        }

        // --- ObsÅ‚uga RÄ™cznego Wgrywania ---
        function handleManualUpload() {
            const fileTrainsInput = document.getElementById('file-trains');
            const fileSzlakiInput = document.getElementById('file-szlaki');

            const readJSON = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { resolve(JSON.parse(e.target.result)); } 
                    catch (err) { reject(err); }
                };
                reader.readAsText(file);
            });

            const checkFiles = async () => {
                if (fileTrainsInput.files.length > 0 && fileSzlakiInput.files.length > 0) {
                    try {
                        trainsData = await readJSON(fileTrainsInput.files[0]);
                        szlakiData = await readJSON(fileSzlakiInput.files[0]);
                        processSzlakiData();
                        initializeAppWithData();
                        showMessage("Pliki wgrane poprawnie.", "success");
                        document.getElementById('fallback-upload').classList.remove('fallback-visible');
                    } catch (e) {
                        showMessage("BÅ‚Ä…d parsowania JSON.", "error");
                    }
                }
            };
            fileTrainsInput.addEventListener('change', checkFiles);
            fileSzlakiInput.addEventListener('change', checkFiles);
        }

        // --- UI PociÄ…gÃ³w ---
        function initializeAppWithData() {
            const select = document.getElementById('train-select');
            const searchInput = document.getElementById('train-search');
            select.innerHTML = '';
            allTrainOptions = [];
            
            if (!Array.isArray(trainsData)) {
                showMessage("BÅ‚Ä…d struktury trains.json.", "error");
                return;
            }

            trainsData.forEach((train, index) => {
                const number = train.trainNo || train.trainId || train.number || "?";
                const name = train.name || "Bez nazwy";
                const displayText = `[${number}] ${name}`;

                const option = document.createElement('option');
                option.value = index;
                option.textContent = displayText;
                select.appendChild(option);
                
                allTrainOptions.push({ element: option, text: displayText.toLowerCase() });
            });

            select.disabled = false;
            searchInput.disabled = false;
            document.getElementById('check-btn').disabled = false;

            searchInput.addEventListener('input', (e) => {
                const filter = e.target.value.toLowerCase();
                allTrainOptions.forEach(opt => {
                    opt.element.style.display = opt.text.includes(filter) ? '' : 'none';
                });
            });
        }

        // --- Helper: Pobieranie odcinkÃ³w z pociÄ…gu (Fix v1.3) ---
        function getSegments(train) {
            if (train.segments && train.segments.length > 0) return train.segments;
            if (train.route && train.route.segments && train.route.segments.length > 0) return train.route.segments;
            return null;
        }

        // --- Szukanie Geometrii ---
        function findGeometry(from, to, via) {
            if (!szlakiList) return null;
            const norm = str => str ? str.trim().toLowerCase() : '';
            
            const tFrom = norm(from);
            const tTo = norm(to);

            for (let item of szlakiList) {
                const props = item.properties || item;
                const sStart = norm(props.start);
                const sEnd = norm(props.end);
                
                const matchForward = (sStart === tFrom && sEnd === tTo);
                const matchReverse = (sStart === tTo && sEnd === tFrom);

                if (matchForward || matchReverse) {
                    let geometry = item.geometry || (item.type === "Feature" ? null : item);
                    return { geometry: geometry, props: props };
                }
            }
            return null;
        }

        // --- WyÅ›wietlanie Trasy ---
        function processSelection() {
            routeLayerGroup.clearLayers();
            const segmentsUl = document.getElementById('segments-ul');
            segmentsUl.innerHTML = '';
            
            const trainIndex = document.getElementById('train-select').value;
            const dateStr = document.getElementById('date-picker').value;

            if (trainIndex === "" || !dateStr) {
                showMessage("Wybierz pociÄ…g i datÄ™.", "error");
                return;
            }

            const train = trainsData[trainIndex];
            
            // Weryfikacja daty
            if (!train.dates || !train.dates.includes(dateStr)) {
                showMessage(`PociÄ…g nie kursuje w dniu ${dateStr}.`, "error");
                document.getElementById('route-info-text').textContent = "Brak kursu.";
                return;
            }

            document.getElementById('route-info-text').textContent = `Trasa: ${train.name} (${train.trainNo || train.number || ''})`;
            showMessage(`Rysowanie trasy...`, "info");

            const segments = getSegments(train);

            if (!segments) {
                showMessage("BÅ‚Ä…d danych: Nie znaleziono listy odcinkÃ³w dla tego pociÄ…gu.", "error");
                runDiagnostics(); // Automatycznie pokaÅ¼ dlaczego
                return;
            }

            let bounds = L.latLngBounds([]);
            let foundCount = 0;

            segments.forEach((segment, idx) => {
                const li = document.createElement('li');
                li.textContent = `${idx + 1}. ${segment.from} -> ${segment.to}`;
                
                const match = findGeometry(segment.from, segment.to, segment.via);

                if (match && match.geometry) {
                    foundCount++;
                    li.classList.add('segment-ok');
                    li.innerHTML += " âœ…";

                    const layer = L.geoJSON(match.geometry, {
                        style: { color: '#0056b3', weight: 6, opacity: 0.8 }
                    }).addTo(routeLayerGroup);
                    
                    const info = `Odcinek: ${segment.from} - ${segment.to}<br>Linia: ${match.props.lineNo || match.props.line || '-'}`;
                    layer.bindPopup(info);
                    
                    bounds.extend(layer.getBounds());
                } else {
                    li.classList.add('segment-missing');
                    li.innerHTML += " âŒ (Brak geometrii)";
                }
                segmentsUl.appendChild(li);
            });

            if (foundCount > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
                showMessage(`Znaleziono ${foundCount}/${segments.length} odcinkÃ³w.`, "success");
            } else {
                showMessage("Brak geometrii dla wszystkich odcinkÃ³w. SprawdÅº 'DiagnostykÄ™'.", "error");
            }
        }

        // --- Diagnostyka ---
        function runDiagnostics() {
            const out = document.getElementById('debug-output');
            out.style.display = 'block';
            
            let log = "--- RAPORT DIAGNOSTYCZNY v1.3 ---\n";
            
            log += `[SZLAKI] Wczytano? ${szlakiList ? 'TAK' : 'NIE'}. IloÅ›Ä‡: ${szlakiList ? szlakiList.length : 0}\n`;

            const trainIndex = document.getElementById('train-select').value;
            if (trainIndex !== "") {
                const train = trainsData[trainIndex];
                log += `[POCIÄ„G] Wybrano: ${train.name}\n`;
                
                const segments = getSegments(train);
                
                if (segments) {
                    log += `[POCIÄ„G] Znaleziono ${segments.length} odcinkÃ³w.\n`;
                    log += `[TESTOWANIE ODCINKÃ“W]:\n`;
                    segments.forEach((seg, i) => {
                        const match = findGeometry(seg.from, seg.to, seg.via);
                        const status = match ? "OK" : "MISSING";
                        log += ` ${i+1}. ${seg.from} -> ${seg.to} [${status}]\n`;
                        if (!match) log += `    (Brak pary '${seg.from}' - '${seg.to}' w pliku szlakÃ³w)\n`;
                    });
                } else {
                    log += `[POCIÄ„G] BÅÄ„D: Brak tablicy 'segments' (sprawdzono train.segments oraz train.route.segments).\n`;
                    log += `Struktura pociÄ…gu: ${JSON.stringify(train, null, 2).substring(0, 500)}...\n`;
                }
            } else {
                log += `[POCIÄ„G] Nie wybrano pociÄ…gu.\n`;
            }

            out.innerText = log;
        }

        function showMessage(text, type) {
            const el = document.getElementById('message-area');
            el.textContent = text;
            el.className = 'msg-' + type;
            el.style.display = 'block';
        }

        // --- Start ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setDefaultDate();
            loadData();
            handleManualUpload();

            document.getElementById('check-btn').addEventListener('click', processSelection);
            document.getElementById('debug-btn').addEventListener('click', runDiagnostics);
        });
    </script>
</body>
</html>
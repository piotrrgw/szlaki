<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Trasowania Kolejowego v6.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer; border-radius: 4px; transition: all 0.1s; border: 1px solid #e2e8f0; background: white; }
        
        .day-active { background: #3b82f6; color: white; border-color: #2563eb; } /* Standard kurs */
        .day-inactive { background: #f1f5f9; color: #94a3b8; } /* Nie kursuje */
        .day-added { background: #22c55e; color: white; border-color: #16a34a; font-weight: bold; } /* Dodatkowy */
        .day-cancelled { background: #ef4444; color: white; border-color: #dc2626; text-decoration: line-through; } /* Odwołany */
        
        /* Map Adjustments */
        .leaflet-container { font-family: 'Inter', sans-serif; }
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="bg-blue-600 text-white w-9 h-9 rounded flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-train-track"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg leading-tight">Planista Rozkładu</h1>
                <div class="flex gap-4 text-xs text-gray-500 font-medium">
                    <span id="status-szlaki" class="flex items-center gap-1 text-red-500"><i class="fa-solid fa-circle text-[8px]"></i> Szlaki: Brak</span>
                    <span id="status-pociagi" class="flex items-center gap-1 text-red-500"><i class="fa-solid fa-circle text-[8px]"></i> Pociągi: Brak</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="toggleJsonPreview()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition flex items-center gap-2">
                <i class="fa-solid fa-code"></i> Podgląd JSON
            </button>
            <button onclick="downloadPociagi()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-sm shadow-green-200">
                <i class="fa-solid fa-download"></i> Pobierz Plik
            </button>
            <button onclick="hardReset()" class="w-9 h-9 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition" title="Resetuj aplikację">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col shrink-0 z-20">
            
            <div class="p-4 border-b border-gray-200 bg-gray-50/50">
                <button onclick="addNewTrain()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg text-sm font-semibold shadow-sm shadow-blue-200 transition mb-4">
                    <i class="fa-solid fa-plus mr-2"></i>Nowy Pociąg
                </button>
                
                <div class="space-y-2">
                    <p class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Baza Danych</p>
                    <label class="flex items-center justify-between px-3 py-2 bg-white border border-gray-200 rounded text-xs cursor-pointer hover:border-blue-400 transition">
                        <span class="text-gray-600">Wgraj szlaki.json</span>
                        <input type="file" class="hidden" onchange="loadSzlakiManual(this)" accept=".json">
                        <i class="fa-solid fa-upload text-blue-500"></i>
                    </label>
                    <label class="flex items-center justify-between px-3 py-2 bg-white border border-gray-200 rounded text-xs cursor-pointer hover:border-blue-400 transition">
                        <span class="text-gray-600">Wgraj pociagi.json</span>
                        <input type="file" class="hidden" onchange="loadTrainsManual(this)" accept=".json">
                        <i class="fa-solid fa-upload text-blue-500"></i>
                    </label>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="train-list">
                </div>
            
            <div class="p-3 border-t border-gray-200 text-center text-[10px] text-gray-400 bg-gray-50">
                OpenRailwayMap Integration
            </div>
        </aside>

        <main class="flex-1 bg-gray-50 flex flex-col relative overflow-hidden">
            
            <div id="editor-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 pointer-events-none">
                <i class="fa-solid fa-train-subway text-7xl mb-4 opacity-50"></i>
                <p class="text-gray-400 font-medium">Wybierz pociąg z listy</p>
            </div>

            <div id="editor-panel" class="flex flex-col h-full hidden">
                
                <div class="bg-white border-b border-gray-200 px-6 flex items-center justify-between shrink-0 h-14">
                    <div class="flex gap-6 h-full">
                        <button onclick="switchTab('info')" id="tab-btn-info" class="h-full border-b-2 border-blue-600 text-blue-600 font-medium text-sm px-1 transition">Dane & Kalendarz</button>
                        <button onclick="switchTab('route')" id="tab-btn-route" class="h-full border-b-2 border-transparent text-gray-500 hover:text-gray-800 font-medium text-sm px-1 transition">Trasa & Mapa</button>
                    </div>
                    <button onclick="deleteCurrentTrain()" class="text-red-500 hover:text-red-700 text-xs font-bold uppercase tracking-wide">
                        Usuń Pociąg
                    </button>
                </div>

                <div class="flex-1 relative overflow-hidden">
                    
                    <div id="tab-info" class="absolute inset-0 overflow-y-auto p-8 fade-in">
                        <div class="max-w-4xl mx-auto space-y-8 pb-20">
                            
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wide mb-4 border-b pb-2">Informacje Podstawowe</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Numer</label>
                                        <input type="text" id="inp-no" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-mono" placeholder="EIC 100">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Nazwa</label>
                                        <input type="text" id="inp-name" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="BERLIN-WARSZAWA EXPRESS">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Tabor</label>
                                        <select id="inp-stock" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm outline-none">
                                            <option value="">-- Wybierz --</option>
                                            <option value="SKŁAD WAGONOWY">SKŁAD WAGONOWY</option>
                                            <option value="ED250">ED250 (Pendolino)</option>
                                            <option value="ED160">ED160 (Flirt)</option>
                                            <option value="ED161">ED161 (Dart)</option>
                                            <option value="ED74">ED74</option>
                                            <option value="SN84">SN84</option>
                                            <option value="SD85">SD85</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Relacja Od</label>
                                        <input type="text" id="inp-rel-from" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-1">Relacja Do</label>
                                        <input type="text" id="inp-rel-to" class="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-sm outline-none">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <div class="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wide">Kalendarz</h3>
                                    <div class="flex gap-3 text-[10px] font-bold uppercase">
                                        <span class="flex items-center gap-1"><div class="w-3 h-3 bg-blue-500 rounded-sm"></div> Kursuje</span>
                                        <span class="flex items-center gap-1"><div class="w-3 h-3 bg-gray-100 border border-gray-300 rounded-sm"></div> Nie kursuje</span>
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-4 mb-6 items-end">
                                    <div>
                                        <label class="block text-[10px] text-gray-500 mb-1">Ważny od</label>
                                        <input type="date" id="cal-from" class="bg-gray-50 border border-gray-300 rounded px-2 py-1 text-sm outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-gray-500 mb-1">Ważny do</label>
                                        <input type="date" id="cal-to" class="bg-gray-50 border border-gray-300 rounded px-2 py-1 text-sm outline-none">
                                    </div>
                                    <div class="flex-1 flex gap-1 justify-end">
                                        <button class="day-btn w-8 h-8 rounded border text-xs font-bold transition" data-day="1">Pn</button>
                                        <button class="day-btn w-8 h-8 rounded border text-xs font-bold transition" data-day="2">Wt</button>
                                        <button class="day-btn w-8 h-8 rounded border text-xs font-bold transition" data-day="3">Śr</button>
                                        <button class="day-btn w-8 h-8 rounded border text-xs font-bold transition" data-day="4">Cz</button>
                                        <button class="day-btn w-8 h-8 rounded border text-xs font-bold transition" data-day="5">Pt</button>
                                        <button class="day-btn w-8 h-8 rounded border text-xs font-bold transition" data-day="6">Sb</button>
                                        <button class="day-btn w-8 h-8 rounded border text-xs font-bold transition text-red-500" data-day="0">Nd</button>
                                    </div>
                                </div>

                                <div id="calendar-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-route" class="absolute inset-0 flex flex-col md:flex-row hidden bg-white">
                        
                        <div class="w-full md:w-80 border-r border-gray-200 flex flex-col h-full bg-white z-10 shadow-lg">
                            <div class="p-4 border-b border-gray-200 bg-gray-50">
                                <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Edytor Trasy</h4>
                                
                                <div id="route-start-ui" class="flex gap-2">
                                    <select id="route-start-select" class="flex-1 bg-white border border-gray-300 rounded text-xs h-8 px-2 outline-none focus:border-blue-500">
                                        <option value="">Wybierz start...</option>
                                    </select>
                                    <button onclick="setRouteStart()" class="bg-blue-600 text-white px-3 rounded text-xs font-bold h-8">OK</button>
                                </div>

                                <div id="route-next-ui" class="hidden flex flex-col gap-2">
                                    <div class="flex justify-between items-center text-xs">
                                        <span class="text-gray-400">Aktualnie:</span>
                                        <button onclick="resetRoute()" class="text-red-500 hover:underline">Reset</button>
                                    </div>
                                    <div class="font-bold text-gray-800 flex items-center gap-1 truncate">
                                        <i class="fa-solid fa-location-dot text-blue-500"></i>
                                        <span id="curr-station">---</span>
                                    </div>
                                    <div class="flex gap-2 mt-1">
                                        <select id="next-segment-select" class="flex-1 bg-white border border-gray-300 rounded text-xs h-8 px-2 outline-none">
                                            <option>...</option>
                                        </select>
                                        <button onclick="addSegment()" class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="route-list" class="flex-1 overflow-y-auto p-3 space-y-0">
                                </div>
                        </div>

                        <div class="flex-1 relative bg-gray-100">
                            <div id="map" class="absolute inset-0"></div>
                            <div class="absolute bottom-2 left-2 z-[400] bg-white/90 backdrop-blur px-2 py-1 text-[10px] rounded shadow border border-gray-200 text-gray-600">
                                OpenRailwayMap Layer Active
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <div id="json-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-3/4 h-3/4 rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700">pociagi.json</h3>
                <button onclick="toggleJsonPreview()" class="text-gray-400 hover:text-gray-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <textarea id="json-output" class="flex-1 p-4 font-mono text-xs text-gray-600 bg-white resize-none outline-none" readonly></textarea>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let trains = [];
        let szlakiDB = []; // Array of track objects
        let currentTrainIndex = -1;
        let map = null;
        let routeLayer = null;

        // --- INIT ---
        window.onload = async () => {
            // Init Map
            initMap();

            // 1. Try Load Szlaki
            try {
                const r = await fetch('szlaki_master.json');
                if(r.ok) {
                    szlakiDB = await r.json();
                    updateStatus('szlaki', true, szlakiDB.length);
                } else { throw new Error('404'); }
            } catch(e) { updateStatus('szlaki', false); }

            // 2. Try Load Pociagi (Server or LocalStorage priority?)
            // Priority: LocalStorage (work in progress) > Server (baseline)
            // But user said "does not load filled trains from server".
            // Strategy: Load server, then merge LS? Or just load server if LS empty.
            // Let's load server first.
            let serverTrains = [];
            try {
                const r2 = await fetch('pociagi.json');
                if(r2.ok) serverTrains = await r2.json();
            } catch(e) { console.log("No pociagi.json on server"); }

            // Load LS
            const localTrains = JSON.parse(localStorage.getItem('trains_v6') || '[]');
            
            if (localTrains.length > 0) {
                trains = localTrains; // User has unsaved work, prioritize it
                console.log("Loaded from LocalStorage");
            } else if (serverTrains.length > 0) {
                trains = serverTrains;
                console.log("Loaded from Server");
            }

            if(trains.length > 0) updateStatus('pociagi', true, trains.length);
            
            renderTrainList();
        };

        function updateStatus(type, ok, count=0) {
            const el = document.getElementById(`status-${type}`);
            if(ok) {
                el.className = "flex items-center gap-1 text-green-600 font-bold";
                el.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${type === 'szlaki' ? 'Szlaki' : 'Pociągi'}: ${count}`;
            } else {
                el.className = "flex items-center gap-1 text-red-500";
                el.innerHTML = `<i class="fa-solid fa-times-circle"></i> ${type === 'szlaki' ? 'Szlaki' : 'Pociągi'}: Brak`;
            }
        }

        // --- MAP ENGINE (OpenRailwayMap) ---
        function initMap() {
            map = L.map('map').setView([52.0, 19.0], 6);
            
            // 1. Base Layer (OSM Standard for context)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            // 2. Overlay (OpenRailwayMap)
            L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenRailwayMap'
            }).addTo(map);

            routeLayer = L.layerGroup().addTo(map);
        }

        function drawRoute() {
            if(!map || currentTrainIndex < 0) return;
            routeLayer.clearLayers();
            const t = trains[currentTrainIndex];
            const bounds = [];

            // Draw Segments
            t.trasa.forEach((seg, i) => {
                // Find master track
                // Assumption: seg.master_id is index or we search. 
                // Previous logic used index.
                const track = szlakiDB[seg.master_id];
                
                if(track) {
                    // Try get geometry: 'geometry' or 'geometria'
                    let geo = track.geometry || track.geometria;
                    
                    if(geo && geo.coordinates) {
                        // GeoJSON is [Lon, Lat], Leaflet needs [Lat, Lon]
                        const path = geo.coordinates.map(c => [c[1], c[0]]);
                        
                        L.polyline(path, { color: '#ef4444', weight: 5, opacity: 0.8 }).addTo(routeLayer);
                        path.forEach(p => bounds.push(p));

                        // Station Markers
                        if(i===0) L.circleMarker(path[0], {radius:6, color:'green', fillColor:'lime', fillOpacity:1}).addTo(routeLayer).bindTooltip(seg.od);
                        L.circleMarker(path[path.length-1], {radius:4, color:'blue', fillColor:'white', fillOpacity:1}).addTo(routeLayer).bindTooltip(seg.do);
                    }
                }
            });

            if(bounds.length > 0) map.fitBounds(bounds, {padding:[50,50]});
        }

        // --- LOGIC ---
        function addNewTrain() {
            trains.push({
                id: Date.now().toString(36),
                numer: "NOWY",
                nazwa: "",
                tabor: "",
                relacja_od: "",
                relacja_do: "",
                valid_from: new Date().toISOString().split('T')[0],
                valid_to: new Date(new Date().getFullYear(), 11, 31).toISOString().split('T')[0],
                days: [1,2,3,4,5], // Mon-Fri
                exceptions: [],
                trasa: [],
                temp_start: null
            });
            save();
            renderTrainList();
            selectTrain(trains.length-1);
        }

        function selectTrain(idx) {
            currentTrainIndex = idx;
            const t = trains[idx];
            
            document.getElementById('editor-empty').classList.add('hidden');
            document.getElementById('editor-panel').classList.remove('hidden');
            
            // Map Inputs
            document.getElementById('inp-no').value = t.numer || "";
            document.getElementById('inp-name').value = t.nazwa || "";
            document.getElementById('inp-stock').value = t.tabor || "";
            document.getElementById('inp-rel-from').value = t.relacja_od || "";
            document.getElementById('inp-rel-to').value = t.relacja_do || "";
            document.getElementById('cal-from').value = t.valid_from || "";
            document.getElementById('cal-to').value = t.valid_to || "";

            // Days buttons
            document.querySelectorAll('.day-btn').forEach(btn => {
                const d = parseInt(btn.dataset.day);
                styleDayBtn(btn, t.days.includes(d));
            });

            // UI Refresh
            renderTrainList();
            renderCalendar();
            renderRouteUI();
            
            // Auto switch to info tab
            if(document.getElementById('tab-info').classList.contains('hidden') && document.getElementById('tab-route').classList.contains('hidden')) {
                switchTab('info');
            }
            // If map visible, redraw
            if(!document.getElementById('tab-route').classList.contains('hidden')) {
                setTimeout(() => { map.invalidateSize(); drawRoute(); }, 100);
            }
        }

        function renderTrainList() {
            const list = document.getElementById('train-list');
            list.innerHTML = '';
            trains.forEach((t, i) => {
                const el = document.createElement('div');
                const active = i === currentTrainIndex;
                el.className = `p-3 rounded-lg cursor-pointer border mb-2 transition ${active ? 'bg-blue-50 border-blue-500 shadow-sm' : 'bg-white border-gray-200 hover:border-blue-300'}`;
                el.onclick = () => selectTrain(i);
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-sm text-gray-800">${t.numer || 'Bez numeru'}</span>
                        ${t.trasa.length > 0 ? '<i class="fa-solid fa-route text-green-500 text-xs"></i>' : ''}
                    </div>
                    <div class="text-xs text-gray-500 truncate">${t.nazwa || ''}</div>
                `;
                list.appendChild(el);
            });
        }

        // --- CALENDAR LOGIC ---
        function renderCalendar() {
            if(currentTrainIndex < 0) return;
            const t = trains[currentTrainIndex];
            const cont = document.getElementById('calendar-grid-container');
            cont.innerHTML = '';

            const start = new Date(t.valid_from);
            const end = new Date(t.valid_to);
            let curr = new Date(start.getFullYear(), start.getMonth(), 1);
            
            // Limit loop to avoid crash if dates wrong
            let limit = 0;
            while(curr <= end && limit < 24) { // Max 2 years view
                const mDiv = document.createElement('div');
                mDiv.className = "bg-white border border-gray-100 rounded p-2 shadow-sm";
                mDiv.innerHTML = `<div class="text-center font-bold text-xs text-gray-400 mb-2 capitalize">${curr.toLocaleString('pl-PL', {month:'long', year:'numeric'})}</div>`;
                
                const grid = document.createElement('div');
                grid.className = "calendar-grid";
                // Week headers
                ['P','W','Ś','C','P','S','N'].forEach(h => grid.innerHTML += `<div class="text-[9px] text-center text-gray-300 font-bold">${h}</div>`);
                
                // Empties
                let firstDay = curr.getDay(); firstDay = firstDay === 0 ? 6 : firstDay - 1;
                for(let k=0; k<firstDay; k++) grid.innerHTML += `<div></div>`;

                const daysInMonth = new Date(curr.getFullYear(), curr.getMonth()+1, 0).getDate();
                for(let d=1; d<=daysInMonth; d++) {
                    const z = new Date(curr.getFullYear(), curr.getMonth(), d, 12,0,0);
                    const iso = z.toISOString().split('T')[0];
                    const cell = document.createElement('div');
                    cell.className = "calendar-day";
                    cell.innerText = d;
                    
                    const inRange = z >= start && z <= end;
                    if(inRange) {
                        const sched = t.days.includes(z.getDay());
                        const ex = t.exceptions.includes(iso);
                        
                        if(sched) {
                            if(ex) cell.classList.add('day-cancelled'); else cell.classList.add('day-active');
                        } else {
                            if(ex) cell.classList.add('day-added'); else cell.classList.add('day-inactive');
                        }
                        
                        cell.onclick = () => {
                            if(t.exceptions.includes(iso)) t.exceptions = t.exceptions.filter(x=>x!==iso);
                            else t.exceptions.push(iso);
                            save(); renderCalendar();
                        };
                    } else {
                        cell.style.opacity = "0.3"; cell.style.cursor = "default";
                    }
                    grid.appendChild(cell);
                }
                mDiv.appendChild(grid);
                cont.appendChild(mDiv);
                
                curr.setMonth(curr.getMonth()+1);
                limit++;
            }
        }

        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if(currentTrainIndex < 0) return;
                const d = parseInt(btn.dataset.day);
                const t = trains[currentTrainIndex];
                if(t.days.includes(d)) t.days = t.days.filter(x=>x!==d); else t.days.push(d);
                save(); selectTrain(currentTrainIndex); // Refresh UI
            });
        });

        function styleDayBtn(btn, active) {
            if(active) {
                btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
            } else {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            }
        }

        // --- ROUTE LOGIC ---
        function renderRouteUI() {
            const t = trains[currentTrainIndex];
            const list = document.getElementById('route-list');
            list.innerHTML = '';
            
            const startUI = document.getElementById('route-start-ui');
            const nextUI = document.getElementById('route-next-ui');
            
            // Check Head
            let head = null;
            if(t.trasa.length > 0) head = t.trasa[t.trasa.length-1].do;
            else head = t.temp_start;

            if(!head) {
                startUI.classList.remove('hidden');
                nextUI.classList.add('hidden');
                // Populate start dropdown
                const sel = document.getElementById('route-start-select');
                if(sel.options.length <= 1 && szlakiDB.length > 0) {
                    const st = new Set();
                    szlakiDB.forEach(s => { st.add(s.start); st.add(s.end); });
                    Array.from(st).sort().forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
                }
            } else {
                startUI.classList.add('hidden');
                nextUI.classList.remove('hidden');
                document.getElementById('curr-station').innerText = head;
                
                // Populate next options
                const sel = document.getElementById('next-segment-select');
                sel.innerHTML = '<option value="">Wybierz...</option>';
                const matches = szlakiDB.filter(s => s.start === head || s.end === head);
                matches.forEach(m => {
                    const isFwd = m.start === head;
                    const dest = isFwd ? m.end : m.start;
                    const val = JSON.stringify({ master_id: szlakiDB.indexOf(m), od: head, do: dest, przez: m.via || null });
                    sel.innerHTML += `<option value='${val}'>-> ${dest} ${m.via ? '('+m.via+')':''}</option>`;
                });
            }

            // Render Timeline
            if(t.trasa.length > 0 || t.temp_start) {
                const startNode = document.createElement('div');
                const startName = t.trasa.length > 0 ? t.trasa[0].od : t.temp_start;
                startNode.className = "pl-4 pb-4 border-l-2 border-gray-200 relative";
                startNode.innerHTML = `<div class="absolute -left-[5px] top-0 w-2.5 h-2.5 bg-green-500 rounded-full"></div><span class="text-xs font-bold text-gray-700">${startName}</span>`;
                list.appendChild(startNode);
            }

            t.trasa.forEach((seg, i) => {
                const item = document.createElement('div');
                item.className = "pl-4 pb-4 border-l-2 border-gray-200 relative group";
                item.innerHTML = `
                    <div class="absolute -left-[5px] top-1 w-2.5 h-2.5 bg-gray-300 rounded-full border-2 border-white group-hover:bg-blue-500 transition"></div>
                    <div class="bg-white border border-gray-200 rounded p-2 shadow-sm flex justify-between items-center">
                        <div>
                            <div class="text-xs font-bold text-gray-800">${seg.do}</div>
                            ${seg.przez ? `<div class="text-[10px] text-gray-400">przez ${seg.przez}</div>` : ''}
                        </div>
                        ${i === t.trasa.length - 1 ? 
                            `<button onclick="popSegment()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>` 
                            : ''}
                    </div>
                `;
                list.appendChild(item);
            });
            
            drawRoute();
        }

        function setRouteStart() {
            const val = document.getElementById('route-start-select').value;
            if(!val) return;
            trains[currentTrainIndex].temp_start = val;
            save(); renderRouteUI();
        }

        function addSegment() {
            const val = document.getElementById('next-segment-select').value;
            if(!val) return;
            trains[currentTrainIndex].trasa.push(JSON.parse(val));
            trains[currentTrainIndex].temp_start = null;
            save(); renderRouteUI();
        }

        function popSegment() {
            trains[currentTrainIndex].trasa.pop();
            if(trains[currentTrainIndex].trasa.length === 0) trains[currentTrainIndex].temp_start = null; // Full reset if empty
            save(); renderRouteUI();
        }
        
        function resetRoute() {
            if(confirm("Zresetować trasę?")) {
                trains[currentTrainIndex].trasa = [];
                trains[currentTrainIndex].temp_start = null;
                save(); renderRouteUI();
            }
        }

        // --- IO ---
        function loadSzlakiManual(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                szlakiDB = JSON.parse(e.target.result);
                updateStatus('szlaki', true, szlakiDB.length);
                if(currentTrainIndex>=0) { renderRouteUI(); drawRoute(); }
            };
            r.readAsText(f);
        }

        function loadTrainsManual(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                const loaded = JSON.parse(e.target.result);
                // Merge strategy: Append
                trains = loaded;
                save();
                updateStatus('pociagi', true, trains.length);
                renderTrainList();
            };
            r.readAsText(f);
        }

        function downloadPociagi() {
            const b = new Blob([JSON.stringify(trains, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'pociagi.json'; a.click();
        }

        function toggleJsonPreview() {
            const modal = document.getElementById('json-modal');
            const area = document.getElementById('json-output');
            if(modal.classList.contains('hidden')) {
                area.value = JSON.stringify(trains, null, 2);
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function save() {
            localStorage.setItem('trains_v6', JSON.stringify(trains));
        }
        
        function deleteCurrentTrain() {
            if(confirm("Usunąć?")) {
                trains.splice(currentTrainIndex, 1);
                currentTrainIndex = -1;
                document.getElementById('editor-panel').classList.add('hidden');
                document.getElementById('editor-empty').classList.remove('hidden');
                save(); renderTrainList();
            }
        }

        function hardReset() {
            if(confirm("Czy na pewno wyczyścić dane?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- UI UTILS ---
        function switchTab(name) {
            document.getElementById('tab-info').classList.add('hidden');
            document.getElementById('tab-route').classList.add('hidden');
            document.getElementById('tab-' + name).classList.remove('hidden');
            
            document.getElementById('tab-btn-info').classList.remove('border-blue-600', 'text-blue-600');
            document.getElementById('tab-btn-route').classList.remove('border-blue-600', 'text-blue-600');
            document.getElementById('tab-btn-info').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('tab-btn-route').classList.add('border-transparent', 'text-gray-500');
            
            document.getElementById('tab-btn-' + name).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById('tab-btn-' + name).classList.add('border-blue-600', 'text-blue-600');
            
            if(name === 'route') setTimeout(() => { map.invalidateSize(); drawRoute(); }, 100);
        }

        // Input Bindings
        ['inp-no','inp-name','inp-stock','inp-rel-from','inp-rel-to','cal-from','cal-to'].forEach(id => {
            document.getElementById(id).addEventListener('input', e => {
                if(currentTrainIndex<0) return;
                const t = trains[currentTrainIndex];
                if(id=='inp-no') t.numer = e.target.value;
                if(id=='inp-name') t.nazwa = e.target.value;
                if(id=='inp-stock') t.tabor = e.target.value;
                if(id=='inp-rel-from') t.relacja_od = e.target.value;
                if(id=='inp-rel-to') t.relacja_do = e.target.value;
                if(id=='cal-from') { t.valid_from = e.target.value; renderCalendar(); }
                if(id=='cal-to') { t.valid_to = e.target.value; renderCalendar(); }
                save();
                if(id=='inp-no' || id=='inp-name') renderTrainList();
            });
        });

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytor Bazy Szlak贸w (Master)</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script> 
    <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-W05T4L1HFD'); </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #app { display: flex; height: 100vh; }
        
        /* PANEL BOCZNY */
        #sidebar {
            width: 450px;
            background: #fff;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
        }

        .header {
            background: #2c3e50; color: white; padding: 15px;
        }
        .header h2 { margin: 0; font-size: 1.1rem; }
        .data-source { font-size: 0.75rem; color: #bbb; margin-top: 5px; }
        .source-tag { font-weight: bold; color: #4db6ac; }

        .list-controls { padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        #search-box { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #list-container { flex-grow: 1; overflow-y: auto; background: #f1f1f1; }
        
        .segment-item {
            background: white; border-bottom: 1px solid #e0e0e0; padding: 10px; cursor: pointer;
            display: flex; align-items: center; transition: background 0.2s;
        }
        .segment-item:hover { background: #e9ecef; }
        .segment-item.active { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        
        .status-dot {
            width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; flex-shrink: 0;
            background: #ccc; 
        }
        .status-dot.done { background: #28a745; }
        
        .seg-details { flex-grow: 1; }
        .seg-title { font-weight: bold; font-size: 0.9rem; display: block; }
        .seg-via { font-size: 0.75rem; color: #666; }

        /* PANEL EDYCJI */
        #edit-panel {
            padding: 15px; background: white; border-top: 2px solid #ddd;
            display: none; 
        }
        .panel-row { margin-bottom: 5px; }
        .panel-row label { font-size: 0.75rem; color: #555; display: block;}
        .panel-row input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; }

        .btn {
            border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px;
            font-size: 0.9rem; transition: 0.2s;
        }
        .btn-green { background: #28a745; color: white; } .btn-green:hover { background: #218838; }
        .btn-blue { background: #007bff; color: white; } .btn-blue:hover { background: #0056b3; }
        .btn-orange { background: #fd7e14; color: white; } .btn-orange:hover { background: #e36d0a; }

        #map { flex-grow: 1; height: 100%; }
        
        .footer {
            text-align: center; padding: 5px; font-size: 0.7rem; color: #aaa; background: #2c3e50; border-top: 1px solid #444;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div class="header">
            <h2>Baza Szlak贸w (101 odcink贸w)</h2>
            <div class="data-source">殴r贸do danych: <span id="source-display" class="source-tag">adowanie...</span></div>
            <div style="font-size: 0.8rem; margin-top:5px;">Postp geometrii: <span id="stats-counter">0/0</span></div>
        </div>

        <div class="list-controls">
            <button class="btn btn-blue" onclick="addNewSegment()" style="margin-bottom:10px;">+ Dodaj szlak</button>
            <input type="text" id="search-box" placeholder="Szukaj (np. Kalisz)..." onkeyup="renderList()">
        </div>

        <div id="list-container"></div>

        <div id="edit-panel">
            <div class="panel-row">
                <label>Pocztek:</label>
                <input type="text" id="edit-start" onchange="updateMeta()">
            </div>
            <div class="panel-row">
                <label>Koniec:</label>
                <input type="text" id="edit-end" onchange="updateMeta()">
            </div>
            <div class="panel-row">
                <label>Przez:</label>
                <input type="text" id="edit-via" onchange="updateMeta()">
            </div>
            
            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
            
            <button class="btn btn-orange" onclick="autoLocate()"> Znajd藕 stacje (Auto-Start)</button>
            <button class="btn btn-green" onclick="saveGeometry()"> ZAPISZ GEOMETRI</button>
            <button class="btn" style="background:#dc3545; color:white; margin-top:10px;" onclick="deleteSegment()">Usu szlak</button>
        </div>

        <div style="padding:10px; background:#f8f9fa; border-top:1px solid #ccc;">
            <button class="btn btn-blue" onclick="exportJSON()"> Eksportuj szlaki_master.json</button>
            <small style="display:block; text-align:center; color:#666; margin-top:5px;">Pobierz i nadpisz plik na serwerze</small>
        </div>

        <div class="footer">
            Admin Panel | Wsp贸autorzy: Gemini & Piotr M 
        </div>
    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
    // --- 1. DANE Z PLIKU CSV (101 pozycji) ---
    const initialData = [
        {id: 1, start: "贸d藕 Fabryczna", end: "贸d藕 Widzew", via: "-"},
        {id: 2, start: "贸d藕 Widzew", end: "贸d藕 Chojny", via: "贸d藕 Dbrowa"},
        {id: 3, start: "贸d藕 Widzew", end: "贸d藕 Chojny", via: "贸d藕 Olech贸w"},
        {id: 4, start: "贸d藕 Chojny", end: "贸d藕 Lublinek", via: "-"},
        {id: 5, start: "贸d藕 Chojny", end: "贸d藕 Kaliska", via: "-"},
        {id: 6, start: "贸d藕 Kaliska", end: "贸d藕 Lublinek", via: "-"},
        {id: 7, start: "贸d藕 Kaliska", end: "Zgierz", via: "贸d藕 呕abieniec"},
        {id: 8, start: "贸d藕 Widzew", end: "Zgierz", via: "贸d藕 Artur贸wek"},
        {id: 9, start: "Zgierz", end: "Kutno", via: "czyca"},
        {id: 10, start: "Zgierz", end: "owicz G贸wny", via: "Stryk贸w"},
        {id: 11, start: "owicz G贸wny", end: "Kutno", via: "-"},
        {id: 12, start: "贸d藕 Widzew", end: "Koluszki", via: "-"},
        {id: 13, start: "Koluszki", end: "Grodzisk Maz.", via: "Skierniewice"},
        {id: 14, start: "Koluszki", end: "owicz G贸wny", via: "Skierniewice Park, Bech贸w"},
        {id: 15, start: "owicz G贸wny", end: "W-wa Zachodnia", via: "Sochaczew, W-wa Wochy"},
        {id: 16, start: "owicz G贸wny", end: "Grodzisk Maz.", via: "Bech贸w, 呕yrard贸w"},
        {id: 17, start: "owicz G贸wny", end: "W-wa G贸wna Towarowa", via: "Sochaczew"},
        {id: 18, start: "Grodzisk Maz.", end: "W-wa Zachodnia", via: "W-wa Wochy"},
        {id: 19, start: "Grodzisk Maz.", end: "W-wa Gdaska", via: "W-wa Myn贸w"},
        {id: 20, start: "Grodzisk Maz.", end: "W-wa G贸wna Towarowa", via: "-"},
        {id: 21, start: "Grodzisk Maz.", end: "Idzikowice", via: "Szeligi"},
        {id: 22, start: "W-wa G贸wna Towarowa", end: "W-wa Gdaska", via: "W-wa Jelonki"},
        {id: 23, start: "W-wa G贸wna Towarowa", end: "W-wa Zachodnia", via: "W-wa Odolany"},
        {id: 24, start: "W-wa Zachodnia", end: "W-wa Wschodnia", via: "W-wa Centralna"},
        {id: 25, start: "W-wa Zachodnia", end: "W-wa Wschodnia", via: "W-wa r贸dmiecie"},
        {id: 26, start: "W-wa Zachodnia", end: "W-wa G贸wna.", via: "-"},
        {id: 27, start: "W-wa Wschodnia", end: "W-wa Groch贸w", via: "-"},
        {id: 28, start: "W-wa Gdaska", end: "W-wa Wschodnia", via: "W-wa ZOO"},
        {id: 29, start: "W-wa Gdaska", end: "W-wa Groch贸w", via: "W-wa ZOO"},
        {id: 30, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa Olszynka Grochowska, Otwock"},
        {id: 31, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa Wsch Towarowa, Otwock"},
        {id: 32, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa Rembert贸w, Grzebowilk"},
        {id: 33, start: "Pilawa", end: "Lublin G贸wny", via: "Dblin, Nacz贸w"},
        {id: 34, start: "W-wa Wschodnia", end: "Tuszcz", via: "W-wa Rembert贸w"},
        {id: 35, start: "Tuszcz", end: "Biaystok", via: "Makinia"},
        {id: 36, start: "W-wa Wschodnia", end: "Dziadowo", via: "Ciechan贸w"},
        {id: 37, start: "Dziadowo", end: "Iawa G贸wna", via: "-"},
        {id: 38, start: "Iawa G贸wna", end: "Tczew", via: "Prabuty, Malbork"},
        {id: 39, start: "Tczew", end: "Gdynia G贸wna", via: "Gdask G贸wny"},
        {id: 40, start: "Dziadowo", end: "Olsztyn G贸wny", via: "Nidzica"},
        {id: 41, start: "Iawa G贸wna", end: "Olsztyn G贸wny", via: "Ostr贸da"},
        {id: 42, start: "贸d藕 Lublinek", end: "Gajewniki", via: "Pabianice"},
        {id: 43, start: "Gajewniki", end: "Kalisz", via: "Sieradz"},
        {id: 44, start: "Gajewniki", end: "Koo", via: "Poddbice, Barogi"},
        {id: 45, start: "Gajewniki", end: "Inowrocaw Rbinek", via: "Poddbice, Piotrk贸w Kujawski"},
        {id: 46, start: "Kalisz", end: "Ostr贸w Wielkopolski", via: "-"},
        {id: 47, start: "Kalisz", end: "Jarocin", via: "Pleszew"},
        {id: 48, start: "Ostr贸w Wielkopolski", end: "Jarocin", via: "Pleszew"},
        {id: 49, start: "Jarocin", end: "Pozna G贸wny", via: "roda Wielkopolska"},
        {id: 50, start: "Jarocin", end: "Pozna G贸wny", via: "Wrzenia"},
        {id: 51, start: "Kutno", end: "Bydgoszcz G贸wna", via: "Toru G贸wny"},
        {id: 52, start: "Bydgoszcz G贸wna", end: "Tczew", via: "Laskowice Pomorskie"},
        {id: 53, start: "Kutno", end: "Pock Trzepowo", via: "Gostynin"},
        {id: 54, start: "Kutno", end: "Swarzdz", via: "-"},
        {id: 55, start: "Kutno", end: "Swarzdz", via: "Wrzenia"},
        {id: 56, start: "Swarzdz", end: "Pozna G贸wny", via: "Pozna Wsch贸d"},
        {id: 57, start: "Swarzdz", end: "Pozna G贸wny", via: "Pozna Franowo"},
        {id: 58, start: "Pozna G贸wny", end: "Pia G贸wna", via: "Oborniki Wielkopolskie, Chodzie偶"},
        {id: 59, start: "Pozna G贸wny", end: "Krzy偶", via: "Pozna Wola, Szamotuy"},
        {id: 60, start: "Krzy偶", end: "Szczecin Dbie", via: "Choszczno"},
        {id: 61, start: "Szczecin Dbie", end: "Szczecin G贸wny", via: "Dziewoklicz"},
        {id: 62, start: "Szczecin Dbie", end: "Szczecin G贸wny", via: "Szczecin Port Centr."},
        {id: 63, start: "Pozna G贸wny", end: "Zbszynek", via: "Opalenica, Nowy Tomyl"},
        {id: 64, start: "Zbszynek", end: "Zielona G贸ra G贸wna", via: "-"},
        {id: 65, start: "Zbszynek", end: "Rzepin", via: "wiebodzin"},
        {id: 66, start: "Zbszynek", end: "Gorz贸w Wielkopolski", via: "Midzyrzecz, Skwierzyna"},
        {id: 67, start: "Kutno", end: "Inowrocaw Rbinek", via: "Zamk贸w, Piotrk贸w Kujawski"},
        {id: 68, start: "Inowrocaw Rbinek", end: "Pozna G贸wny", via: "Gniezno, Kobylnica"},
        {id: 69, start: "Inowrocaw Rbinek", end: "Pozna G贸wny", via: "Gniezno, Wrzenia"},
        {id: 70, start: "Inowrocaw Rbinek", end: "Bydgoszcz G贸wna", via: "Zotniki Kujawskie, Brzoza Bydgoska"},
        {id: 71, start: "Inowrocaw Rbinek", end: "Bydgoszcz G贸wna", via: "Zotniki Kujawskie, Bydgoszcz Lena"},
        {id: 72, start: "Ostr贸w Wielkopolski", end: "Wrocaw G贸wny", via: "Twardog贸ra"},
        {id: 73, start: "Ostr贸w Wielkopolski", end: "Wrocaw G贸wny", via: "Krotoszyn, Milicz"},
        {id: 74, start: "贸d藕 Widzew", end: "Piotrk贸w Trybunalski", via: "Bzelin"},
        {id: 75, start: "Koluszki", end: "Piotrk贸w Trybunalski", via: "-"},
        {id: 76, start: "Piotrk贸w Trybunalski", end: "Czstochowa", via: "Radomsko, Wyczerpy"},
        {id: 77, start: "Czstochowa", end: "Lubliniec", via: "Herby Stare"},
        {id: 78, start: "Lubliniec", end: "Wrocaw G贸wny", via: "Opole, Brzeg"},
        {id: 79, start: "Czstochowa", end: "Zawiercie", via: "Poraj"},
        {id: 80, start: "Zawiercie", end: "Dorota", via: "Dbrowa G贸rnicza Huta Katowice"},
        {id: 81, start: "Zawiercie", end: "Dorota", via: "Przemiarki, Kozio"},
        {id: 82, start: "Dorota", end: "Jaworzno Szczakowa", via: "Sosnowiec Maczki"},
        {id: 83, start: "Dorota", end: "Katowice", via: "Sosnowiec Dad贸wka, Sosnowiec Poudniowy"},
        {id: 84, start: "Dorota", end: "Katowice", via: "Sosnowiec Maczki, Mysowice"},
        {id: 85, start: "Zawiercie", end: "Katowice", via: "Dbrowa G贸rnicza, Sosnowiec G贸wny"},
        {id: 86, start: "Katowice", end: "Jaworzno Szczakowa", via: "Mysowice"},
        {id: 87, start: "Jaworzno Szczakowa", end: "Krak贸w G贸wny", via: "Trzebinia, Krak贸w Mydlniki"},
        {id: 88, start: "Czstochowa", end: "Koniecpol", via: "Julianka"},
        {id: 89, start: "Koniecpol", end: "Koz贸w", via: "Starzyny"},
        {id: 90, start: "Koz贸w", end: "Krak贸w G贸wny", via: "Miech贸w, Zast贸w"},
        {id: 91, start: "Krak贸w G贸wny", end: "Krak贸w Pasz贸w", via: "-"},
        {id: 92, start: "Koniecpol", end: "Woszczowa P贸noc", via: "呕elisawice"},
        {id: 93, start: "贸d藕 Widzew", end: "Tomasz贸w Mazowiecki", via: "-"},
        {id: 94, start: "Koluszki", end: "Tomasz贸w Mazowiecki", via: "Sotwiny"},
        {id: 95, start: "Tomasz贸w Mazowiecki", end: "Idzikowice", via: "-"},
        {id: 96, start: "Tomasz贸w Mazowiecki", end: "Idzikowice", via: "Radzice"},
        {id: 97, start: "Idzikowice", end: "Woszczowa P贸noc", via: "Opoczno Poudnie"},
        {id: 98, start: "Woszczowa P贸noc", end: "Koz贸w", via: "Starzyny"},
        {id: 99, start: "Woszczowa P贸noc", end: "Zawiercie", via: "G贸ra Wodowska"},
        {id: 100, start: "Tomasz贸w Mazowiecki", end: "Radom G贸wny", via: "Drzewica, Przysucha"},
        {id: 101, start: "Radom G贸wny", end: "Lublin G贸wny", via: "Pionki, Nacz贸w"}
    ];

    let db = [];
    let selectedId = null;

    // --- MAPA ---
    var map = L.map('map').setView([52.0, 19.2], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);
    L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'OpenRailwayMap' }).addTo(map);

    var drawnItems = new L.FeatureGroup().addTo(map);
    var drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
            polygon: false, rectangle: false, circle: false, circlemarker: false, marker: false,
            polyline: { shapeOptions: { color: '#007bff', weight: 4 }, metric: true }
        }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
    });

    // --- INICJALIZACJA DANYCH ---
    async function initData() {
        const statusEl = document.getElementById('source-display');
        
        // 1. Pr贸ba pobrania z serwera (master file)
        try {
            // timestamp by omin cache
            const response = await fetch('szlaki_master.json?t=' + new Date().getTime());
            if (response.ok) {
                const json = await response.json();
                if(Array.isArray(json) && json.length > 0) {
                    db = json;
                    statusEl.innerText = "SERWER (szlaki_master.json)";
                    statusEl.style.color = "green";
                    renderList();
                    return;
                }
            }
        } catch(e) {
            console.log("Brak pliku na serwerze lub bd sieci.");
        }

        // 2. Fallback do LocalStorage
        const local = localStorage.getItem('szlakiDB');
        if (local) {
            db = JSON.parse(local);
            statusEl.innerText = "Lokalna pami przegldarki";
            statusEl.style.color = "orange";
        } else {
            // 3. Fallback do wbudowanej listy CSV
            db = JSON.parse(JSON.stringify(initialData));
            statusEl.innerText = "Domylna lista (101 pozycji)";
            statusEl.style.color = "blue";
        }
        renderList();
    }

    // --- LOGIKA UI ---
    function renderList() {
        const list = document.getElementById('list-container');
        const filter = document.getElementById('search-box').value.toLowerCase();
        list.innerHTML = '';
        
        let done = 0;
        db.forEach(item => {
            const hasGeo = item.geometry && item.geometry.coordinates && item.geometry.coordinates.length > 0;
            if(hasGeo) done++;

            const txt = `${item.id} ${item.start} ${item.end} ${item.via || ''}`.toLowerCase();
            if (txt.includes(filter)) {
                const div = document.createElement('div');
                div.className = `segment-item ${selectedId === item.id ? 'active' : ''}`;
                div.onclick = () => selectSegment(item.id);
                div.innerHTML = `
                    <div class="status-dot ${hasGeo ? 'done' : ''}"></div>
                    <div class="seg-details">
                        <span class="seg-title">${item.id}. ${item.start} - ${item.end}</span>
                        <span class="seg-via">${item.via !== '-' ? item.via : ''}</span>
                    </div>
                `;
                list.appendChild(div);
            }
        });
        document.getElementById('stats-counter').innerText = `${done} / ${db.length}`;
    }

    function selectSegment(id) {
        selectedId = id;
        renderList();
        const item = db.find(x => x.id === id);
        
        document.getElementById('edit-panel').style.display = 'block';
        document.getElementById('edit-start').value = item.start;
        document.getElementById('edit-end').value = item.end;
        document.getElementById('edit-via').value = item.via;

        drawnItems.clearLayers();
        if (item.geometry) {
            L.geoJSON(item.geometry, {
                onEachFeature: function(feature, layer) {
                    if(layer instanceof L.Polyline) {
                        const poly = L.polyline(layer.getLatLngs(), {color: '#007bff', weight: 4});
                        drawnItems.addLayer(poly);
                        map.fitBounds(poly.getBounds(), {padding:[50,50]});
                    }
                }
            });
        }
    }

    function updateMeta() {
        if(!selectedId) return;
        const item = db.find(x => x.id === selectedId);
        item.start = document.getElementById('edit-start').value;
        item.end = document.getElementById('edit-end').value;
        item.via = document.getElementById('edit-via').value;
        saveAll();
    }

    function saveGeometry() {
        if(!selectedId) return;
        const layers = drawnItems.getLayers();
        const item = db.find(x => x.id === selectedId);
        
        if(layers.length === 0) {
            item.geometry = null;
        } else {
            item.geometry = layers[0].toGeoJSON().geometry;
        }
        saveAll();
        alert("Geometria zapisana!");
    }

    function addNewSegment() {
        const maxId = db.reduce((max, item) => (item.id > max ? item.id : max), 0);
        const newId = maxId + 1;
        db.push({ id: newId, start: "Nowy", end: "Szlak", via: "-", geometry: null });
        saveAll();
        selectSegment(newId);
    }

    function deleteSegment() {
        if(!selectedId || !confirm("Usun szlak?")) return;
        db = db.filter(x => x.id !== selectedId);
        selectedId = null;
        document.getElementById('edit-panel').style.display = 'none';
        drawnItems.clearLayers();
        saveAll();
    }

    function saveAll() {
        localStorage.setItem('szlakiDB', JSON.stringify(db));
        renderList();
    }

    function exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "szlaki_master.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    async function autoLocate() {
        if(!selectedId) return;
        const item = db.find(x => x.id === selectedId);
        const qStart = `${item.start} station`;
        const qEnd = `${item.end} station`;

        if(confirm(`Szukam stacji:\n1. ${qStart}\n2. ${qEnd}`)) {
            try {
                const [s, e] = await Promise.all([fetchLoc(qStart), fetchLoc(qEnd)]);
                if(s && e) {
                    drawnItems.clearLayers();
                    const line = L.polyline([s, e], {color: '#007bff', weight: 4});
                    drawnItems.addLayer(line);
                    map.fitBounds(line.getBounds(), {padding:[50,50]});
                    alert("Znalazem! Dopasuj lini do tor贸w.");
                } else {
                    alert("Nie udao si znale藕 jednej ze stacji.");
                }
            } catch(err) { alert("Bd API."); }
        }
    }

    async function fetchLoc(q) {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
        const d = await r.json();
        return d.length ? [parseFloat(d[0].lat), parseFloat(d[0].lon)] : null;
    }

    // Fix ikon Draw
    const style = document.createElement('style');
    style.innerHTML = `.leaflet-draw-toolbar a { background-image: url('https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/images/spritesheet.png'); }`;
    document.head.appendChild(style);

    // Start
    initData();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytor Bazy Szlak√≥w Kolejowych</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W05T4L1HFD"></script> 
    <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-W05T4L1HFD'); </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #app { display: flex; height: 100vh; }
        
        /* PANEL BOCZNY */
        #sidebar {
            width: 420px;
            background: #fff;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
        }

        .header {
            background: #2c3e50; color: white; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h2 { margin: 0; font-size: 1.1rem; }
        .stats { font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; }

        /* LISTA */
        .list-controls { padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        #search-box { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #list-container { flex-grow: 1; overflow-y: auto; background: #f1f1f1; }
        
        .segment-item {
            background: white; border-bottom: 1px solid #e0e0e0; padding: 10px; cursor: pointer;
            display: flex; align-items: center; transition: background 0.2s;
        }
        .segment-item:hover { background: #e9ecef; }
        .segment-item.active { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        
        .status-dot {
            width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; flex-shrink: 0;
            background: #ccc; /* szary - brak */
        }
        .status-dot.done { background: #28a745; /* zielony - gotowe */ }
        
        .seg-details { flex-grow: 1; }
        .seg-title { font-weight: bold; font-size: 0.9rem; display: block; }
        .seg-via { font-size: 0.75rem; color: #666; }

        /* PANEL EDYCJI (na dole sidebaru) */
        #edit-panel {
            padding: 15px; background: white; border-top: 2px solid #ddd;
            display: none; /* Ukryte domy≈õlnie */
        }
        .panel-title { font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .btn {
            border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px;
            font-size: 0.9rem; transition: 0.2s;
        }
        .btn-green { background: #28a745; color: white; } .btn-green:hover { background: #218838; }
        .btn-blue { background: #007bff; color: white; } .btn-blue:hover { background: #0056b3; }
        .btn-orange { background: #fd7e14; color: white; } .btn-orange:hover { background: #e36d0a; }
        .btn-red { background: #dc3545; color: white; width: auto; font-size: 0.8rem; padding: 5px 10px; float: right;}

        /* MAPA */
        #map { flex-grow: 1; height: 100%; position: relative; }

        /* LEGENDA NA MAPIE */
        .map-legend {
            position: absolute; bottom: 30px; left: 10px; z-index: 1000;
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 4px; font-size: 0.8rem;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        .footer {
            text-align: center; padding: 5px; font-size: 0.7rem; color: #aaa; background: #2c3e50; border-top: 1px solid #444;
        }
        
        /* Inputy do edycji nazwy */
        .edit-input { width: 100%; padding: 5px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.85rem;}
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div class="header">
            <h2>Baza Szlak√≥w (Geometria)</h2>
            <div class="stats"><span id="done-count">0</span> / <span id="total-count">0</span></div>
        </div>

        <div class="list-controls">
            <button class="btn btn-blue" onclick="addNewSegment()" style="margin-bottom:10px;">+ Dodaj nowy szlak</button>
            <input type="text" id="search-box" placeholder="Szukaj (np. Koluszki)..." onkeyup="renderList()">
        </div>

        <div id="list-container">
            </div>

        <div id="edit-panel">
            <div class="panel-title">
                Edycja ID: <span id="current-id"></span>
                <button class="btn-red" onclick="deleteSegment()">Usu≈Ñ</button>
            </div>
            
            <label style="font-size:0.8rem;">SkƒÖd:</label>
            <input type="text" id="edit-start" class="edit-input" onchange="updateMeta()">
            <label style="font-size:0.8rem;">DokƒÖd:</label>
            <input type="text" id="edit-end" class="edit-input" onchange="updateMeta()">
            <label style="font-size:0.8rem;">Przez (opcjonalnie):</label>
            <input type="text" id="edit-via" class="edit-input" onchange="updateMeta()">

            <hr style="margin: 10px 0; border:0; border-top:1px solid #eee;">
            
            <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">Operacje na mapie:</div>
            <button class="btn btn-orange" onclick="autoLocate()">üìç Auto-Start (Znajd≈∫ stacje)</button>
            <button class="btn btn-green" onclick="saveGeometry()">üíæ ZAPISZ GEOMETRIƒò</button>
            <div style="margin-top:5px; font-size:0.75rem; text-align:center; color:#888;">
                U≈ºyj ikony o≈Ç√≥wka na mapie by poprawiƒá tory.
            </div>
        </div>

        <div style="padding:10px; background:#f8f9fa; border-top:1px solid #ccc;">
            <button class="btn btn-blue" onclick="exportJSON()">üì§ Eksportuj BAZƒò do JSON</button>
        </div>

        <div class="footer">
            Admin Panel | Wsp√≥≈Çautorzy: Gemini & Piotr M üöÇ
        </div>
    </div>

    <div id="map">
        <div class="map-legend">
            <strong>Legenda:</strong><br>
            ‚ûñ Czarne linie: Tory kolejowe<br>
            üîµ Niebieska linia: Tw√≥j szlak<br>
            U≈ºyj narzƒôdzi edycji (lewy g√≥rny r√≥g)<br>aby dopasowaƒá niebieskie do czarnego.
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
    // --- 1. DANE POCZƒÑTKOWE (99 pozycji + miejsce na kolejne) ---
    const initialData = [
        {id: 1, start: "≈Å√≥d≈∫ Fabryczna", end: "≈Å√≥d≈∫ Widzew", via: "-"},
        {id: 2, start: "≈Å√≥d≈∫ Widzew", end: "≈Å√≥d≈∫ Chojny", via: "≈Å√≥d≈∫ DƒÖbrowa"},
        {id: 3, start: "≈Å√≥d≈∫ Widzew", end: "≈Å√≥d≈∫ Chojny", via: "≈Å√≥d≈∫ Olech√≥w"},
        {id: 4, start: "≈Å√≥d≈∫ Chojny", end: "≈Å√≥d≈∫ Lublinek", via: "-"},
        {id: 5, start: "≈Å√≥d≈∫ Chojny", end: "≈Å√≥d≈∫ Kaliska", via: "-"},
        {id: 6, start: "≈Å√≥d≈∫ Kaliska", end: "≈Å√≥d≈∫ Lublinek", via: "-"},
        {id: 7, start: "≈Å√≥d≈∫ Kaliska", end: "Zgierz", via: "≈Å√≥d≈∫ ≈ªabieniec"},
        {id: 8, start: "≈Å√≥d≈∫ Widzew", end: "Zgierz", via: "≈Å√≥d≈∫ Artur√≥wek"},
        {id: 9, start: "Zgierz", end: "Kutno", via: "≈Åƒôczyca"},
        {id: 10, start: "Zgierz", end: "≈Åowicz G≈Ç√≥wny", via: "Stryk√≥w"},
        {id: 11, start: "≈Åowicz G≈Ç√≥wny", end: "Kutno", via: "-"},
        {id: 12, start: "≈Å√≥d≈∫ Widzew", end: "Koluszki", via: "-"},
        {id: 13, start: "Koluszki", end: "Grodzisk Maz.", via: "Skierniewice"},
        {id: 14, start: "Koluszki", end: "≈Åowicz G≈Ç√≥wny", via: "Skierniewice Park, Be≈Çch√≥w"},
        {id: 15, start: "≈Åowicz G≈Ç√≥wny", end: "W-wa Zachodnia", via: "Sochaczew, W-wa W≈Çochy"},
        {id: 16, start: "≈Åowicz G≈Ç√≥wny", end: "Grodzisk Maz.", via: "Be≈Çch√≥w, ≈ªyrard√≥w"},
        {id: 17, start: "≈Åowicz G≈Ç√≥wny", end: "W-wa G≈Ç√≥wna Towarowa", via: "Sochaczew"},
        {id: 18, start: "Grodzisk Maz.", end: "W-wa Zachodnia", via: "W-wa W≈Çochy"},
        {id: 19, start: "Grodzisk Maz.", end: "W-wa Gda≈Ñska", via: "W-wa M≈Çyn√≥w"},
        {id: 20, start: "Grodzisk Maz.", end: "W-wa G≈Ç√≥wna Towarowa", via: "-"},
        {id: 21, start: "Grodzisk Maz.", end: "Idzikowice", via: "Szeligi"},
        {id: 22, start: "W-wa G≈Ç√≥wna Towarowa", end: "W-wa Gda≈Ñska", via: "W-wa Jelonki"},
        {id: 23, start: "W-wa G≈Ç√≥wna Towarowa", end: "W-wa Zachodnia", via: "W-wa Odolany"},
        {id: 24, start: "W-wa Zachodnia", end: "W-wa Wschodnia", via: "W-wa Centralna"},
        {id: 25, start: "W-wa Zachodnia", end: "W-wa Wschodnia", via: "W-wa ≈ör√≥dmie≈õcie"},
        {id: 26, start: "W-wa Zachodnia", end: "W-wa G≈Ç√≥wna.", via: "-"},
        {id: 27, start: "W-wa Wschodnia", end: "W-wa Groch√≥w", via: "-"},
        {id: 28, start: "W-wa Gda≈Ñska", end: "W-wa Wschodnia", via: "W-wa ZOO"},
        {id: 29, start: "W-wa Gda≈Ñska", end: "W-wa Groch√≥w", via: "W-wa ZOO"},
        {id: 30, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa Olszynka Grochowska, Otwock"},
        {id: 31, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa Wsch Towarowa, Otwock"},
        {id: 32, start: "W-wa Wschodnia", end: "Pilawa", via: "W-wa Rembert√≥w, Grzebowilk"},
        {id: 33, start: "Pilawa", end: "Lublin G≈Ç√≥wny", via: "Dƒôblin, Na≈Çƒôcz√≥w"},
        {id: 34, start: "W-wa Wschodnia", end: "T≈Çuszcz", via: "W-wa Rembert√≥w"},
        {id: 35, start: "T≈Çuszcz", end: "Bia≈Çystok", via: "Ma≈Çkinia"},
        {id: 36, start: "W-wa Wschodnia", end: "Dzia≈Çdowo", via: "Ciechan√≥w"},
        {id: 37, start: "Dzia≈Çdowo", end: "I≈Çawa G≈Ç√≥wna", via: "-"},
        {id: 38, start: "I≈Çawa G≈Ç√≥wna", end: "Tczew", via: "Prabuty, Malbork"},
        {id: 39, start: "Tczew", end: "Gdynia G≈Ç√≥wna", via: "Gda≈Ñsk G≈Ç√≥wny"},
        {id: 40, start: "≈Å√≥d≈∫ Lublinek", end: "Gajewniki", via: "Pabianice"},
        {id: 41, start: "Gajewniki", end: "Kalisz", via: "Sieradz"},
        {id: 42, start: "Gajewniki", end: "Ko≈Ço", via: "Poddƒôbice, Bar≈Çogi"},
        {id: 43, start: "Gajewniki", end: "Inowroc≈Çaw RƒÖbinek", via: "Poddƒôbice, Piotrk√≥w Kujawski"},
        {id: 44, start: "Kalisz", end: "Ostr√≥w Wielkopolski", via: "-"},
        {id: 45, start: "Kalisz", end: "Jarocin", via: "Pleszew"},
        {id: 46, start: "Ostr√≥w Wielkopolski", end: "Jarocin", via: "Pleszew"},
        {id: 47, start: "Jarocin", end: "Pozna≈Ñ G≈Ç√≥wny", via: "≈öroda Wielkopolska"},
        {id: 48, start: "Jarocin", end: "Pozna≈Ñ G≈Ç√≥wny", via: "Wrze≈õnia"},
        {id: 49, start: "Kutno", end: "Bydgoszcz G≈Ç√≥wna", via: "Toru≈Ñ G≈Ç√≥wny"},
        {id: 50, start: "Bydgoszcz G≈Ç√≥wna", end: "Tczew", via: "Laskowice Pomorskie"},
        {id: 51, start: "Kutno", end: "P≈Çock Trzepowo", via: "Gostynin"},
        {id: 52, start: "Kutno", end: "Swarzƒôdz", via: "-"},
        {id: 53, start: "Kutno", end: "Swarzƒôdz", via: "Wrze≈õnia"},
        {id: 54, start: "Swarzƒôdz", end: "Pozna≈Ñ G≈Ç√≥wny", via: "Pozna≈Ñ Wsch√≥d"},
        {id: 55, start: "Swarzƒôdz", end: "Pozna≈Ñ G≈Ç√≥wny", via: "Pozna≈Ñ Franowo"},
        {id: 56, start: "Pozna≈Ñ G≈Ç√≥wny", end: "Pi≈Ça G≈Ç√≥wna", via: "Oborniki Wielkopolskie, Chodzie≈º"},
        {id: 57, start: "Pozna≈Ñ G≈Ç√≥wny", end: "Krzy≈º", via: "Pozna≈Ñ Wola, Szamotu≈Çy"},
        {id: 58, start: "Krzy≈º", end: "Szczecin DƒÖbie", via: "Choszczno"},
        {id: 59, start: "Szczecin DƒÖbie", end: "Szczecin G≈Ç√≥wny", via: "Dziewoklicz"},
        {id: 60, start: "Szczecin DƒÖbie", end: "Szczecin G≈Ç√≥wny", via: "Szczecin Port Centr."},
        {id: 61, start: "Pozna≈Ñ G≈Ç√≥wny", end: "ZbƒÖszynek", via: "Opalenica, Nowy Tomy≈õl"},
        {id: 62, start: "ZbƒÖszynek", end: "Zielona G√≥ra G≈Ç√≥wna", via: "-"},
        {id: 63, start: "ZbƒÖszynek", end: "Rzepin", via: "≈öwiebodzin"},
        {id: 64, start: "ZbƒÖszynek", end: "Gorz√≥w Wielkopolski", via: "Miƒôdzyrzecz, Skwierzyna"},
        {id: 65, start: "Kutno", end: "Inowroc≈Çaw RƒÖbinek", via: "Zamk√≥w, Piotrk√≥w Kujawski"},
        {id: 66, start: "Inowroc≈Çaw RƒÖbinek", end: "Pozna≈Ñ G≈Ç√≥wny", via: "Gniezno, Kobylnica"},
        {id: 67, start: "Inowroc≈Çaw RƒÖbinek", end: "Pozna≈Ñ G≈Ç√≥wny", via: "Gniezno, Wrze≈õnia"},
        {id: 68, start: "Inowroc≈Çaw RƒÖbinek", end: "Bydgoszcz G≈Ç√≥wna", via: "Z≈Çotniki Kujawskie, Brzoza Bydgoska"},
        {id: 69, start: "Inowroc≈Çaw RƒÖbinek", end: "Bydgoszcz G≈Ç√≥wna", via: "Z≈Çotniki Kujawskie, Bydgoszcz Le≈õna"},
        {id: 70, start: "Ostr√≥w Wielkopolski", end: "Wroc≈Çaw G≈Ç√≥wny", via: "Twardog√≥ra"},
        {id: 71, start: "Ostr√≥w Wielkopolski", end: "Wroc≈Çaw G≈Ç√≥wny", via: "Krotoszyn, Milicz"},
        {id: 72, start: "≈Å√≥d≈∫ Widzew", end: "Piotrk√≥w Trybunalski", via: "Bƒôzelin"},
        {id: 73, start: "Koluszki", end: "Piotrk√≥w Trybunalski", via: "-"},
        {id: 74, start: "Piotrk√≥w Trybunalski", end: "Czƒôstochowa", via: "Radomsko, Wyczerpy"},
        {id: 75, start: "Czƒôstochowa", end: "Lubliniec", via: "Herby Stare"},
        {id: 76, start: "Lubliniec", end: "Wroc≈Çaw G≈Ç√≥wny", via: "Opole, Brzeg"},
        {id: 77, start: "Czƒôstochowa", end: "Zawiercie", via: "Poraj"},
        {id: 78, start: "Zawiercie", end: "Dorota", via: "DƒÖbrowa G√≥rnicza Huta Katowice"},
        {id: 79, start: "Zawiercie", end: "Dorota", via: "Przemiarki, Kozio≈Ç"},
        {id: 80, start: "Dorota", end: "Jaworzno Szczakowa", via: "Sosnowiec Maczki"},
        {id: 81, start: "Dorota", end: "Katowice", via: "Sosnowiec Da≈Ñd√≥wka, Sosnowiec Po≈Çudniowy"},
        {id: 82, start: "Dorota", end: "Katowice", via: "Sosnowiec Maczki, Mys≈Çowice"},
        {id: 83, start: "Zawiercie", end: "Katowice", via: "DƒÖbrowa G√≥rnicza, Sosnowiec G≈Ç√≥wny"},
        {id: 84, start: "Katowice", end: "Jaworzno Szczakowa", via: "Mys≈Çowice"},
        {id: 85, start: "Jaworzno Szczakowa", end: "Krak√≥w G≈Ç√≥wny", via: "Trzebinia, Krak√≥w Mydlniki"},
        {id: 86, start: "Czƒôstochowa", end: "Koniecpol", via: "Julianka"},
        {id: 87, start: "Koniecpol", end: "Koz≈Ç√≥w", via: "Starzyny"},
        {id: 88, start: "Koz≈Ç√≥w", end: "Krak√≥w G≈Ç√≥wny", via: "Miech√≥w, Zast√≥w"},
        {id: 89, start: "Krak√≥w G≈Ç√≥wny", end: "Krak√≥w P≈Çasz√≥w", via: "-"},
        {id: 90, start: "Koniecpol", end: "W≈Çoszczowa P√≥≈Çnoc", via: "≈ªelis≈Çawice"},
        {id: 91, start: "≈Å√≥d≈∫ Widzew", end: "Tomasz√≥w Mazowiecki", via: "-"},
        {id: 92, start: "Koluszki", end: "Tomasz√≥w Mazowiecki", via: "S≈Çotwiny"},
        {id: 93, start: "Tomasz√≥w Mazowiecki", end: "Idzikowice", via: "-"},
        {id: 94, start: "Tomasz√≥w Mazowiecki", end: "Idzikowice", via: "Radzice"},
        {id: 95, start: "Idzikowice", end: "W≈Çoszczowa P√≥≈Çnoc", via: "Opoczno Po≈Çudnie"},
        {id: 96, start: "W≈Çoszczowa P√≥≈Çnoc", end: "Koz≈Ç√≥w", via: "Starzyny"},
        {id: 97, start: "W≈Çoszczowa P√≥≈Çnoc", end: "Zawiercie", via: "G√≥ra W≈Çodowska"},
        {id: 98, start: "Tomasz√≥w Mazowiecki", end: "Radom G≈Ç√≥wny", via: "Drzewica, Przysucha"},
        {id: 99, start: "Radom G≈Ç√≥wny", end: "Lublin G≈Ç√≥wny", via: "Pionki, Na≈Çƒôcz√≥w"}
    ];

    // --- ZARZƒÑDZANIE DANYMI ---
    // Pobieramy z localStorage albo ≈Çadujemy domy≈õlne 99
    let db = JSON.parse(localStorage.getItem('szlakiDB')) || JSON.parse(JSON.stringify(initialData));
    let selectedId = null;

    // --- MAPA ---
    var map = L.map('map').setView([52.0, 19.2], 6); // Centrum Polski

    // 1. Podk≈Çad OpenStreetMap (blady)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        opacity: 0.6
    }).addTo(map);

    // 2. Podk≈Çad OpenRailwayMap (Tory) - KLUCZOWE
    L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Map data: &copy; OSM | Style: &copy; OpenRailwayMap'
    }).addTo(map);

    // Warstwa edytowalna
    var drawnItems = new L.FeatureGroup().addTo(map);

    // Narzƒôdzia rysowania
    var drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems, remove: true },
        draw: {
            polygon: false, rectangle: false, circle: false, circlemarker: false, marker: false,
            polyline: {
                shapeOptions: { color: '#007bff', weight: 4 }, // Niebieski dla edycji
                metric: true
            }
        }
    });
    map.addControl(drawControl);

    // Obs≈Çuga zdarze≈Ñ rysowania
    map.on(L.Draw.Event.CREATED, function (e) {
        // Pozw√≥l tylko na jednƒÖ liniƒô na raz
        drawnItems.clearLayers(); 
        drawnItems.addLayer(e.layer);
    });

    // --- LOGIKA UI ---

    function renderList() {
        const list = document.getElementById('list-container');
        const filter = document.getElementById('search-box').value.toLowerCase();
        list.innerHTML = '';
        
        let done = 0;

        db.forEach(item => {
            const hasGeo = item.geometry && item.geometry.coordinates && item.geometry.coordinates.length > 0;
            if(hasGeo) done++;

            const txt = `${item.id} ${item.start} ${item.end} ${item.via || ''}`.toLowerCase();
            
            if (txt.includes(filter)) {
                const div = document.createElement('div');
                div.className = `segment-item ${selectedId === item.id ? 'active' : ''}`;
                div.onclick = () => selectSegment(item.id);

                div.innerHTML = `
                    <div class="status-dot ${hasGeo ? 'done' : ''}"></div>
                    <div class="seg-details">
                        <span class="seg-title">${item.id}. ${item.start} - ${item.end}</span>
                        <span class="seg-via">${item.via !== '-' ? item.via : ''}</span>
                    </div>
                `;
                list.appendChild(div);
            }
        });

        document.getElementById('done-count').innerText = done;
        document.getElementById('total-count').innerText = db.length;
    }

    function selectSegment(id) {
        selectedId = id;
        renderList(); // od≈õwie≈º style
        
        const item = db.find(x => x.id === id);
        
        // Poka≈º panel edycji
        document.getElementById('edit-panel').style.display = 'block';
        document.getElementById('current-id').innerText = item.id;
        document.getElementById('edit-start').value = item.start;
        document.getElementById('edit-end').value = item.end;
        document.getElementById('edit-via').value = item.via;

        // Wyczy≈õƒá mapƒô i za≈Çaduj geometriƒô je≈õli istnieje
        drawnItems.clearLayers();
        
        if (item.geometry) {
            const layer = L.geoJSON(item.geometry).getLayers()[0];
            // Musimy dodaƒá to jako warstwƒô edytowalnƒÖ, nie statyczny GeoJSON
            // Hack: tworzymy Polyline z punkt√≥w geojsona
            if(layer instanceof L.Polyline) {
                const latlngs = layer.getLatLngs();
                const polyline = L.polyline(latlngs, {color: '#007bff', weight: 4});
                drawnItems.addLayer(polyline);
                map.fitBounds(polyline.getBounds(), {padding: [50,50]});
            }
        }
    }

    function updateMeta() {
        if(!selectedId) return;
        const item = db.find(x => x.id === selectedId);
        item.start = document.getElementById('edit-start').value;
        item.end = document.getElementById('edit-end').value;
        item.via = document.getElementById('edit-via').value;
        saveToLocalStorage();
        renderList();
    }

    function addNewSegment() {
        // Znajd≈∫ najwy≈ºsze ID i dodaj 1
        const maxId = db.reduce((max, item) => (item.id > max ? item.id : max), 0);
        const newId = maxId + 1;
        
        const newItem = {
            id: newId,
            start: "Nowa Stacja A",
            end: "Nowa Stacja B",
            via: "-",
            geometry: null
        };
        
        db.push(newItem);
        saveToLocalStorage();
        renderList();
        
        // Automatycznie wybierz nowy i zescrolluj
        selectSegment(newId);
        // Scrollowanie do elementu (proste podej≈õcie)
        setTimeout(() => {
            const list = document.getElementById('list-container');
            list.scrollTop = list.scrollHeight;
        }, 100);
    }

    function deleteSegment() {
        if(!selectedId || !confirm("Czy na pewno usunƒÖƒá ten szlak?")) return;
        db = db.filter(x => x.id !== selectedId);
        selectedId = null;
        document.getElementById('edit-panel').style.display = 'none';
        drawnItems.clearLayers();
        saveToLocalStorage();
        renderList();
    }

    function saveGeometry() {
        if(!selectedId) return;
        const layers = drawnItems.getLayers();
        
        if(layers.length === 0) {
            // Je≈õli puste, to znaczy ≈ºe usuwamy geometriƒô
            const item = db.find(x => x.id === selectedId);
            item.geometry = null;
        } else {
            // Zapisujemy pierwszƒÖ warstwƒô
            const geoJSON = layers[0].toGeoJSON();
            const item = db.find(x => x.id === selectedId);
            item.geometry = geoJSON.geometry;
        }
        
        saveToLocalStorage();
        renderList();
        alert("Zapisano geometriƒô szlaku!");
    }

    function saveToLocalStorage() {
        localStorage.setItem('szlakiDB', JSON.stringify(db));
    }

    function exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "szlaki_master.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    // --- AUTOMATYCZNE WYSZUKIWANIE (Nominatim) ---
    async function autoLocate() {
        if(!selectedId) return;
        const item = db.find(x => x.id === selectedId);
        
        const qStart = `${item.start} station`;
        const qEnd = `${item.end} station`;
        
        if(confirm(`Spr√≥bujƒô znale≈∫ƒá wsp√≥≈Çrzƒôdne dla:\n1. ${qStart}\n2. ${qEnd}\n\nTo utworzy liniƒô prostƒÖ, kt√≥rƒÖ musisz dopasowaƒá do tor√≥w.`)) {
            try {
                const [startLoc, endLoc] = await Promise.all([
                    fetchCoords(qStart),
                    fetchCoords(qEnd)
                ]);
                
                if(startLoc && endLoc) {
                    drawnItems.clearLayers();
                    const line = L.polyline([startLoc, endLoc], {color: '#007bff', weight: 4});
                    drawnItems.addLayer(line);
                    map.fitBounds(line.getBounds(), {padding: [50,50]});
                    alert("Znaleziono! Teraz u≈ºyj edycji (ikona o≈Ç√≥wka i kwadratu), aby przesunƒÖƒá punkty na tory.");
                } else {
                    alert("Nie uda≈Ço siƒô znale≈∫ƒá jednej ze stacji. Narysuj liniƒô rƒôcznie.");
                }
            } catch(e) {
                alert("B≈ÇƒÖd po≈ÇƒÖczenia z mapƒÖ.");
            }
        }
    }

    async function fetchCoords(query) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
        const res = await fetch(url);
        const data = await res.json();
        return data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
    }

    // Fix na brakujƒÖce ikonki w Leaflet Draw
    let style = document.createElement('style');
    style.innerHTML = `
        .leaflet-draw-toolbar a { background-image: url('https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/images/spritesheet.png'); }
        .leaflet-retina .leaflet-draw-toolbar a { background-image: url('https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/images/spritesheet-2x.png'); }
    `;
    document.head.appendChild(style);

    // Start
    renderList();

</script>

</body>
</html>